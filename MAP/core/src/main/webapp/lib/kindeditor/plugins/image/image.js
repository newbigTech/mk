KindEditor.plugin("image",function(f){var i=this,a="image",g=f.undef(i.allowImageUpload,true),h=f.undef(i.allowFileManager,false),d=f.undef(i.uploadJson,i.basePath+"php/upload_json.php"),e=i.basePath+"plugins/image/images/",b=f.undef(i.fileServer,""),c=i.lang(a+".");i.plugin.imageDialog=function(m){var D=f.undef(m.imageUrl,"http://"),o=f.undef(m.imageWidth,""),F=f.undef(m.imageHeight,""),y=f.undef(m.imageTitle,""),q=f.undef(m.imageAlign,""),t=m.clickFn;var p=['<div style="padding:10px 20px;">','<div class="tabs"></div>','<div class="ke-dialog-row">','<div class="tab1" style="display:none;">','<label for="keUrl" style="width:60px;">'+c.remoteUrl+"</label>",'<input type="text" id="keUrl" class="ke-input-text" name="url" value="" style="width:200px;" /> &nbsp;','<span class="ke-button-common ke-button-outer">','<input type="button" class="ke-button-common ke-button" name="viewServer" value="'+c.viewServer+'" />',"</span>","</div>",'<div class="tab2" style="display:none;">','<label style="width:60px;">'+c.localUrl+"</label>",'<input type="text" name="localUrl" class="ke-input-text" tabindex="-1" style="width:200px;" readonly="true" /> &nbsp;','<input type="button" class="ke-upload-button" value="'+c.viewServer+'" />',"</div>","</div>",'<div class="ke-dialog-row">','<label for="keWidth" style="width:60px;">'+c.size+"</label>",c.width+' <input type="text" id="keWidth" class="ke-input-text ke-input-number" name="width" value="" maxlength="4" /> ',c.height+' <input type="text" class="ke-input-text ke-input-number" name="height" value="" maxlength="4" /> ','<img class="ke-refresh-btn" src="'+e+'refresh.gif" width="16" height="16" alt="" style="cursor:pointer;" />',"</div>",'<div class="ke-dialog-row">','<label style="width:60px;">'+c.align+"</label>",'<input type="radio" name="align" class="ke-inline-block" value="" checked="checked" /> <img name="defaultImg" src="'+e+'align_top.gif" width="23" height="25" alt="" />',' <input type="radio" name="align" class="ke-inline-block" value="left" /> <img name="leftImg" src="'+e+'align_left.gif" width="23" height="25" alt="" />',' <input type="radio" name="align" class="ke-inline-block" value="right" /> <img name="rightImg" src="'+e+'align_right.gif" width="23" height="25" alt="" />',"</div>",'<div class="ke-dialog-row">','<label for="keTitle" style="width:60px;">'+c.imgTitle+"</label>",'<input type="text" id="keTitle" class="ke-input-text" name="title" value="" style="width:200px;" /></div>',"</div>","</div>"].join("");var k=g?450:400;dialogHeight=g?300:250;var z=i.createDialog({name:a,width:k,height:dialogHeight,title:i.lang(a),body:p,yesBtn:{name:i.lang("yes"),click:function(K){if(C&&C.selectedIndex===1){v.submit();n.val("");return}var I=f.trim(r.val()),J=l.val(),H=G.val(),L=A.val(),M="";j.each(function(){if(this.checked){M=this.value;return false}});if(I=="http://"||f.invalidUrl(I)){alert(i.lang("invalidUrl"));r[0].focus();return}if(!/^\d*$/.test(J)){alert(i.lang("invalidWidth"));l[0].focus();return}if(!/^\d*$/.test(H)){alert(i.lang("invalidHeight"));G[0].focus();return}t.call(i,I,L,J,H,0,M)}},beforeRemove:function(){u.remove();l.remove();G.remove();x.remove();v.remove()}}),s=z.div;var C;if(g){C=f.tabs({src:f(".tabs",s),afterSelect:function(H){}});C.add({title:c.remoteImage,panel:f(".tab1",s)});C.add({title:c.localImage,panel:f(".tab2",s)});C.select(0)}else{f(".tab1",s).show()}var r=f('[name="url"]',s),n=f('[name="localUrl"]',s),u=f('[name="viewServer"]',s),l=f('[name="width"]',s),G=f('[name="height"]',s),x=f(".ke-refresh-btn",s),A=f('[name="title"]',s),j=f('[name="align"]');var v=f.uploadbutton({button:f(".ke-upload-button",s)[0],fieldName:"files",url:f.addParam(d,"dir=image"),afterUpload:function(K){if(K.success){var J=l.val(),H=G.val(),L=A.val(),M="";j.each(function(){if(this.checked){M=this.value;return false}});var I=b+K.file.filePath;t.call(i,I,L,J,H,0,M);if(i.afterUpload){i.afterUpload.call(i,I)}}else{alert(K.message)}}});v.fileBox.change(function(H){n.val(v.fileBox.val())});if(h){u.click(function(H){i.loadPlugin("filemanager",function(){i.plugin.filemanagerDialog({viewType:"VIEW",dirName:"image",clickFn:function(I,J){if(i.dialogs.length>1){f('[name="url"]',s).val(I);i.hideDialog()}}})})})}else{u.hide()}var E=0,w=0;function B(I,H){l.val(I);G.val(H);E=I;w=H}x.click(function(I){var H=f('<img src="'+r.val()+'" />',i.edit.doc).css({position:"absolute",visibility:"hidden",top:0,left:"1000px"});f(i.edit.doc.body).append(H);B(H.width(),H.height());H.remove()});l.change(function(H){if(E>0){G.val(Math.round(w/E*parseInt(this.value,10)))}});G.change(function(H){if(w>0){l.val(Math.round(E/w*parseInt(this.value,10)))}});r.val(m.imageUrl);B(m.imageWidth,m.imageHeight);A.val(m.imageTitle);j.each(function(){if(this.value===m.imageAlign){this.checked=true;return false}});r[0].focus();r[0].select();return z};i.plugin.image={edit:function(){var j=i.plugin.getSelectedImage();i.plugin.imageDialog({imageUrl:j?j.attr("data-ke-src"):"http://",imageWidth:j?j.width():"",imageHeight:j?j.height():"",imageTitle:j?j.attr("title"):"",imageAlign:j?j.attr("align"):"",clickFn:function(m,o,n,k,l,p){i.exec("insertimage",m,o,n,k,l,p).hideDialog().focus()}})},"delete":function(){i.plugin.getSelectedImage().remove()}};i.clickToolbar(a,i.plugin.image.edit)});