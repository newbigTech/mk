<#--
 * description: 员工管理
 * version: 2.0
 * author:yuliao.chen@hand-china.com
 *
 -->
<#include "../include/header.html">
<body>
<script src="${base.contextPath}/common/code?employeeStatusData=HR.EMPLOYEE_STATUS" type="text/javascript"></script>
<script src="${base.contextPath}/common/code?employeeGenderData=HR.EMPLOYEE_GENDER" type="text/javascript"></script>
<script src="${base.contextPath}/common/code?employeeCertificateTypeData=HR.CERTIFICATE_TYPE" type="text/javascript"></script>
<script type="text/javascript">

    var viewModel = kendo.observable({
        model: {},
        createFunction: function () {
            editData();
        },
        saveFunction: function () {
            $('#grid').data('kendoGrid').saveChanges();
        },
        queryFunction: function (e) {
            $('#grid').data('kendoGrid').dataSource.page(1);
        }
    });

    var userViewModel = kendo.observable({
        model: {},
        role: {},
        saveFunction: function () {
            var selection = $("#userGrid").data("kendoGrid").dataSource.data();
            var users = [];

            for (var i = 0; i < selection.length; i++) {
                           var userRole = {};
                            userRole["roleId"] = selection[i].roleId;
                            users[i] = userRole;
            }
            userViewModel.role.set("userRole",users);
            userViewModel.model.set("status", userStatus.value());
            var param = {};
            param["user"] = userViewModel.model;
            param["roles"] = userViewModel.role.get("userRole");
            var userId =  userViewModel.model.get("userId");
           if(userId!=null && userId!=undefined){
               $.ajax({
                   type: "post",
                   url: "${base.contextPath}/hr/employee/update_user",
                   data: kendo.stringify(param),
                   dataType: "json",
                   contentType: 'application/json',
                   success: function (data) {
                       if (data["success"] == true) {
                           kendo.ui.showInfoDialog({
                               message: $l('保存成功')
                           });
                           $("#createUserWin").data("kendoWindow").close();
                       } else {
                           kendo.ui.showInfoDialog({
                               message: $l('创建失败')
                           });
                           $("#createUserWin").data("kendoWindow").close();
                       }
                   }
               });
           }else{
              $.ajax({
                   type: "post",
                   url: "${base.contextPath}/hr/employee/create_user",
                   data: kendo.stringify(param),
                   dataType: "json",
                   contentType: 'application/json',
                   success: function (data) {
                       if (data["success"] == true) {
                           kendo.ui.showInfoDialog({
                               message: $l('保存成功')
                           });
                           $("#createUserWin").data("kendoWindow").close();
                       } else {
                           kendo.ui.showInfoDialog({
                               message: $l('创建失败')
                           });
                           $("#createUserWin").data("kendoWindow").close();
                       }
                   }
               });
           }


            onClose();
        }
    });

    var roleViewModel = kendo.observable({
        model: {},
        queryResource: function () {
            $('#chooseGrid').data('kendoGrid').dataSource.page(1);
        }
    });

    function deleteData() {
        var checked = grid.selectedDataItems();
        if (grid.selectedDataItems().length) {
  kendo.ui.showConfirmDialog({
                title: $l('hap.tip.info'),
                message: $l('hap.tip.delete_confirm')
            }).done(function (event) {
                if (event.button == 'OK') {
                    $.each(checked, function (i, v) {
                        grid.dataSource.remove(v)
                    })
                    grid.dataSource.sync();
                }
            })
        }
    }

</script>


<!-- 自定义的 编辑/新建 弹框 使用该 window  -->
<div id="select-position"></div>
<div id="dialog"></div>
<div id="assign-dialog"></div>
<div id="page-content">
    <div class="pull-left" id="toolbar-btn" style="padding-bottom:10px;">
        <span class="btn btn-primary k-grid-add" style="float:left;margin-right:5px;"
              data-bind="click:createFunction"><i class="fa fa-plus-square" style="margin-right:3px;"></i><@spring.message "hap.new"/></span>
        <span class="btn btn-success k-grid-save-changes" style="float:left;margin-right:5px;"
              data-bind="click:saveFunction"><i class="fa fa-save" style="margin-right:3px;"></i><@spring.message "hap.save"/></span>
        <span class="btn btn-success" style="float:left;margin-right:5px;"
              onclick="createNewUser()"><i class="fa fa-user-plus" style="margin-right:3px;"></i><@spring.message "employee.createnewuser"/></span>
        <span onclick="deleteData()" class="btn btn-danger" style="float:left;margin-right:5px;"><i class="fa fa-trash-o" style="margin-right:3px;"></i><@spring.message "hap.delete"/></span>
        <span onclick="importData()" class="btn btn-info" style="float:left;margin-right:5px;"><@spring.message "hmall.import"/></span>
        <!--<span onclick="exportData()"  class="btn btn-info" style="float:left;"><@spring.message "hmall.export"/></span>-->
    </div>

    <div class="pull-right" id="query-form" style="padding-bottom:10px;">
        <input data-role="maskedtextbox" placeholder='<@spring.message "employee.employeeCode"/>' type="text"
               style="float:left;width:150px;margin-right:5px;" data-bind="value:model.employeeCode" class="k-textbox">
        <input data-role="maskedtextbox" placeholder='<@spring.message "employee.name"/>' type="text"
               style="width: 150px;float:left;margin-right:5px;" data-bind="value:model.name" class="k-textbox">
        <span class="btn btn-primary" style="float:left;width:70px" data-bind="click:queryFunction"
              type="submit"><i class="fa fa-search" style="margin-right:3px;"></i><@spring.message "hap.query"/></span>
        <div style="clear:both"></div>
    </div>
    <div style="clear:both">
        <div id="grid"></div>
    </div>
</div>

<div id="open_window_Upload">
    <div class="panel" style="padding:0px;">
        <form class="form-horizontal">
            <div class="panel-body">
                <div class="row">
                    <input type="file" name="file" id="importExcelFile" accept="xls*">
                </div>
            </div>
            <div class="panel-body">
                <div class="row">
                    <span id="errorMessage"></span>
                </div>
            </div>
            <div class="panel-footer text-right">
                <a class="btn btn-success" id="download" onclick="downloadExcelModel()" type="submit">下载模板</a>
            </div>
        </form>
    </div>
</div>

<div id="createUserWin" style="display: none">
    <div id="page-content1" >
        <form class="form-horizontal" >
            <div class="col-sm-5" style="margin-top: 5px">
                <div class="form-group">
                    <label class="col-sm-3  control-label"
                           style="text-align: right"><@spring.message "user.username"/></label>
                    <div class="col-sm-7">
                        <input id="userName" name="userName"
                               validationMessage="该字段不能为空" type="text"
                               data-bind="value:model.userName" class="k-textbox"
                               style="width: 100%;">
                        <script>kendo.bind($('#userName'), userViewModel);</script>
                    </div>
                </div>
            </div>

            <div class="col-xs-5" style="margin-top: 5px">
                <div class="form-group">
                    <label class="col-xs-3  control-label"
                           style="text-align: right"><@spring.message "user.status"/></label>

                    <div class="col-xs-7">
                        <input id="status" name="status"
                               data-bind="value:model.status"
                               style="width: 100%;">
                        <script>kendo.bind($('#status'), userViewModel);</script>
                    </div>
                </div>
            </div>

           <div class="col-sm-5" style="margin-top: 5px">
               <div class="form-group">
                   <label class="col-sm-3  control-label"
                          style="text-align: right"><@spring.message "user.email"/></label>

                   <div class="col-sm-7">
                       <input id="email" name="email" required
                              validationMessage="该字段不能为空" type="text"
                              data-bind="value:model.email" class="k-textbox"
                              style="width: 100%;">
                       <script>kendo.bind($('#email'), userViewModel);</script>
                   </div>
               </div>
            </div>

            <div class="col-xs-5" style="margin-top: 5px">
                <div class="form-group">
                    <label class="col-xs-3  control-label"
                           style="text-align: right"><@spring.message "user.phone"/></label>

                    <div class="col-xs-7">
                        <input id="phone" name="phone" required
                               validationMessage="该字段不能为空" type="text"
                               data-bind="value:model.phone" class="k-textbox"
                               style="width: 100%;">
                        <script>kendo.bind($('#phone'), userViewModel);</script>
                    </div>
                </div>
            </div>

            <div class="col-xs-5" style="margin-top: 5px">
                <div class="form-group">
                    <label class="col-sm-3 control-label"><@spring.message "user.startActiveDate"/></label>
                    <div class="col-sm-7">
                        <input id="startActiveDate" name="startActiveDate"
                               data-bind="value:model.startActiveDate"  style="width: 100%"/>
                    </div>
                    <script>
                        kendo.bind($('#startActiveDate'), userViewModel);
                    </script>
                </div>
            </div>

            <div class="col-xs-5" style="margin-top: 5px">
                <div class="form-group">
                    <label class="col-sm-3 control-label"><@spring.message "user.endActiveDate"/></label>
                    <div class="col-sm-7">
                        <input id="endActiveDate" name="endActiveDate"
                               data-bind="value:model.endActiveDate"  style="width: 100%"/>
                    </div>
                    <script>
                        kendo.bind($('#endActiveDate'), userViewModel);
                    </script>
                </div>
            </div>

        </form>
    </div>

    <div class="pull-left" id="toolbar-btn1" style="padding-bottom:10px;">
                <span class="btn btn-success" style="float:left;margin-right:5px;"
                      onclick="openChooseRoleWin()"><@spring.message "user.allocationrole"/></span>
            </div>

    <div style="clear:both;">
        <div id="userGrid" style="clear: both"></div>
    </div>

    <div class="col-xs-10" style="margin-top: 20px">
        <div class="form-group">
            <div class="col-xs-5" style="float:right">
                        <span id="saveForm" class="btn btn-success k-grid-save-changes"
                              style="float:center;margin-right:5px;"
                              data-bind="click:saveFunction"><@spring.message "hap.save"/></span>
                <script>kendo.bind($('#saveForm'), userViewModel);</script>
            </div>
        </div>
    </div>
</div>

<div id="chooseRole">
    <div class="pull-left" id="toolbar-btn2" style="padding-bottom:10px;">
        <span onclick="saveRole()" class="btn btn-primary k-grid-add" style="float:left;margin-right:5px;">保存</span>
    </div>

    <div class="pull-right" id="query-form-role" style="padding-bottom:10px;">
        <input data-role="maskedtextbox" placeholder="<@spring.message "role.rolecode"/>" type="text" class="k-textbox"
               type="text" style="float:left;width:150px;margin-right:5px;"
               data-bind="value:model.roleCode"/>
        <input data-role="maskedtextbox" placeholder="<@spring.message "role.rolename"/>" type="text" class="k-textbox"
               type="text" style="float:left;width:150px;margin-right:5px;"
               data-bind="value:model.roleName"/>
        <span class="btn btn-primary" data-bind="click:queryResource"
              type="submit"><@spring.message "hap.query"/></span>
    </div>
    <script>kendo.bind($('#query-form-role'), roleViewModel);</script>

    <div style="clear:both;">
        <div id="chooseGrid" style="clear: both"></div>
    </div>
</div>

<script type="text/javascript">
    var BaseUrl = _basePath;
    kendo.bind($('#page-content'), viewModel);

    $("#startActiveDate").kendoDatePicker();
    $("#endActiveDate").kendoDatePicker();

    $('#query-form input').keydown(function (e) {
        if (e.keyCode == 13) {
            e.target.blur();
            viewModel.queryFunction(e);
        }
    });

    var crudServiceBaseUrl = '${base.contextPath}',
            dataSource = new kendo.data.DataSource({
                transport: {
                    read: {
                        url: crudServiceBaseUrl + "/hr/employee/query",
                        type: "POST",
                        dataType: "json"
                    },
                    create: {
                        url: crudServiceBaseUrl + "/hr/employee/submit",
                        contentType: "application/json",
                        type: "POST"
                    },
                    update: {
                        url: crudServiceBaseUrl + "/hr/employee/submit",
                        contentType: "application/json",
                        type: "POST"
                    },
                    destroy: {
                        url: crudServiceBaseUrl + "/hr/employee/submit",
                        contentType: "application/json",
                        type: "POST"
                    },
                    parameterMap: function (options, type) {
                        if (type !== "read" && options.models) {
                            var datas = Hap.prepareSubmitParameter(options, type);
                            return kendo.stringify(datas);
                        } else if (type === "read") {
                            return Hap.prepareQueryParameter(viewModel.model.toJSON(), options);
                        }
                    }
                },
                batch: true,
                serverPaging: true,
                serverSorting: true,
                pageSize: 20,
                schema: {
                    data: 'rows',
                    total: 'total',
                    model: {
                        id: "employeeId",
                        fields: {
                            enabledFlag: {defaultValue: 'Y', type: 'boolean', checkedValue: 'Y', uncheckedValue: 'N'},
                            employeeCode: {type: "string"},
                            name: {type: "string"},
                            bornDate: {type: "date"},
                            email: {type: "email"},
                            mobil: {type: "string"},
                            joinDate: {type: "date"},
                            effectiveStartDate: {type: "date"},
                            effectiveEndDate: {type: "date"}
                        }
                    }
                }

            });

    //导入的弹框
    var open_window_Upload = $("#open_window_Upload");
    open_window_Upload.kendoWindow({
        position: {
            top: "20%",
            left: "30%"
        },
        width: "400px",
        title: "导入",

        actions: [
            "Minimize",
            "Maximize",
            "Close"
        ],
        visible: false          //设置窗口不可见
    });

    //点击导入按钮弹出导入div
    function importData() {
        open_window_Upload.data("kendoWindow").open();
    }

    //下载员工列表excel模板
    function downloadExcelModel() {
        var form = $("<form>");   //定义一个form表单
        form.attr('style', 'display:none');   //在form表单中添加查询参数
        form.attr('target', '');
        form.attr('method', 'GET');
        form.attr('action', BaseUrl + "/hmall/hr/employee/downloadExcelModel");
        $('body').append(form);  //将表单放置在web中
        form.submit();
    }

    //上传员工列表excel
    $('#importExcelFile').kendoUpload({
        async: {
            saveUrl: BaseUrl + "/hmall/hr/employee/importExcel?${_csrf.parameterName}=${_csrf.token}",
            autoUpload: false
        },
        multiple: false,
        localization: {
            select: "请选择文件",
            remove: "取消"
        },
        error: function (e) {
            kendo.ui.showInfoDialog({
                title: '提示信息',
                message: 'excel导入失败!'
            });
        },
        success: function (e) {
            if (e.response.success) {
                kendo.ui.showInfoDialog({
                    title: '提示信息',
                    message: 'excel导入成功'
                }).done(function (event) {
                    if (event.button == 'OK') {
                        var upload = $("#importExcelFile").data("kendoUpload");
                        upload.destroy();
                        $("#open_window_Upload").data("kendoWindow").close();
                        $('#grid').data('kendoGrid').dataSource.page(1);

                    }
                })
            } else {
                kendo.ui.showErrorDialog({
                    title: '提示信息',
                    message: '导入失败!<br/>'
                }).done(function (event) {
                    $("#errorMessage").html('<h5>失败信息:</h5><br/>' + e.response.message)
                });
            }
        }
    });

    //新建时调用的界面
    window.editData = function () {
        var url = 'employee_edit.html';
        var dialog = $("#dialog").kendoWindow({
            actions: ["Close"],
            width: 900,
            height: 400,
            title: '<@spring.message "hap.edit"/>',
            content: url,
            iframe: true,
            visible: false,
            resizable: false,
            modal: true,
            close: function () {
                //window 关闭  刷新 本页面的  grid
                $('#grid').data('kendoGrid').dataSource.page(1);
            }
        }).data("kendoWindow");
        dialog.center().open();
    };


    //岗位分配弹窗
    assignPosition = function (employeeId) {
        var assignDialog = $("#assign-dialog").kendoWindow({
            actions: ["Close"],
            width: 500,
            height: 400,
            title: '<@spring.message "employee.positionallocation"/>',
            visible: false,
            iframe: true,
            modal: true,
            resizable: false,
            content: 'employee_assign.html?employeeId=' + employeeId,
            close: function (e) {
                $("#grid").data("kendoGrid").dataSource.page(1);
            }
        }).data("kendoWindow");
        assignDialog.center().open();
    };


    var grid = $("#grid").kendoGrid({
        dataSource: dataSource,
        navigatable: false,
        dataBound: function(){
            if(parent.autoResizeIframe){
                parent.autoResizeIframe('${RequestParameters.functionCode!}')
            }
        },
        resizable: true,
        scrollable: true,
        selectable: "multiple,rowbox",
        pageable: {
            pageSizes: [5, 10, 20, 50],
            refresh: true,
            buttonCount: 5
        },
        sortable: true,
        columns: [{
                headerAttributes: {
                   "class": "table-header-cell",
                   style: "text-align: center"
                },
                attributes: {style: "text-align:center"},
                title:'<@spring.message "hap.edit"/>',
                command : [{
                    name:'edit',
                    template : '<a href="javascript:void(0)" class="k-grid-edit"><@spring.message "hap.edit"/></a>',
                    click: function(e){
                        var data = this.dataItem($(e.target).closest("tr"));
                        var dialog = $("#dialog").kendoWindow({
                            actions: ["Close"],
                            width: 900,
                            height: 410,
                            title: '<@spring.message "hap.edit"/>',
                            visible: false,
                            iframe: true,
                            resizable:false,
                            modal: true,
                            content: 'employee_edit.html?employeeId=' + data.employeeId,
                            close: function (e) {
                                $("#grid").data("kendoGrid").dataSource.page(1);
                            }
                        }).data("kendoWindow");
                        dialog.center().open();
                    }
                }],
                width : 80
            },
            {	//岗位分配编辑
                title: '<@spring.message "employee.positionallocation"/>',
                width: 80,
                template: function (rowdata) {
                    if (!!rowdata.employeeId) {
                        return '<a href="javascript:void(0);" onclick="assignPosition(' + rowdata.employeeId + ')"><@spring.message "employee.positionallocation"/></a>'
                    }
                    return '';
                },
                headerAttributes: {
                    "class": "table-header-cell",
                    style: "text-align: center"
                },
                attributes: {style: "text-align:center"}

            },
            {
                field: "enabledFlag",
                title: '<@spring.message "employee.enabledflag"/>',
                attributes: {style: "text-align:center"},
                width: 80,
                headerAttributes: {
                    "class": "table-header-cell",
                    style: "text-align: center"
                }
            },
            {
                field: "employeeCode",
                title: '<@spring.message "employee.employeeCode"/>',
                width: 80
            },
            {
                field: "name",
                title: '<@spring.message "employee.name"/>',
                width: 80
            },
            {
                field: "email",
                title: '<@spring.message "user.email"/>',
                width: 240
            },
            {
                field: "mobil",
                title: '<@spring.message "employee.mobile"/>',
                width: 120
            }, {
                field: "status",
                title: '<@spring.message "employee.status"/>',
                width: 60,
                template: function (dataItem) {
                    var v = dataItem.status;
                    $.each(employeeStatusData, function (i, n) {
                        if ((n.value || '').toLowerCase() == (v || '').toLowerCase()) {
                            v = n.meaning;
                            return v;
                        }
                    })
                    return v;
                },
                editor: function (container, options) {
                    $('<input name="' + options.field + '"/>')
                            .appendTo(container)
                            .kendoDropDownList({
                                dataTextField: "meaning",
                                dataValueField: "value",
                                valuePrimitive: true,
                                dataSource: employeeStatusData
                            });
                }
            }, {
                field: "gender",
                title: '<@spring.message "employee.gender"/>',
                width: 60,
                template: function (dataItem) {
                    var v = dataItem.gender;
                    $.each(employeeGenderData, function (i, n) {
                        if ((n.value || '').toLowerCase() == (v || '').toLowerCase()) {
                            v = n.meaning;
                            return v;
                        }
                    })
                    return v;
                },
                editor: function (container, options) {
                    $('<input name="' + options.field + '"/>')
                            .appendTo(container)
                            .kendoDropDownList({
                                dataTextField: "meaning",
                                dataValueField: "value",
                                valuePrimitive: true,
                                dataSource: employeeGenderData
                            });
                }
            },
            {
                field: "certificateType",
                title: '<@spring.message "employee.certificatetype"/>',
                width: 100,
                template: function (dataItem) {
                    var v = dataItem.certificateType;
                    $.each(employeeCertificateTypeData, function (i, n) {
                        if ((n.value || '').toLowerCase() == (v || '').toLowerCase()) {
                            v = n.meaning;
                            return v;
                        }
                    })
                    return v;
                },
                editor: function (container, options) {
                    $('<input name="' + options.field + '"/>')
                            .appendTo(container)
                            .kendoDropDownList({
                                dataTextField: "meaning",
                                dataValueField: "value",
                                valuePrimitive: true,
                                dataSource: employeeCertificateTypeData
                            });
                }
            },
            {
                field: "certificateId",
                title: '<@spring.message "employee.certificateid"/>',
                width: 170
            },
            {
                field: "effectiveStartDate",
                attributes: {style: "text-align:center"},
                title: '<@spring.message "employee.effectivestartdate"/>',
                width: 150,
                headerAttributes: {
                    "class": "table-header-cell",
                    style: "text-align: center"
                },
                format: "{0:yyyy-MM-dd}"
            },
            {
                field: "effectiveEndDate",
                attributes: {style: "text-align:center"},
                title: '<@spring.message "employee.effectiveenddate"/>',
                width: 150,
                headerAttributes: {
                    "class": "table-header-cell",
                    style: "text-align: center"
                },
                format: "{0:yyyy-MM-dd}"
            },
            {
                field: "joinDate",
                attributes: {style: "text-align:center"},
                title: '<@spring.message "employee.joindate"/>',
                width: 150,
                headerAttributes: {
                    "class": "table-header-cell",
                    style: "text-align: center"
                },
                format: "{0:yyyy-MM-dd}"
            },
            {
                field: "bornDate",
                attributes: {style: "text-align:center"},
                title: '<@spring.message "employee.borndate"/>',
                width: 150,
                headerAttributes: {
                    "class": "table-header-cell",
                    style: "text-align: center"
                },
                format: "{0:yyyy-MM-dd}"
            }
        ],
        editable: false
    }).data("kendoGrid");

   var userStatus= $("#status").kendoDropDownList({
        dataSource: [
            { Name: "有效", Id: "ACTV" },
            { Name: "过期", Id: "EXPR" },
            { Name: "已锁定", Id: "LOCK" }
        ],
        dataTextField: "Name",
        dataValueField: "Id"
    }).data("kendoDropDownList");


    function createNewUser() {
        var checked = grid.selectedDataItems();
        if (checked.length == 1) {
            //userViewModel.model.set("employeeId", checked[0].employeeId);
            validateExitUser();
           // userViewModel.model.set("status", "ACTV");
            openUserWin();
        } else {
            kendo.ui.showInfoDialog({
                message: $l('hap.tip.selectrow')
            })
        }
    }
    function changeStyle(isExitUser){
        var userName = document.getElementById('userName');
        var email = document.getElementById('email');
        var phone = document.getElementById('phone');
        var status = document.getElementById('status');
        var startActiveDate = document.getElementById('startActiveDate');
        var endActiveDate = document.getElementById('endActiveDate');
        if(isExitUser){
            if(!userName.getAttribute('readonly')){
                userName.setAttribute("readonly","readonly");
                email.setAttribute("readonly","readonly");
                phone.setAttribute("readonly","readonly");
                userStatus.enable(false);
                $("#startActiveDate").data("kendoDatePicker").enable(false);
                $("#endActiveDate").data("kendoDatePicker").enable(false);
                //设置背景色 为灰白 表示不可输入
                userName.style.backgroundColor="#F5F5F5";
                email.style.backgroundColor="#F5F5F5";
                phone.style.backgroundColor="#F5F5F5";
                status.style.backgroundColor="#F5F5F5";
                startActiveDate.style.backgroundColor="#F5F5F5";
                endActiveDate.style.backgroundColor="#F5F5F5";

            }
        }else{
            if(userName.getAttribute('readonly')){
                userName.removeAttribute('readonly');
                email.removeAttribute('readonly');
                phone.removeAttribute('readonly');
                userStatus.enable(true);
                $("#startActiveDate").data("kendoDatePicker").enable(true);
                $("#endActiveDate").data("kendoDatePicker").enable(true);
                //设置背景色 为空白 表示可输入
                userName.style.backgroundColor = "#ffffff";
                email.style.backgroundColor = "#ffffff";
                phone.style.backgroundColor = "#ffffff";
                status.style.backgroundColor = "#ffffff";
                startActiveDate.style.backgroundColor = "#ffffff";
                endActiveDate.style.backgroundColor = "#ffffff";
            }
        }
    }

    function validateExitUser(){
        var checked = grid.selectedDataItems();
        var employeeCode = checked[0].employeeCode;
        $.ajax({
            type   : 'POST',
            url    : "${base.contextPath}/sys/user/query",
            data   : {userName:employeeCode},
            success: function (data) {
                if(data.rows==null || data.rows.length==0){
                    userViewModel.model.set("userName", checked[0].employeeCode);
                    userViewModel.model.set("email", checked[0].email);
                    userViewModel.model.set("phone", checked[0].phone);
                    changeStyle(false);
                }else{
                    userViewModel.model.set("userName",data.rows[0].userName);
                    userViewModel.model.set("email",data.rows[0].email);
                    userViewModel.model.set("phone",data.rows[0].phone);
                    userViewModel.model.set("status",data.rows[0].status);
                    userViewModel.model.set("userId",data.rows[0].userId);
                    userViewModel.model.set("startActiveDate",data.rows[0].startActiveDate);
                    userViewModel.model.set("endActiveDate",data.rows[0].endActiveDate);
                    queryExitUserRole(data.rows[0].userName);
                    changeStyle(true);
                }
            }
        });

    }

    function queryExitUserRole(userData){
        $.ajax({
            type   : 'POST',
            url    : "${base.contextPath}/sys/userrole/query",
            data   : {userName:userData},
            success: function (data) {
                var rows = data.rows;
                if(rows!=null && rows.length!=0){
                    for(var i=0;i<rows.length;i++){
                        var userRoleData={};
                        userRoleData["roleCode"]=rows[i].roleCode;
                        userRoleData["roleName"]=rows[i].roleName;
                        userRoleData["roleId"]=rows[i].roleId;
                        $("#userGrid").data("kendoGrid").dataSource.add(userRoleData);

                    }
                }
            }
        });
    }
    $("#createUserWin").kendoWindow({
        actions: ["Close"],
        title: $l('新建用户'),
        draggable: true,
        height: "430px",
        width: "900px",
        resizable: false,
        modal:true,
        //初始化时设置为隐藏状态
        visible: false,
        close: onClose
    });

   function onClose() {
        //userViewModel 清空
        userStatus.value("ACTV");
        var formData = userViewModel.model.toJSON();
        for (var k in formData) {
            userViewModel.model.set(k, null);
        }
        cleanRole();
    }
    function cleanRole() {
        var formData = userViewModel.role.toJSON();
        for (var k in formData) {
            userViewModel.role.set(k, null);
        }
    }

    function openUserWin() {
        var win = $("#createUserWin").data("kendoWindow");
        win.center().open();
        $("#userGrid").data("kendoGrid").dataSource.data([]);
        //Hap.autoResizeGrid("#userGrid");
    }

    function saveRole() {
        var selection = $('#chooseGrid').data('kendoGrid').selectedDataItems();
        for (var i = 0; i < selection.length; i++) {
            if($("#userGrid").data("kendoGrid").dataSource.data().length==0){
                var userGridData={};
                userGridData["roleCode"]=selection[i].roleCode;
                userGridData["roleName"]=selection[i].roleName;
                userGridData["roleId"]=selection[i].roleId;
                $("#userGrid").data("kendoGrid").dataSource.add(userGridData);
            }else{
                var isNewRoleId = true;
                for(var j=0;j<$("#userGrid").data("kendoGrid").dataSource.data().length;j++){
                    if($("#userGrid").data("kendoGrid").dataSource.data()[j].roleId==selection[i].roleId){
                        isNewRoleId = false;
                    }
                }
                if(isNewRoleId){
                    var userGridData={};
                    userGridData["roleCode"]=selection[i].roleCode;
                    userGridData["roleName"]=selection[i].roleName;
                    userGridData["roleId"]=selection[i].roleId;
                    $("#userGrid").data("kendoGrid").dataSource.add(userGridData);
                }
            }
        }

        //userViewModel.role.set("userRole", users);
        $("#chooseRole").data("kendoWindow").close();
    }

    $("#chooseRole").kendoWindow({
        actions: ["Close"],
        title: $l('<@spring.message "user.allocationrole"/>'),
        draggable: true,
        width: 700,
        height: 350,
        resizable: false,
        //初始化时设置为隐藏状态
        visible: false,
        close: refreshRoleGrid
    });

    function refreshRoleGrid() {
        $("#chooseGrid").data('kendoGrid').dataSource.page(1);
    }

   function openChooseRoleWin() {
        var win = $("#chooseRole").data("kendoWindow");
        win.center().open();
        Hap.autoResizeGrid("#chooseGrid");
    }

    var modalUrl = "${base.contextPath}/sys/role",

            modalDataSource = new kendo.data.DataSource({
                transport: {
                    read: {

                        url: modalUrl + "/queryRoleNotUserRole",
                        type: "POST",
                        dataType: "json"
                    },
                    parameterMap: function (options, type) {
                        if (type !== "read" && options.models) {
                            var datas = Hap.prepareSubmitParameter(options, type);
                            return kendo.stringify(datas);
                        } else if (type === "read") {
                            return Hap.prepareQueryParameter(roleViewModel.model.toJSON(), options);
                        }
                    }
                },
                batch: true,
                serverPaging: true,
                pageSize: 20,
                schema: {
                    data: 'rows',
                    total: 'total',
                    model: {
                        //如果想动态的添加，需要这边加上唯一标识
                        id: "roleId"
                    }
                }
            });
    $("#chooseGrid").kendoGrid({
        dataSource: modalDataSource,
        navigatable: false,
        height: '100%',
        resizable: true,
        scrollable: true,
        selectable: 'multiple, rowbox',
        pageable: {
            //可以选择一个页面多少条数据
            pageSizes: [5, 10, 20, 50],
            refresh: true,
            buttonCount: 5
        },
        columns: [
            {
                field: "roleCode",
                title: '<@spring.message "role.rolecode"/>',
                width: 80
            },
            {
                field: "roleName",
                title: '<@spring.message "role.rolename"/>',
                width: 200,
            },
            {
                field: "roleDescription",
                title: '<@spring.message "role.roledescription"/>',
                width: 200,
            },

        ],
        editable: false,
        dataBound: function () {
            var view = this.dataSource.view();
            this.items().each(function (index, row) {
                kendo.bind(row, view[index]);
            });
        }

    }).data("kendoGrid")

    function deleteDataSource(e) {
        var grid = $("#userGrid").data("kendoGrid");
        grid.dataSource.remove(grid.dataSource.get(e));
    }

    $("#userGrid").kendoGrid({
        dataSource: {
            data: {},
            schema: {
                data: "data",
                total: "total",
                model: {
                    id: "roleId",
                }
            }
        },
        navigatable: false,
        height: '200px',
        resizable: true,
        scrollable: true,
        pageable: {
            //可以选择一个页面多少条数据
            refresh: true
        },
        columns: [
            {
                field: "roleCode",
                title: '<@spring.message "role.rolecode"/>',
                width: 80
            },
            {
                field: "roleName",
                title: '<@spring.message "role.rolename"/>',
                width: 200,
            },
            {
                title: '<@spring.message "hap.delete"/>',
                width:200,
                template:function(dataItem){ return '<span  onclick="deleteDataSource('+dataItem.roleId+')" class="btn btn-danger"><@spring.message "hap.delete"/></span>'}
            }

        ],
        editable: false,
        dataBound: function () {
            var view = this.dataSource.view();
            this.items().each(function (index, row) {
                kendo.bind(row, view[index]);
            });
        }

    }).data("kendoGrid");





</script>


</body>
</html>