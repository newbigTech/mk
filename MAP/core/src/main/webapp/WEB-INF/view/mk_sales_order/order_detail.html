<#--
        * description:核心订单详情页面
        * author:xuxiaoxue
        * 2017/2/5
        * version: 0.1
        *
        -->
    <#include "/include/header.html">
        <script src="${base.contextPath}/common/code?orderState=MK.ORDER.STATE" type="text/javascript"></script>
        <script src="${base.contextPath}/common/code?orderEntryState=MK.ORDER_ENTRY.STATUS" type="text/javascript"></script>
        <script src="${base.contextPath}/common/code?hmallShippingType=HMALL.SHIPPING_TYPE" type="text/javascript"></script>
        <script src="${base.contextPath}/common/code?hmallInvoiceType=HMALL.INVOICE.TYPE" type="text/javascript"></script>
        <style type="text/css">
            #forms .form-group label {
                text-align: right;
                font-size: auto;
                margin-top: 8px;
            }

            #forms .row {
                margin-top: 10px;
            }

            span.k-widget.k-tooltip-validation {
                display: inline-block;
                width: 160px;
                text-align: left;
                border: 0;
                padding: 0;
                margin: 0;
                background: none;
                box-shadow: none;
                color: red;
            }

            .k-tooltip-validation .k-warning {
                display: none;
            }

            span.k-widget.k-tooltip-validation {
                display: none !important;
            }
        </style>
        <body>
        <script type="text/javascript">
            var dataItemSuccess;
            var orderId = '${RequestParameters.orderId!0}';
            var orderCode = '${RequestParameters.orderCode!0}';
            var BaseUrl = _basePath;
            //用于保存该条订单详情
            var originalData = null;
            //保存Ajax查询到的区域信息作为下拉框数据源
            var data_country = null;
            var data_state = null;
            var data_city = null;
            var data_area = null;
            //保存国家和省的下拉框是否改变
            var countryChange = false;
            var stateChange = false;

            var viewModel = kendo.observable({
                model: {}
            });

            var orderEntryViewModel = kendo.observable({
                model: {}
            });

            var orderflowTrackViewModel = kendo.observable({
                model: {}
            });

            var orderEventRecordViewModel = kendo.observable({
                model: {}
            });

            var orderOperateRecordViewModel = kendo.observable({
                model: {}
            });

            $(function () {
                $.ajax({
                    type: 'POST',
                    url: "${base.contextPath}/markor/art241/core/order/queryByOrderId?orderId=" + orderId,
                    dataType: "json",
                    contentType: "application/json",
                    async: false,
                    success: function (data) {
                        if (data.success) {
                            var a0 = data.rows[0] || {};
                            originalData = a0;
                            for (var k in a0) {
                                viewModel.model.set(k, a0[k]);
                            }
                        }
                    }
                });
            });

        </script>
        <script type="text/javascript">
            //保存Ajax查询到的区域信息作为下拉框数据源
            var data_country = null;
            var data_state = null;
            var data_city = null;
            var data_area = null;

            $(function () {
                //获取国家下拉列表并显示该订单的收货人国家
                $.ajax({
                    url: BaseUrl + "/fnd/regions/getCountry",
                    type: 'POST',
                    contentType: 'application/json',
                    success: function (data) {
                        data_country = data.rows;
                        $('#receiverCountry').data("kendoDropDownList").setDataSource(data_country);
                        $.each(data_country, function (i, n) {
                            if (n.regionCode == originalData.receiverCountry) {
                                $('#receiverCountry').data("kendoDropDownList").select(i);
                            }
                        })
                    }
                });
                //获取省下拉列表并显示该订单的收货人省
                $.ajax({
                    url: BaseUrl + "/fnd/regions/getState?countryCode=" + originalData.receiverCountry,
                    type: 'POST',
                    dataType: "json",
                    contentType: 'application/json',
                    success: function (data) {
                        data_state = data.rows;
                        $('#receiverState').data("kendoDropDownList").setDataSource(data_state);
                        $.each(data_state, function (i, n) {
                            if (n.regionCode == originalData.receiverState) {
                                $('#receiverState').data("kendoDropDownList").select(i);
                            }
                        })
                    }
                });
                //获取市下拉列表并显示该订单的收货人市
                $.ajax({
                    url: BaseUrl + "/fnd/regions/getCity?stateCode=" + originalData.receiverState,
                    type: 'POST',
                    dataType: "json",
                    contentType: 'application/json',
                    success: function (data) {
                        data_city = data.rows;
                        $('#receiverCity').data("kendoDropDownList").setDataSource(data_city);
                        $.each(data_city, function (i, n) {
                            if (n.regionCode == originalData.receiverCity) {
                                $('#receiverCity').data("kendoDropDownList").select(i);
                            }
                        })
                    }
                });
                //获取区下拉列表并显示该订单的收货人区
                $.ajax({
                    url: BaseUrl + "/fnd/regions/getArea?cityCode=" + originalData.receiverCity,
                    type: 'POST',
                    dataType: "json",
                    contentType: 'application/json',
                    success: function (data) {
                        data_area = data.rows;
                        $('#receiverDistrict').data("kendoDropDownList").setDataSource(data_area);
                        $.each(data_area, function (i, n) {
                            if (n.regionCode == originalData.receiverDistrict) {
                                $('#receiverDistrict').data("kendoDropDownList").select(i);
                            }
                        })
                    }
                });
            })
        </script>

        <div id="page-content">
            <div class="pull-left" id="toolbar-btn" style="padding-bottom:10px;">
                <span class="btn btn-primary" style="float:left;margin-right:5px;" onclick="edit()">编辑</span>
                <span class="btn btn-primary" style="float:left;margin-right:5px;" onclick="save()"><@spring.message "hap.save"/></span>
                <span class="btn btn-primary" style="float:left;margin-right:5px;" onclick="entryArtOrderDetailFunction()">查看原始订单</span>
            </div>
            <div id="query-form" style="padding-bottom:10px;clear: both;padding-bottom:10px;">
                <form id="forms" style="padding-bottom: 20px">
                    <div class="panel-body" style=" border: 1px solid #eeeeee;">
                        <div>
                            <label>基本信息</label>
                        </div>

                        <div class="row">
                            <div class="col-sm-4">
                                <div class="form-group">
                                    <label class="col-sm-4 control-label">订单编号</label>
                                    <div class="col-sm-8">
                                        <input class="equalChild form-control " data-role="maskedtextbox" placeholder='' style="width: 100%" type="text" data-bind="value:model.code" class="k-textbox"
                                               required readonly>
                                    </div>
                                </div>
                            </div>
                            <div class="col-sm-4">
                                <div class="form-group">
                                    <label class="col-sm-4 control-label">平台订单编号</label>
                                    <div class="col-sm-8">
                                        <input class="equalChild form-control " data-role="maskedtextbox" placeholder='' style="width: 100%" type="text" data-bind="value:model.escOrderCode"
                                               class="k-textbox" required readonly>
                                    </div>
                                </div>
                            </div>
                            <div class="col-sm-4">
                                <div class="form-group">
                                    <label class="col-sm-4 control-label ">订单状态</label>
                                    <div class="col-sm-8">
                                        <input class="equalChild" id="orderstatus" style="width: 100%" name='<@spring.message "hmall.as.material.cstatus"/>' type="text"
                                               data-bind="value:model.orderStatus"
                                               required readonly>
                                        <script type="text/javascript">
                                            $("#orderstatus").kendoDropDownList({
                                                dataTextField: "meaning",
                                                dataValueField: "value",
                                                valuePrimitive: true,
                                                dataSource: orderState
                                            }).data("kendoDropDownList");
                                        </script>
                                    </div>
                                </div>
                            </div>

                        </div>
                        <div class="row">
                            <div class="col-sm-4">
                                <div class="form-group">
                                    <label class="col-sm-4 control-label">订单归属关系</label>
                                    <div class="col-sm-8">
                                        <input class="equalChild form-control " data-role="maskedtextbox" placeholder='' style="width: 100%" type="text" data-bind="value:model.orderOwner"
                                               class="k-textbox" required readonly>
                                    </div>
                                </div>
                            </div>
                            <div class="col-sm-4">
                                <div class="form-group">
                                    <label class="col-sm-4 control-label">付款金额</label>
                                    <div class="col-sm-8">
                                        <input class="equalChild form-control " data-role="maskedtextbox" placeholder='' style="width: 100%" type="text" data-bind="value:model.paymentAmount"
                                               class="k-textbox" required readonly>
                                    </div>
                                </div>
                            </div>
                            <div class="col-sm-4">
                                <div class="form-group">
                                    <label class="col-sm-4 control-label">订单金额</label>
                                    <div class="col-sm-8">
                                        <input class="equalChild form-control " data-role="maskedtextbox" placeholder='' style="width: 100%" type="text" data-bind="value:model.orderAmount"
                                               class="k-textbox" required readonly>
                                    </div>
                                </div>
                            </div>


                        </div>
                        <div class="row">
                            <div class="col-sm-4">
                                <div class="form-group">
                                    <label class="col-sm-4 control-label">配送方式</label>
                                    <div class="col-sm-8">
                                        <input class="equalChild" id="shippingType" style="width: 100%" name='<@spring.message "hmall.as.material.shippingType"/>' type="text"
                                               data-bind="value:model.shippingType"
                                               required>
                                        <script type="text/javascript">
                                            $("#shippingType").kendoDropDownList({
                                                dataTextField: "meaning",
                                                dataValueField: "value",
                                                valuePrimitive: true,
                                                dataSource: hmallShippingType
                                            }).data("kendoDropDownList");
                                            var shippingTypeKendoDropDownList = $('#shippingType').data("kendoDropDownList");
                                            shippingTypeKendoDropDownList.readonly(true);
                                        </script>
                                    </div>
                                </div>
                            </div>
                            <div class="col-sm-4">
                                <div class="form-group">
                                    <label class="col-sm-4 control-label">预计交货时间</label>
                                    <div class="col-sm-8">
                                        <input id="estimateDeliveryTime" class="rangeChild" name='<@spring.message "hmall.serviceorder.appointmentdate"/>' data-bind="value:model.estimateDeliveryTime"
                                               style="width:100%" required readonly/>
                                    </div>
                                </div>
                            </div>

                            <div class="col-sm-4">
                                <div class="form-group">
                                    <label class="col-sm-4 control-label">确认收货时间</label>
                                    <div class="col-sm-8">
                                        <input id="tradeFinishTime" class="rangeChild" name='<@spring.message "hmall.serviceorder.appointmentdate"/>' data-bind="value:model.tradeFinishTime"
                                               style="width:100%" required readonly/>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-sm-4">
                                <div class="form-group">
                                    <label for="locked" class="col-sm-4 control-label">订单锁定</label>
                                    <div class="col-sm-8">
                                        <div id="locked" class="full_width" style="margin-top: 8px;" data-bind="value:model.locked" required readonly></div>
                                        <script type="text/javascript">
                                            $("#locked").kendoRadio({
                                                layout: '',//vertical
                                                readonly: false,
                                                disabled: true,
                                                items: [{
                                                    label: "是",
                                                    value: "Y"
                                                }, {
                                                    label: "否",
                                                    value: "N"
                                                }],
                                            }).data("kendoRadio");
                                        </script>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="panel-body" style=" border: 1px solid #eeeeee;margin-top: 10px;">
                        <div>
                            <label>收货人信息</label>
                        </div>

                        <div class="row">
                            <div class="col-sm-4">
                                <div class="form-group">
                                    <label class="col-sm-4 control-label">收货人姓名</label>
                                    <div class="col-sm-8">
                                        <input id="receiverName" class="equalChild form-control" style="width: 100%" type="text" data-bind="value:model.receiverName" required readonly/>
                                    </div>
                                </div>
                            </div>
                            <div class="col-sm-4">
                                <div class="form-group">
                                    <label class="col-sm-4 control-label">收货人手机号</label>
                                    <div class="col-sm-8">
                                        <input id="receiverMobile" class="equalChild form-control" data-bind="value:model.receiverMobile" style="width:100%" required readonly/>
                                    </div>
                                </div>
                            </div>
                            <div class="col-sm-4">
                                <div class="form-group">
                                    <label class="col-sm-4 control-label">收货人电话</label>
                                    <div class="col-sm-8">
                                        <input id="receiverPhone" class="equalChild form-control" data-bind="value:model.receiverPhone" style="width:100%" readonly/>
                                    </div>
                                </div>
                            </div>


                        </div>


                        <div class="row">
                            <div class="col-sm-4">
                                <div class="form-group">
                                    <label class="col-sm-4 control-label">国家</label>
                                    <div class="col-sm-8">
                                        <input type="text" style="width: 160px;"
                                               id="receiverCountry" data-bind="value:model.receiverCountry" required/>
                                    </div>
                                    <script>

                                        $('#receiverCountry').kendoDropDownList({
                                            dataTextField: 'regionName',
                                            dataValueField: 'regionCode',
                                            dataSource: data_country,
                                            change: function (e) {
                                                $.ajax({
                                                    url: BaseUrl + "/fnd/regions/getState?countryCode=" + $('#receiverCountry').val(),
                                                    type: 'POST',
                                                    dataType: "json",
                                                    contentType: 'application/json',
                                                    success: function (data) {
                                                        countryChange = true;
                                                        data_state = data.rows;
                                                        $('#receiverCity').data("kendoDropDownList").select(-1);
                                                        $('#receiverDistrict').data("kendoDropDownList").select(-1);
                                                        $('#receiverState').data("kendoDropDownList").setDataSource(data_state);
                                                    }
                                                });
                                            }
                                        })
                                    </script>
                                </div>
                            </div>
                            <div class="col-sm-4">
                                <div class="form-group">
                                    <label class="col-sm-4 control-label">省</label>
                                    <div class="col-sm-8">
                                        <input type="text" style="width: 160px;"
                                               id="receiverState" data-bind="value:model.receiverState" required/>
                                    </div>
                                    <script>
                                        $('#receiverState').kendoDropDownList({
                                            dataTextField: 'regionName',
                                            dataValueField: 'regionCode',
                                            dataSource: data_state,
                                            change: function (e) {
                                                $.ajax({
                                                    url: BaseUrl + "/fnd/regions/getCity?stateCode=" + $('#receiverState').val(),
                                                    type: 'POST',
                                                    dataType: "json",
                                                    contentType: 'application/json',
                                                    success: function (data) {
                                                        stateChange = true;
                                                        data_city = data.rows;
                                                        $('#receiverDistrict').data("kendoDropDownList").select(-1);
                                                        $('#receiverCity').data("kendoDropDownList").setDataSource(data_city);

                                                    }
                                                });
                                            }
                                        })
                                    </script>
                                </div>
                            </div>
                            <div class="col-sm-4">
                                <div class="form-group">
                                    <label class="col-sm-4 control-label">市</label>
                                    <div class="col-sm-8">
                                        <input type="text" style="width: 160px;" data-value-primitive="true"
                                               id="receiverCity" data-bind="value:model.receiverCity" required/>
                                    </div>
                                    <script>
                                        var receiverCityKendoDropDownList = $('#receiverCity').kendoDropDownList({
                                            dataTextField: 'regionName',
                                            dataValueField: 'regionCode',
                                            dataSource: data_city,
                                            change: function (e) {
                                                $.ajax({
                                                    url: BaseUrl + "/fnd/regions/getArea?cityCode=" + $('#receiverCity').val(),
                                                    type: 'POST',
                                                    dataType: "json",
                                                    contentType: 'application/json',
                                                    success: function (data) {
                                                        data_area = data.rows;
                                                        $('#receiverDistrict').data("kendoDropDownList").setDataSource(data_area);

                                                    }
                                                });
                                            }
                                        })
                                    </script>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-sm-4">
                                <div class="form-group">
                                    <label class="col-sm-4 control-label">区</label>
                                    <div class="col-sm-8">
                                        <input type="text" style="width: 160px;" data-value-primitive="true"
                                               id="receiverDistrict" data-bind="value:model.receiverDistrict" required/>
                                    </div>
                                    <script>
                                        var receiverDistrictKendoDropDownList = $('#receiverDistrict').kendoDropDownList({
                                            dataTextField: 'regionName',
                                            dataValueField: 'regionCode',
                                            dataSource: data_area,
                                            change: function (e) {

                                            }
                                        })
                                    </script>
                                </div>
                            </div>
                            <div class="col-sm-4">
                                <div class="form-group">
                                    <label class="col-sm-4 control-label">收货人地址</label>
                                    <div class="col-sm-8">
                                        <input id="receiverAddress" class="equalChild form-control" data-bind="value:model.receiverAddress" style="width:100%" required readonly/>
                                    </div>
                                </div>
                            </div>
                            <div class="col-sm-4">
                                <div class="form-group">
                                    <label class="col-sm-4 control-label">收货人邮编</label>
                                    <div class="col-sm-8">
                                        <input id="receiverZip" class="equalChild form-control" data-bind="value:model.receiverZip" style="width:100%" readonly/>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="panel-body" style=" border: 1px solid #eeeeee;margin-top: 10px;">
                        <div>
                            <label>发票信息</label>
                        </div>

                        <div class="row">
                            <div class="col-sm-4">
                                <div class="form-group">
                                    <label class="col-sm-4 control-label">发票类型</label>
                                    <div class="col-sm-8">
                                        <input class="equalChild" id="invoiceType" style="width: 100%" name='<@spring.message "hmall.as.material.cstatus"/>' type="text"
                                               data-bind="value:model.invoiceType">
                                        <script type="text/javascript">
                                            var invoiceTypeKendoDropDownList = $("#invoiceType").kendoDropDownList({
                                                dataTextField: "meaning",
                                                dataValueField: "value",
                                                valuePrimitive: true,
                                                dataSource: hmallInvoiceType
                                            }).data("kendoDropDownList");
                                        </script>
                                    </div>
                                </div>
                            </div>
                            <div class="col-sm-4">
                                <div class="form-group">
                                    <label class="col-sm-4 control-label">发票名称</label>
                                    <div class="col-sm-8">
                                        <input id="invoiceName" class="equalChild form-control" data-bind="value:model.invoiceName" style="width:100%" readonly/>
                                    </div>
                                </div>
                            </div>
                            <div class="col-sm-4">
                                <div class="form-group">
                                    <label class="col-sm-4 control-label">纳税人识别号</label>
                                    <div class="col-sm-8">
                                        <input id="invoiceNumber" class="equalChild form-control" data-bind="value:model.invoiceNumber" style="width:100%" readonly/>
                                    </div>
                                </div>
                            </div>
                        </div>

                    </div>
                </form>

            </div>

            <div id="tabStrip">
                <ul>
                    <li id="orderEntry"><@spring.message "hmall.OrderEntry.orderLine"/></li>
                    <li id="orderflowTrack"><@spring.message "订单流程跟踪"/></li>
                    <li id="orderEventRecord"><@spring.message "订单事件记录"/></li>
                    <li id="orderOperateRecord"><@spring.message "订单操作记录"/></li>
                </ul>
                <div class="tab-pane fade in active" style="margin-top: 10px;">
                    <div id="page-content1">
                        <div id='grid-container' style="clear: both;">
                            <div id="orderEntryGrid"></div>
                        </div>
                    </div>
                </div>
                <div class="tab-pane fade" style="margin-top: 10px;">
                    <div id="page-content2">
                        <div id="orderflowTrackGrid"></div>
                    </div>
                </div>
                <div class="tab-pane fade" style="margin-top: 10px;">
                    <div id="page-content3">
                        <div id="orderEventRecordGrid"></div>
                    </div>
                </div>
                <div class="tab-pane fade" style="margin-top: 10px;">
                    <div id="page-content4">
                        <div id="orderOperateRecordGrid"></div>
                    </div>
                </div>
            </div>

        </div>
        <script type="text/javascript">

            var tabstrip = $("#tabStrip").kendoTabStrip({
                animation: {
                    close: {
                        duration: 200,
                        effects: "fadeOut"
                    },
                    open: {
                        duration: 200,
                        effects: "fadeIn"
                    }
                }
            }).data("kendoTabStrip");

            tabstrip.activateTab($("#orderEntry"));

            kendo.bind($('#page-content'), viewModel);
            $("#estimateDeliveryTime").kendoDateTimePicker({
                animation: {
                    close: {
                        effects: "fadeOut zoom:out",
                        duration: 300
                    },
                    open: {
                        effects: "fadeIn zoom:in",
                        duration: 300
                    }
                },
                format: "yyyy-MM-dd HH:mm:ss",
                change: function () {

                }
            });
            $("#tradeFinishTime").kendoDateTimePicker({
                animation: {
                    close: {
                        effects: "fadeOut zoom:out",
                        duration: 300
                    },
                    open: {
                        effects: "fadeIn zoom:in",
                        duration: 300
                    }
                },
                format: "yyyy-MM-dd HH:mm:ss",
                change: function () {

                }
            });


            orderEntryDataSource = new kendo.data.DataSource({
                transport: {
                    read: {
                        url: BaseUrl + "/markor/art241/core/order/queryEntryByOrderId?orderId=" + orderId,
                        type: "POST",
                        dataType: "json"
                    },
                    parameterMap: function (options, type) {
                        if (type !== "read" && options.models) {
                            var datas = Hap.prepareSubmitParameter(options, type);
                            return kendo.stringify(datas);
                        } else if (type === "read") {
                            return Hap.prepareQueryParameter(orderEntryViewModel.model.toJSON(), options);
                        }
                    }
                },
                batch: true,
                serverPaging: true,
                pageSize: 10,
                schema: {
                    data: 'rows',
                    total: 'total',
                    model: {
                        id: "paymentinfoId",
                        fields: {}
                    }
                }
            });


            orderflowTrackDataSource = new kendo.data.DataSource({
                transport: {
                    read: {
                        url: BaseUrl + "/mk/order/queryProcessTrace?orderCode=" + orderCode,
                        type: "POST",
                        dataType: "json"
                    },
                    parameterMap: function (options, type) {
                        if (type === "read") {
                            return Hap.prepareQueryParameter(orderflowTrackViewModel.model.toJSON(), options);
                        }
                    }
                },
                batch: true,
                serverPaging: true,
                pageSize: 10,
                schema: {
                    data: 'rows',
                    total: 'total',
                    model: {
                        id: "id",
                        fields: {}
                    }
                }
            });

            orderEventRecordDataSource = new kendo.data.DataSource({
                transport: {
                    read: {
                        url: BaseUrl + "/mk/order/queryEntryPointLogEvent?orderCode=" + orderCode,
                        type: "POST",
                        dataType: "json"
                    },
                    parameterMap: function (options, type) {
                        if (type === "read") {
                            return Hap.prepareQueryParameter(orderEventRecordViewModel.model.toJSON(), options);
                        }
                    }
                },
                batch: true,
                serverPaging: true,
                pageSize: 10,
                schema: {
                    data: 'rows',
                    total: 'total',
                    model: {
                        id: "id",
                        fields: {}
                    }
                }
            });

            orderOperateRecordDataSource = new kendo.data.DataSource({
                transport: {
                    read: {
                        url: BaseUrl + "/mk/order/queryEntryPointLogOperate?orderCode=" + orderCode,
                        type: "POST",
                        dataType: "json"
                    },
                    parameterMap: function (options, type) {
                        if (type === "read") {
                            return Hap.prepareQueryParameter(orderOperateRecordViewModel.model.toJSON(), options);
                        }
                    }
                },
                batch: true,
                serverPaging: true,
                pageSize: 10,
                schema: {
                    data: 'rows',
                    total: 'total',
                    model: {
                        id: "id",
                        fields: {}
                    }
                }
            });

            //订单行GRID
            var _orderEntrygrid_ = $("#orderEntryGrid").kendoGrid({
                dataSource: orderEntryDataSource,
                height: "320px",
                resizable: true,
                editable: false,
                navigatable: true,
                scrollable: true,
                rownumber: true,
                sortable: true,
                editable: false,
                pageable: {
                    pageSizes: [5, 10, 20, 50],
                    refresh: true,
                    buttonCount: 10
                },
                columns: [{
                    field: "pin",
                    title: 'PIN码',
                    width: 80,
                    headerAttributes: {
                        "class": "table-header-cell",
                        style: "text-align: center"
                    }

                }, {
                    field: "productCode",
                    title: '商品编码',
                    width: 100,
                    headerAttributes: {
                        "class": "table-header-cell",
                        style: "text-align: center"
                    }

                }, {
                    field: "vproductCode",
                    title: '变式物料号',
                    width: 120,
                    headerAttributes: {
                        "class": "table-header-cell",
                        style: "text-align: center"
                    }
                }, {
                    field: "productName",
                    title: '框架产品名称',
                    width: 120,
                    headerAttributes: {
                        "class": "table-header-cell",
                        style: "text-align: center"
                    }
                },
                    {
                        field: "basePrice",
                        title: '单价',
                        width: 80,
                        headerAttributes: {
                            "class": "table-header-cell",
                            style: "text-align: center"
                        }
                    }, {
                        field: "quantity",
                        title: '数量',
                        width: 80,
                        headerAttributes: {
                            "class": "table-header-cell",
                            style: "text-align: center"
                        }
                    }, {
                        field: "totalFee",
                        title: '行总价',
                        width: 100,
                        headerAttributes: {
                            "class": "table-header-cell",
                            style: "text-align: center"
                        }
                    }, {
                        field: "totalDiscount",
                        title: '优惠总金额',
                        width: 120,
                        headerAttributes: {
                            "class": "table-header-cell",
                            style: "text-align: center"
                        }
                    }, {
                        field: "orderEntryStatus",
                        title: '状态',
                        width: 80,
                        headerAttributes: {
                            "class": "table-header-cell",
                            style: "text-align: center"
                        },
                        template: function (dataItem) {
                            var v = dataItem.orderEntryStatus;
                            if (v == null) {
                                return '';
                            }
                            $.each(orderEntryState, function (i, n) {
                                if (n.value == v) {
                                    v = n.meaning;
                                    return v;
                                } else {
                                    return '';
                                }
                            });
                            return v;
                        }
                    }, {
                        field: "bomRejectReason",
                        title: '工艺拒绝原因',
                        width: 140,
                        headerAttributes: {
                            "class": "table-header-cell",
                            style: "text-align: center"
                        }
                    }, {
                        field: "estimateConTime",
                        title: '预计发货时间',
                        width: 140,
                        headerAttributes: {
                            "class": "table-header-cell",
                            style: "text-align: center"
                        }
                    }, {
                        field: "estimateDeliveryTime",
                        title: '预计交货时间',
                        width: 140,
                        headerAttributes: {
                            "class": "table-header-cell",
                            style: "text-align: center"
                        }
                    }, {
                        field: "oriRequirementTime",
                        title: '客户原始需求日期',
                        width: 140,
                        headerAttributes: {
                            "class": "table-header-cell",
                            style: "text-align: center"
                        }
                    }, {
                        field: "atpCalculateTime",
                        title: 'ATP答复最早交期',
                        width: 140,
                        headerAttributes: {
                            "class": "table-header-cell",
                            style: "text-align: center"
                        }
                    }
                ],
            }).data("kendoGrid");

            //订单流程跟踪表
            var _orderflowTrackgrid_ = $("#orderflowTrackGrid").kendoGrid({
                dataSource: orderflowTrackDataSource,
                height: "320px",
                resizable: true,
                scrollable: true,
                navigatable: false,
                pageable: true,
                rownumber: true,
                pageable: {
                    pageSizes: [5, 10, 20, 50],
                    refresh: true,
                    buttonCount: 5
                },
                columns: [{
                    field: "time",
                    title: '时间',
                    width: 80,
                    headerAttributes: {
                        "class": "table-header-cell",
                        style: "text-align: center"
                    }

                }, {
                    field: "currentNodeName",
                    title: '当前节点名称',
                    width: 100,
                    headerAttributes: {
                        "class": "table-header-cell",
                        style: "text-align: center"
                    }

                }, {
                    field: "previousNodeName",
                    title: '上一节点名称',
                    width: 120,
                    headerAttributes: {
                        "class": "table-header-cell",
                        style: "text-align: center"
                    }
                }, {
                    field: "status",
                    title: '状态',
                    width: 80,
                    headerAttributes: {
                        "class": "table-header-cell",
                        style: "text-align: center"
                    },
                    template: function (dataItem) {
                        if (dataItem.status != null && dataItem.status != '') {
                            return '<a style="margin-right:10px;" href="javascript:void(0);" onclick="showExceptionInfo(\'' + dataItem.id + '\')">' + dataItem.status + '</a>'
                        }
                    }
                }, {
                    field: "exceptionInfo",
                    title: '异常信息',
                    width: 80,
                    headerAttributes: {
                        "class": "table-header-cell",
                        style: "text-align: center"
                    },
                    hidden: true
                }, {
                    field: "type",
                    title: '触发类型',
                    width: 80,
                    headerAttributes: {
                        "class": "table-header-cell",
                        style: "text-align: center"
                    }
                }, {
                    field: "entryPointName",
                    title: '触发点名称',
                    width: 100,
                    headerAttributes: {
                        "class": "table-header-cell",
                        style: "text-align: center"
                    }
                }
                ],
                editable: false
            });

            //订单事件记录表
            var _orderEventRecordgrid_ = $("#orderEventRecordGrid").kendoGrid({
                dataSource: orderEventRecordDataSource,
                height: "320px",
                pageable: true,
                resizable: true,
                editable: false,
                navigatable: true,
                scrollable: true,
                rownumber: true,
                sortable: true,
                pageable: {
                    pageSizes: [5, 10, 20, 50],
                    refresh: true,
                    buttonCount: 10
                },
                columns: [{
                    field: "displayName",
                    title: '触发点名称',
                    width: 80,
                    headerAttributes: {
                        "class": "table-header-cell",
                        style: "text-align: center"
                    }

                }, {
                    field: "time",
                    title: '发生时间',
                    width: 100,
                    headerAttributes: {
                        "class": "table-header-cell",
                        style: "text-align: center"
                    }

                }, {
                    field: "success",
                    title: '是否执行成功',
                    width: 120,
                    headerAttributes: {
                        "class": "table-header-cell",
                        style: "text-align: center"
                    },
                    template: function (dataItem) {
                        if (dataItem.success != null && dataItem.success !== '') {
                            return '<a style="margin-right:10px;" href="javascript:void(0);" onclick="showExceptionDetail(\'event\', \'' + dataItem.id + '\')">' + dataItem.success + '</a>'
                        }
                    }
                }, {
                    field: "exceptionDetail",
                    title: '异常信息',
                    width: 80,
                    headerAttributes: {
                        "class": "table-header-cell",
                        style: "text-align: center"
                    },
                    hidden: true
                }
                ],
                dataBound: function () {
                    var rows = this.items();
                    var page = this.pager.page() - 1;
                    var pagesize = this.pager.pageSize();
                    $(rows).each(
                            function () {
                                var index = $(this).index() + 1 + page * pagesize;
                                var rowLabel = $(this).find(".row-number");
                                $(rowLabel).html(index);
                            });
                }
            }).data("kendoGrid");

            //订单操作记录表
            var _orderOperateRecordgrid_ = $("#orderOperateRecordGrid").kendoGrid({
                dataSource: orderOperateRecordDataSource,
                height: "320px",
                pageable: true,
                resizable: true,
                editable: false,
                navigatable: true,
                scrollable: true,
                rownumber: true,
                sortable: true,
                pageable: {
                    pageSizes: [5, 10, 20, 50],
                    refresh: true,
                    buttonCount: 10
                },
                columns: [{
                    field: "displayName",
                    title: '触发点名称',
                    width: 80,
                    headerAttributes: {
                        "class": "table-header-cell",
                        style: "text-align: center"
                    }

                }, {
                    field: "time",
                    title: '发生时间',
                    width: 100,
                    headerAttributes: {
                        "class": "table-header-cell",
                        style: "text-align: center"
                    }

                }, {
                    field: "success",
                    title: '是否执行成功',
                    width: 120,
                    headerAttributes: {
                        "class": "table-header-cell",
                        style: "text-align: center"
                    },
                    template: function (dataItem) {
                        if (dataItem.success != null && dataItem.success !== '') {
                            return '<a style="margin-right:10px;" href="javascript:void(0);" onclick="showExceptionDetail(\'action\',\'' + dataItem.id + '\')">' + dataItem.success + '</a>'
                        }
                    }
                }, {
                    field: "exceptionDetail",
                    title: '异常信息',
                    width: 80,
                    headerAttributes: {
                        "class": "table-header-cell",
                        style: "text-align: center"
                    },
                    hidden: true
                }, {
                    field: "userName",
                    title: '操作人姓名',
                    width: 80,
                    headerAttributes: {
                        "class": "table-header-cell",
                        style: "text-align: center"
                    }
                }
                ],
                dataBound: function () {
                    var rows = this.items();
                    var page = this.pager.page() - 1;
                    var pagesize = this.pager.pageSize();
                    $(rows).each(
                            function () {
                                var index = $(this).index() + 1 + page * pagesize;
                                var rowLabel = $(this).find(".row-number");
                                $(rowLabel).html(index);
                            });
                }
            }).data("kendoGrid");

            //点击显示订单流程跟踪表exceptionInfo信息
            function showExceptionInfo(id) {
                dataItem = orderflowTrackDataSource.get(id);
                //当状态为已完成/SUSPEND时,点击状态字段,弹窗显示excetionInfo的信息
                if (dataItem.status == 'SUSPEND') {
                    kendo.ui.showDialog({
                        title: 'exceptionInfo',
                        width: 800,
                        height: 300,
                        message: dataItem.exceptionInfo == 'null' ? "" : dataItem.exceptionInfo,
                        buttons: [{
                            text: "<@spring.message 'hap.ok'/>",
                            type: 'primary',
                            click: function (e) {
                                e.dialog.destroy();
                                e.deferred.resolve({
                                    button: "BUTTON1"
                                });
                            }
                        }]
                    });
                }
            }

            //点击显示订单事件记录表exceptionDetail信息
            function showExceptionDetail(type, id) {
                var dataItem;
                if (type == "action")
                    dataItem = orderOperateRecordDataSource.get(id);
                else if (type == "event")
                    dataItem = orderEventRecordDataSource.get(id);
                //当是否执行成功为否时,点击该字段,弹窗显示exceptionDetail的信息
                if (!dataItem.success) {
                    kendo.ui.showDialog({
                        title: 'exceptionDetail',
                        width: 800,
                        height: 300,
                        message: dataItem.exceptionDetail == 'null' ? "" : dataItem.exceptionDetail,
                        buttons: [{
                            text: "<@spring.message 'hap.ok'/>",
                            type: 'primary',
                            click: function (e) {
                                e.dialog.destroy();
                                e.deferred.resolve({
                                    button: "BUTTON1"
                                });
                            }
                        }]
                    });
                }
            }

            //保存
            function save() {


                kendo.ui.showConfirmDialog({
                    title: $l('hap.tip.info'),
                    message: $l('确定要保存？')
                }).done(function (event) {
                    if (event.button == 'OK') {
//                      判断国家,省,市,区是否选中值,如果未选中,弹出错误提示框,如果都选中,则保存修改的核心订单信息
                        if ($('#receiverCountry').val() == "") {
                            kendo.ui.showErrorDialog({
                                message: "国家下拉框为必选"
                            });
                        } else if ($('#receiverState').val() == "") {
                            kendo.ui.showErrorDialog({
                                message: "省下拉框为必选"
                            });
                        } else if ($('#receiverCity').val() == "") {
                            kendo.ui.showErrorDialog({
                                message: "市下拉框为必选"
                            });
                        } else if ($('#receiverDistrict').val() == "") {
                            kendo.ui.showErrorDialog({
                                message: "区下拉框为必选"
                            });
                        } else {
                            if (countryChange) {
                                viewModel.model.set("receiverCountry", viewModel.model.receiverCountry.regionCode);
                            }
                            if (stateChange) {
                                viewModel.model.set("receiverState", viewModel.model.receiverState.regionCode);
                            }
                            $.ajax({
                                type: "POST",
                                url: "${base.contextPath}/markor/art241/core/order/updateReceiverAndInvoiceInfo",
                                contentType: "application/json",
                                dataType: "json",
                                data: kendo.stringify([viewModel.model.toJSON()]),
                                success: function (data) {
                                    if (data.success == true) {
                                        kendo.ui.showInfoDialog({
                                            message: "<@spring.message '保存成功!'/>"
                                        });
                                        $("#receiverName").attr("readonly", "readonly");
                                        $("#receiverMobile").attr("readonly", "readonly");
                                        $("#receiverPhone").attr("readonly", "readonly");
                                        var receiverCountryKendoDropDownList = $('#receiverCountry').data("kendoDropDownList");
                                        var receiverStateKendoDropDownList = $('#receiverState').data("kendoDropDownList");
                                        var receiverCityKendoDropDownList = $('#receiverCity').data("kendoDropDownList");
                                        var receiverDistrictKendoDropDownList = $('#receiverDistrict').data("kendoDropDownList");
                                        var invoiceTypeKendoDropDownList = $('#invoiceType').data("kendoDropDownList");
                                        receiverCountryKendoDropDownList.readonly(true);
                                        receiverStateKendoDropDownList.readonly(true);
                                        receiverCityKendoDropDownList.readonly(true);
                                        receiverDistrictKendoDropDownList.readonly(true);
                                        invoiceTypeKendoDropDownList.readonly(true);
                                        $("#receiverAddress").attr("readonly", "readonly");
                                        $("#receiverZip").attr("readonly", "readonly");
                                        $("#invoiceType").attr("readonly", "readonly");
                                        $("#invoiceName").attr("readonly", "readonly");
                                        $("#invoiceNumber").attr("readonly", "readonly");
                                    } else {
                                        kendo.ui.showErrorDialog({
                                            message: data.message
                                        });
                                    }
                                }
                            });
                        }
                    }
                });
            }

            $(function () {
                var receiverCountryKendoDropDownList = $('#receiverCountry').data("kendoDropDownList");
                var receiverStateKendoDropDownList = $('#receiverState').data("kendoDropDownList");
                var receiverCityKendoDropDownList = $('#receiverCity').data("kendoDropDownList");
                var receiverDistrictKendoDropDownList = $('#receiverDistrict').data("kendoDropDownList");
                var invoiceTypeKendoDropDownList = $('#invoiceType').data("kendoDropDownList");
                receiverCountryKendoDropDownList.readonly(true);
                receiverStateKendoDropDownList.readonly(true);
                receiverCityKendoDropDownList.readonly(true);
                receiverDistrictKendoDropDownList.readonly(true);
                invoiceTypeKendoDropDownList.readonly(true);
                $("#receiverCountry").attr("readonly");
                $("#receiverState").attr("readonly");
                $("#receiverCity").attr("readonly");
                $("#receiverDistrict").attr("readonly");
            })


            //编辑
            function edit() {
                $("#receiverName").removeAttr("readonly");
                $("#receiverMobile").removeAttr("readonly");
                $("#receiverPhone").removeAttr("readonly");
                var receiverCountryKendoDropDownList = $('#receiverCountry').data("kendoDropDownList");
                var receiverStateKendoDropDownList = $('#receiverState').data("kendoDropDownList");
                var receiverCityKendoDropDownList = $('#receiverCity').data("kendoDropDownList");
                var receiverDistrictKendoDropDownList = $('#receiverDistrict').data("kendoDropDownList");
                var invoiceTypeKendoDropDownList = $('#invoiceType').data("kendoDropDownList");
                receiverCountryKendoDropDownList.readonly(false);
                receiverStateKendoDropDownList.readonly(false);
                receiverCityKendoDropDownList.readonly(false);
                receiverDistrictKendoDropDownList.readonly(false);
                invoiceTypeKendoDropDownList.readonly(false);
                $("#receiverCountry").removeAttr("readonly");
                $("#receiverState").removeAttr("readonly");
                $("#receiverCity").removeAttr("readonly");
                $("#receiverDistrict").removeAttr("readonly");
                $("#receiverAddress").removeAttr("readonly");
                $("#receiverZip").removeAttr("readonly");
                $("#invoiceType").removeAttr("readonly");
                $("#invoiceName").removeAttr("readonly");
                $("#invoiceNumber").removeAttr("readonly");
            }
            //ART订单详情页面
            function entryArtOrderDetailFunction() {
                window.top.openTab(orderId + parseInt(10 * Math.random()), "ART订单详情", "${base.contextPath}/art241/art_order_detail.html?escOrderCode=" + viewModel.model.escOrderCode + "&mkOrderId=" + orderId);
            }
        </script>
        </body>
        </html>

