<#--
        * description:换货单详情
        * author:zhangmeng
        * 2017/7/22
        * version: 0.1
        *
        -->
    <#include "/include/header.html">
        <script src="${base.contextPath}/common/code?serviceOrderStatus=HMALL.SERVICEORDER.STATUS" type="text/javascript"></script>
        <script src="${base.contextPath}/common/code?isCharge=SYS.YES_NO" type="text/javascript"></script>
        <style type="text/css">
            #forms .form-group label {
                text-align: right;
                font-size: auto;
                margin-top: 8px;
            }

            #forms .row {
                margin-top: 10px;
            }

            span.k-widget.k-tooltip-validation {
                display: inline-block;
                width: 160px;
                text-align: left;
                border: 0;
                padding: 0;
                margin: 0;
                background: none;
                box-shadow: none;
                color: red;
            }

            .k-tooltip-validation .k-warning {
                display: none;
            }
        </style>
        <body>
        <script type="text/javascript">
            //服务单code
            var linksCode = "${RequestParameters.linksCode!0}"
            var serviceOrderId = "${RequestParameters.serviceOrderId!0}";
            var receiptOrderId = "${RequestParameters.receiptOrderId!0}";
            var orderId = "${RequestParameters.orderId!0}";
            var orderCode = "${RequestParameters.orderCode!0}";
            var receiptType = "SR02";
            var viewModel = kendo.observable({
                model: {
                    linksCode: null,
                    orderCode: null,
                    syncflag: "N"

                }
            });
        </script>
        <div id="page-content">
            <div class="pull-left" id="toolbar-btn" style="padding-bottom:10px;">
                <span id class="btn btn-primary" style="float:left;margin-right:5px;" onclick="saveServiceOrder()"><@spring.message "hap.save"/></span>
                <span id class="btn btn-primary" style="float:left;margin-right:5px;" onclick="syncRetail()"><@spring.message "hmall.serverorder.syncflag"/></span>
            </div>
            <div id="query-form" style="padding-bottom:10px;clear: both;padding-bottom:10px;">
                <form id="forms" style="padding-bottom: 20px">
                    <div class="panel-body" style="margin-top: 10px;border:1px solid #2F617F;">
                        <h5 style="margin-left: 10px;">基本信息</h5>
                        <div class="row">
                            <div class="col-sm-4">
                                <div class="form-group">
                                    <label class="col-sm-4 control-label"><@spring.message "hmall.serviceorder.swapcode"/></label>
                                    <div class="col-sm-8">
                                        <input class="equalChild form-control " id="code" data-role="maskedtextbox" placeholder='' style="width: 100%" type="text" data-bind="value:model.code"
                                               class="k-textbox" readonly>
                                    </div>
                                </div>
                            </div>
                            <div class="col-sm-4">
                                <div class="form-group">
                                    <label class="col-sm-4 control-label"><@spring.message "hmall.serviceorder.ordertype"/></label>
                                    <div class="col-sm-8">
                                        <input class="equalChild form-control" data-role="maskedtextbox" placeholder='' style="width: 100%" type="text" value="换货单" class="k-textbox" readonly>
                                    </div>
                                </div>
                            </div>
                            <div class="col-sm-4">
                                <div class="form-group">
                                    <label class="col-sm-4 control-label "><@spring.message "hmall.user_status"/></label>
                                    <div class="col-sm-8">
                                        <input class="equalChild" id="status" style="width: 100%" name='<@spring.message "hmall.user_status"/>' type="text" data-bind="value:model.status" required>
                                        <script type="text/javascript">
                                            $("#status").kendoDropDownList({
                                                dataTextField: "meaning",
                                                dataValueField: "value",
                                                valuePrimitive: true,
                                                dataSource: serviceOrderStatus
                                            }).data("kendoDropDownList");
                                        </script>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-sm-4">
                                <div class="form-group">
                                    <label class="col-sm-4 control-label"><@spring.message "hmall.serviceorder.appointmentdate"/></label>
                                    <div class="col-sm-8">
                                        <input id="appointment_date" class="rangeChild" data-bind="value:model.appointmentDate" style="width:100%"/>
                                    </div>
                                </div>
                            </div>
                            <div class="col-sm-4">
                                <div class="form-group">
                                    <label class="col-sm-4 control-label">实际执行日期</label>
                                    <div class="col-sm-8">
                                        <input id="execution_date" class="rangeChild" data-bind="value:model.executionDate" style="width:100%"/>
                                    </div>
                                </div>
                            </div>
                            <div class="col-sm-4">
                                <div class="form-group">
                                    <label class="col-sm-4 control-label"><@spring.message "hmall.serviceorder.swapreason"/></label>
                                    <div class="col-sm-8">
                                        <input class="equalChild" data-role="maskedtextbox" placeholder='' id="changeReason" style="width: 100%;" class="k-textbox" type="text"
                                               data-bind="value:model.changeReason">
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-sm-4">
                                <div class="form-group">
                                    <label class="col-sm-4 control-label"><@spring.message "hmall.serviceorder.userid"/></label>
                                    <div class="col-sm-8">
                                        <input class="equalChild" data-role="maskedtextbox" placeholder='' style="width: 100%" type="text" data-bind="value:model.userId"
                                               name='<@spring.message "hmall.serviceorder.userid"/>' class="k-textbox" required>
                                    </div>
                                </div>
                            </div>
                            <div class="col-sm-4">
                                <div class="form-group">
                                    <label class="col-sm-4 control-label"><@spring.message "hmall.serviceorder.usergroup"/></label>
                                    <div class="col-sm-8">
                                        <input class="equalChild" data-role="maskedtextbox" placeholder='' style="width: 100%" type="text" data-bind="value:model.userGroup" class="k-textbox" required
                                               name='<@spring.message "hmall.serviceorder.usergroup"/>'>
                                    </div>
                                </div>
                            </div>
                            <div class="col-sm-4">
                                <div class="form-group">
                                    <label class="col-sm-4 control-label"><@spring.message "hmall.serviceorder.username"/></label>
                                    <div class="col-sm-8">
                                        <input class="equalChild" data-role="maskedtextbox" placeholder='' style="width: 100%" type="text" data-bind="value:model.name" class="k-textbox" required
                                               name='<@spring.message "hmall.serviceorder.username"/>'>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-sm-4">
                                <div class="form-group">
                                    <label class="col-sm-4 control-label"><@spring.message "hmall.serviceorder.mobile"/></label>
                                    <div class="col-sm-8">
                                        <input class="equalChild" data-role="maskedtextbox" placeholder='' style="width: 100%" type="text" data-bind="value:model.mobile" class="k-textbox" required
                                               name='<@spring.message "hmall.serviceorder.mobile"/>'>
                                    </div>
                                </div>
                            </div>
                            <div class="col-sm-4">
                                <div class="form-group">
                                    <label class="col-sm-4 control-label"><@spring.message "hmall.serviceorder.address"/></label>
                                    <div class="col-sm-8">
                                        <input class="equalChild" data-role="maskedtextbox" placeholder='' style="width: 100%" type="text" data-bind="value:model.address" class="k-textbox" required
                                               name='<@spring.message "hmall.serviceorder.address"/>'>
                                    </div>
                                </div>
                            </div>
                            <div class="col-sm-4">
                                <div class="form-group">
                                    <label class="col-sm-4 control-label"><@spring.message "hmall.serviceorder.oachangecode"/></label>
                                    <div class="col-sm-8">
                                        <input class="equalChild" data-role="maskedtextbox" placeholder='' style="width: 100%" type="text" data-bind="value:model.oaChangeCode" class="k-textbox"/>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-sm-4">
                                <div class="form-group">
                                    <label class="col-sm-4 control-label"><@spring.message "hmall.serviceorder.linkcode"/></label>
                                    <div class="col-sm-8">
                                        <input class="equalChild form-control" data-role="maskedtextbox" placeholder='' style="width: 100%" type="text" data-bind="value:model.linksCode"
                                               class="k-textbox" readonly>
                                    </div>
                                </div>
                            </div>
                            <div class="col-sm-4">
                                <div class="form-group">
                                    <label class="col-sm-4 control-label"><@spring.message "hmall.serviceorder.logisticsnumber"/></label>
                                    <div class="col-sm-8">
                                        <input class="equalChild" data-role="maskedtextbox" placeholder='' style="width: 100%" type="text" data-bind="value:model.logisticsNumber" class="k-textbox"
                                               name='<@spring.message "hmall.serviceorder.logisticsnumber"/>'>
                                    </div>
                                </div>
                            </div>
                            <div class="col-sm-4">
                                <div class="form-group">
                                    <label class="col-sm-4 control-label"><@spring.message "hmall.serviceorder.note"/></label>
                                    <div class="col-sm-8">
                                        <textarea class="equalChild" data-role="maskedtextbox" placeholder='' style="width: 100%" type="text" data-bind="value:model.note" class="k-textbox"></textarea>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-sm-4">
                                <div class="form-group">
                                    <label class="col-sm-4 control-label"><@spring.message "hmall.serviceorder.oldsalesorder"/></label>
                                    <div class="col-sm-8">
                                        <input class="equalChild form-control" data-role="maskedtextbox" placeholder='' style="width: 100%" type="text" data-bind="value:model.salesCode"
                                               class="k-textbox"
                                               readonly>
                                    </div>
                                </div>
                            </div>
                            <div class="col-sm-4">
                                <div class="form-group">
                                    <label class="col-sm-4 control-label"><@spring.message "hmall.serviceorder.issycretail"/></label>
                                    <div class="col-sm-8">
                                        <div id="syncflag" class="full_width" style="margin-top: 8px;" data-bind="enabled: true,value:model.syncflag"></div>
                                        <script type="text/javascript">
                                            $("#syncflag").kendoRadio({
                                                layout: '',//vertical
                                                readonly: false,
                                                items: [{
                                                    label: "是",
                                                    value: "Y"
                                                }, {
                                                    label: "否",
                                                    value: "N"
                                                }],
                                                change: function (e) {

                                                }
                                            }).data("kendoRadio");
                                        </script>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="panel-body" style="margin-top: 10px;border:1px solid #2F617F;">
                        <h5 style="margin-left: 10px;">其他信息</h5>
                        <div class="row">
                            <div class="col-sm-4">
                                <div class="form-group">
                                    <label class="col-sm-4 control-label"><@spring.message "hmall.serviceorder.cs"/></label>
                                    <div class="col-sm-8">
                                        <input id="cs" type="text" style="width: 100%" data-bind="value:model.cs" class="k-textbox form-control" readonly>
                                    </div>
                                </div>
                            </div>
                            <div class="col-sm-4">
                                <div class="form-group">
                                    <label class="col-sm-4 control-label"><@spring.message "hmall.serviceorder.creationDate"/></label>
                                    <div class="col-sm-8">
                                        <input id="creationDate" class="form-control" type="text" data-role="datetimepicker" style="width: 100%" data-bind="value:model.creationDate" readonly>
                                    </div>
                                </div>
                            </div>
                            <div class="col-sm-4">
                                <div class="form-group">
                                    <label class="col-sm-4 control-label"><@spring.message "hmall.serviceorder.finishTime"/></label>
                                    <div class="col-sm-8">
                                        <input id="finishTime" type="text" class="form-control" data-role="datetimepicker" style="width: 100%" data-bind="value:model.finishTime" readonly>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="panel-body" style="margin-top: 10px;border:1px solid #2F617F;">
                        <h5 style="margin-left: 10px;">差额信息</h5>
                        <span id class="btn btn-primary" style="margin-right:5px;" onclick="countPrice()">价格计算</span>
                        <span id class="btn btn-primary" style="margin-right:5px;" onclick="">退款</span>
                        <div class="row">
                            <div class="col-sm-4">
                                <div class="form-group">
                                    <label class="col-sm-4 control-label"><@spring.message "hmall.serviceorder.restorefee"/></label>
                                    <div class="col-sm-8">
                                        <input id="restoreFee" type="text" style="width: 100%" data-bind="value:model.restoreFee">
                                        <script>
                                            $("#restoreFee").kendoNumericTextBox({});
                                        </script>
                                    </div>
                                </div>
                            </div>
                            <div class="col-sm-4">
                                <div class="form-group">
                                    <label class="col-sm-4 control-label"><@spring.message "hmall.serviceorder.transfee"/></label>
                                    <div class="col-sm-8">
                                        <input id="transFee" type="text" style="width: 100%" data-bind="value:model.transFee">
                                        <script>
                                            $("#transFee").kendoNumericTextBox({});
                                        </script>
                                    </div>
                                </div>
                            </div>
                            <div class="col-sm-4">
                                <div class="form-group">
                                    <label class="col-sm-4 control-label"><@spring.message "hmall.serviceorder.changesum"/></label>
                                    <div class="col-sm-8">
                                        <input id="changeSum" class="k-textbox form-control" type="text" style="width: 100%" data-bind="value:model.changeSum" readonly>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-sm-4">
                                <div class="form-group">
                                    <label class="col-sm-4 control-label"><@spring.message "hmall.serviceorder.afterchangefee"/></label>
                                    <div class="col-sm-8">
                                        <input id="afterChangeFee" type="text" style="width: 100%" data-bind="value:model.afterChangeFee">
                                        <script>
                                            $("#afterChangeFee").kendoNumericTextBox({});
                                        </script>
                                    </div>
                                </div>
                            </div>
                            <div class="col-sm-4">
                                <div class="form-group">
                                    <label class="col-sm-4 control-label"><@spring.message "hmall.serviceorder.reorderfee"/></label>
                                    <div class="col-sm-8">
                                        <input id="reorderFee" type="text" style="width: 100%" data-bind="value:model.reorderFee">
                                        <script>
                                            $("#reorderFee").kendoNumericTextBox({});
                                        </script>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="panel-default" style="border-radius:0;border:1px solid #ccc;border-bottom:1px solid rgba(0, 0, 0, 0.17);margin-bottom:0px; height: 450px;">
                <div class="panel-heading">
                    <span class="panel-title" style="float:left;margin-left:10px;margin-right:5px;padding: 0px;">服务单行--退货行</span>
                </div>
                <div style="clear:both;margin-top:10px;height:50px;">
                    <span class="btn btn-primary" style="float:left;width:70px;margin-right:5px;" onclick="selectSwapReturnOrder();" type="submit"><@spring.message "hap.add"/></span>
                    <span class="btn btn-primary" style="float:left;width:70px;margin-right:5px;" onclick="deleteSwapReturnOrder();" type="reset"><@spring.message "hap.delete"/></span>
                </div>
                <div>
                    <div id="returnOrderEntryGird"></div>
                </div>
            </div>
            <div class="panel-default" style="border-radius:0;border:1px solid #ccc;border-bottom:1px solid rgba(0, 0, 0, 0.17);margin-top:10px; height: 450px;">
                <div class="panel-heading">
                    <span class="panel-title" style="float:left;margin-left:10px;margin-right:5px;padding: 0px;">服务单行--换货行</span>
                </div>
                <div style="clear:both;margin-top:10px;height:50px;">
                    <span class="btn btn-primary" style="float:left;width:70px;margin-right:5px;" onclick="selectSwapChangeOrder();" type="submit"><@spring.message "hap.add"/></span>
                    <span class="btn btn-primary" style="float:left;width:70px;margin-right:5px;" onclick="deleteSwapChangeOrder();" type="reset"><@spring.message "hap.delete"/></span>
                </div>
                <div>
                    <div id="changeOrderEntryGird"></div>
                </div>
            </div>
        </div>
        <div id="returnSwapOrderEntryDialogEdit" style="display:none;"></div>
        <div id="changeSwapOrderEntryDialogEdit" style="display:none;"></div>
        <script type="text/javascript">
            var allReturnSwapOrderEntries = [];//所有退货单行
            var allChangeSwapOrderEntries = [];//所有换货单行
            kendo.bind($('#page-content'), viewModel);
            $("#appointment_date").kendoDateTimePicker({
                animation: {
                    close: {
                        effects: "fadeOut zoom:out",
                        duration: 300
                    },
                    open: {
                        effects: "fadeIn zoom:in",
                        duration: 300
                    }
                },
                format: "yyyy-MM-dd HH:mm:ss",
                change: function () {
                    var appointmentDate = $("#appointment_date").val();
                    var executionDate = $("#execution_date").data("kendoDateTimePicker");
                    executionDate.min(appointmentDate || new Date(1800, 0, 1));
                }
            });
            $("#execution_date").kendoDateTimePicker({
                animation: {
                    close: {
                        effects: "fadeOut zoom:out",
                        duration: 300
                    },
                    open: {
                        effects: "fadeIn zoom:in",
                        duration: 300
                    }
                },
                format: "yyyy-MM-dd HH:mm:ss",
                change: function () {
                    var executionDate = $("#execution_date").val();
                    var appointmentDate = $("#appointment_date").data("kendoDateTimePicker");
                    appointmentDate.max(executionDate || new Date(2099, 11, 31));
                }
            });

            //同步到retail
            function syncRetail() {
                alert("开发中");
            }

            var returnOrderEntryGird = $("#returnOrderEntryGird").kendoGrid({
                height: "350px",
                rownumber: true,
                resizable: true,
                navigatable: true,
                scrollable: true,
                selectable: 'multiple, rowbox',
                sortable: true,
                pageable: {
                    pageSizes: [5, 10, 20, 50],
                    refresh: true,
                    buttonCount: 10
                },
                columns: [
                    {
                        field: "consignmentId",
                        title: '原配货单号',
                        width: 120,
                        editor: function (container, options) {
                            container.html(options.model.consignmentId);
                            container.removeClass('k-edit-cell');
                        },
                        headerAttributes: {
                            "class": "table-header-cell",
                            style: "text-align: center"
                        },
                        attributes: {
                            style: "text-align:center"
                        }
                    }, {
                        field: "lineNumber",
                        title: '原订单行号',
                        width: 120,
                        editor: function (container, options) {
                            container.html(options.model.lineNumber);
                            container.removeClass('k-edit-cell');
                        },
                        headerAttributes: {
                            "class": "table-header-cell",
                            style: "text-align: center"
                        },
                        attributes: {
                            style: "text-align:center"
                        }
                    }, {
                        field: "productCode",
                        title: '产品编号',
                        width: 120,
                        editor: function (container, options) {
                            container.html(options.model.productCode);
                            container.removeClass('k-edit-cell');
                        },
                        headerAttributes: {
                            "class": "table-header-cell",
                            style: "text-align: center"
                        },
                        attributes: {
                            style: "text-align:center"
                        }
                    }, {
                        field: "name",
                        title: '产品描述',
                        width: 120,
                        editor: function (container, options) {
                            container.html(options.model.name);
                            container.removeClass('k-edit-cell');
                        },
                        headerAttributes: {
                            "class": "table-header-cell",
                            style: "text-align: center"
                        },
                        attributes: {
                            style: "text-align:center"
                        }
                    }, {
                        field: "basePrice",
                        title: '销售价格',
                        width: 80,
                        editor: function (container, options) {
                            container.html(options.model.basePrice);
                            container.removeClass('k-edit-cell');
                        },
                        headerAttributes: {
                            "class": "table-header-cell",
                            style: "text-align: center"
                        },
                        attributes: {
                            style: "text-align:center"
                        }
                    }, {
                        field: "quantity",
                        title: '数量',
                        width: 80,
                        editor: function (container, options) {
                            container.html(options.model.quantity);
                            container.removeClass('k-edit-cell');
                        },
                        headerAttributes: {
                            "class": "table-header-cell",
                            style: "text-align: center"
                        },
                        attributes: {
                            style: "text-align:center"
                        }
                    }, {
                        field: "unitFee",
                        title: '实际销售金额',
                        format: "{0:n2}",
                        width: 100,
                        editor: function (container, options) {
                            container.html(options.model.unitFee);
                            container.removeClass('k-edit-cell');
                        },
                        headerAttributes: {
                            "class": "table-header-cell",
                            style: "text-align: center"
                        },
                        attributes: {
                            style: "text-align:center"
                        }
                    }, {
                        field: "returnReason1",
                        title: '<@spring.message "hmall.orderentry.returnReason1"/>',
                        attributes: {style: "text-align:center"},
                        width: 150,
                        headerAttributes: {
                            "class": "table-header-cell",
                            style: "text-align: center"
                        },
                        attributes: {
                            style: "text-align:center"
                        }
                    }, {
                        field: "returnReason2",
                        title: '<@spring.message "hmall.orderentry.returnReason2"/>',
                        attributes: {style: "text-align:center"},
                        width: 150,
                        headerAttributes: {
                            "class": "table-header-cell",
                            style: "text-align: center"
                        },
                        attributes: {
                            style: "text-align:center"
                        }
                    }, {
                        field: "note",
                        title: '<@spring.message "hmall.serviceorder.note"/>',
                        attributes: {style: "text-align:center"},
                        width: 130,
                        headerAttributes: {
                            "class": "table-header-cell",
                            style: "text-align: center"
                        },
                        attributes: {
                            style: "text-align:center"
                        }
                    }],
                editable: true
            }).data("kendoGrid");

            //选择退货单行页面
            function selectSwapReturnOrder() {
                var dialog = $("#returnSwapOrderEntryDialogEdit").kendoWindow({
                    width: 800,
                    height: 400,
                    title: '添加换货单退货行',
                    visible: false,
                    iframe: true,
                    modal: true,
                    content: "${base.contextPath}/as/as_return_swap_order_entry_add.html?serviceOrderId=" + serviceOrderId
                }).data("kendoWindow");
                dialog.center();
                dialog.open();
            }

            //获取当前退货单下所有退货单行
            function getAllReturnSwapOrderList() {
                $.ajax({
                    type: 'GET',
                    url: "${base.contextPath}/hmall/as/order/serviceorderEntry/queryServiceOrderInfo?serviceOrderId=" + receiptOrderId,
                    dataType: 'JSON',
                    success: function (result) {
                        for (var i in result.rows) {
                            allReturnSwapOrderEntries.push(result.rows[i]);
                        }
                        refreshReturnSwapOrderEntryGrid();
                    },
                    error: function (data) {
                    }
                });
            }

            //刷新退货单行grid
            function refreshReturnSwapOrderEntryGrid() {
                var _dataSource_ = new kendo.data.DataSource({
                    data: allReturnSwapOrderEntries,
                    schema: {
                        model: {
                            id: "serviceOrderEntryId",
                            fields: {}
                        }
                    }
                });
                returnOrderEntryGird.setDataSource(_dataSource_);
            }

            //选择退货单行调用
            function chooseSwapReturn(selections) {
                for (var i in selections) {
                    var obj = copyObject(selections[i]);
                    obj.serviceOrderEntryId = null;
                    obj.serviceOrderId = null;
                    allReturnSwapOrderEntries.push(obj);
                }
                refreshReturnSwapOrderEntryGrid();
            }

            //删除退货单行表格数据
            function deleteSwapReturnOrder() {
                kendo.ui.showConfirmDialog({
                    title: $l('hap.tip.info'),
                    message: $l('是否删除选择的换货单行？')
                }).done(function (event) {
                    if (event.button == 'OK') {
                        var selections = returnOrderEntryGird.selectedDataItems();
                        for (var i in allReturnSwapOrderEntries) {
                            for (var j in selections) {
                                if (allReturnSwapOrderEntries[i].productId == selections[j].productId) {
                                    allReturnSwapOrderEntries.splice(jQuery.inArray(allReturnSwapOrderEntries[i], allReturnSwapOrderEntries), 1);
                                }
                            }
                        }
                        $.ajax({
                            url: "${base.contextPath}/hmall/as/serviceorder/deleteServiceOrderEntry",
                            type: 'post',
                            dataType: 'json',
                            contentType: "application/json",
                            async: false,
                            data: JSON.stringify(selections),
                            success: function (result) {
                                if ("success" == result) {
                                    kendo.ui.showInfoDialog({
                                        message: "删除成功"
                                    });
                                }
                            }
                        });
                        refreshReturnSwapOrderEntryGrid();
                    }
                });
            }

            var changeOrderEntryGird = $("#changeOrderEntryGird").kendoGrid({
                height: "350px",
                rownumber: true,
                resizable: true,
                navigatable: true,
                scrollable: true,
                selectable: 'multiple, rowbox',
                sortable: true,
                pageable: {
                    pageSizes: [5, 10, 20, 50],
                    refresh: true,
                    buttonCount: 10
                },
                columns: [
                    {
                        field: "productCode",
                        title: '产品编号',
                        width: 120,
                        editor: function (container, options) {
                            container.html(options.model.productCode);
                            container.removeClass('k-edit-cell');
                        },
                        headerAttributes: {
                            "class": "table-header-cell",
                            style: "text-align: center"
                        },
                        attributes: {
                            style: "text-align:center"
                        }
                    }, {
                        field: "name",
                        title: '产品描述',
                        width: 120,
                        editor: function (container, options) {
                            container.html(options.model.name);
                            container.removeClass('k-edit-cell');
                        },
                        headerAttributes: {
                            "class": "table-header-cell",
                            style: "text-align: center"
                        },
                        attributes: {
                            style: "text-align:center"
                        }
                    }, {
                        field: "basePrice",
                        title: '销售价格',
                        width: 80,
                        editor: function (container, options) {
                            container.html(options.model.basePrice);
                            container.removeClass('k-edit-cell');
                        },
                        headerAttributes: {
                            "class": "table-header-cell",
                            style: "text-align: center"
                        },
                        attributes: {
                            style: "text-align:center"
                        }
                    }, {
                        field: "quantity",
                        title: '数量',
                        width: 80,
                        headerAttributes: {
                            "class": "table-header-cell",
                            style: "text-align: center"
                        },
                        attributes: {
                            style: "text-align:center"
                        }
                    }, {
                        field: "unitFee",
                        title: '实际销售金额',
                        format: "{0:n2}",
                        width: 100,
                        headerAttributes: {
                            "class": "table-header-cell",
                            style: "text-align: center"
                        },
                        attributes: {
                            style: "text-align:center"
                        }
                    }, {
                        field: "estimateDeliveryTime",
                        title: '<@spring.message "hmall.orderentry.estimateDeliveryTime"/>',
                        attributes: {style: "text-align:center"},
                        width: 150,
                        headerAttributes: {
                            "class": "table-header-cell",
                            style: "text-align: center"
                        },
                        format: "{0:yyyy-MM-dd hh:mm:ss}",
                        editor: function (container, options) {
                            $('<input required name="' + options.field + '"/>')
                                    .appendTo(container)
                                    .kendoDatePicker({
                                        open: function (e) {
                                        }
                                    });
                        }
                    }, {
                        field: "note",
                        title: '<@spring.message "hmall.serviceorder.note"/>',
                        attributes: {style: "text-align:center"},
                        width: 130,
                        headerAttributes: {
                            "class": "table-header-cell",
                            style: "text-align: center"
                        }
                    }],
                editable: true
            }).data("kendoGrid");

            //选择换货单行页面
            function selectSwapChangeOrder() {
                var dialog = $("#changeSwapOrderEntryDialogEdit").kendoWindow({
                    width: 800,
                    height: 400,
                    title: '添加换货单退货行',
                    visible: false,
                    iframe: true,
                    modal: true,
                    content: "${base.contextPath}/as/as_change_swap_order_entry_add.html?serviceOrderId=" + serviceOrderId
                }).data("kendoWindow");
                dialog.center();
                dialog.open();
            }

            //获取当前换货单下所有换货单行
            function getAllChangeSwapOrderList() {
                $.ajax({
                    type: 'GET',
                    url: "${base.contextPath}/hmall/as/order/serviceorderEntry/queryServiceOrderInfo?serviceOrderId=" + receiptOrderId,
                    dataType: 'JSON',
                    success: function (result) {
                        for (var i in result.rows) {
                            allChangeSwapOrderEntries.push(result.rows[i]);
                        }
                        refreshChangeSwapOrderEntryGrid();
                    },
                    error: function (data) {
                    }
                });
            }

            //刷新换货单行grid
            function refreshChangeSwapOrderEntryGrid() {
                var _dataSource_ = new kendo.data.DataSource({
                    data: allChangeSwapOrderEntries,
                    schema: {
                        model: {
                            id: "serviceOrderEntryId",
                            fields: {}
                        }
                    }
                });
                changeOrderEntryGird.setDataSource(_dataSource_);
            }

            //选择换货单行调用
            function chooseSwapChange(selections) {
                for (var i in selections) {
                    var obj = copyObject(selections[i]);
                    obj.serviceOrderEntryId = null;
                    obj.serviceOrderId = null;
                    obj.productCode = selections[i].code;
                    allChangeSwapOrderEntries.push(obj);
                }
                refreshChangeSwapOrderEntryGrid();
            }

            //删除换货单行表格数据
            function deleteSwapChangeOrder() {
                kendo.ui.showConfirmDialog({
                    title: $l('hap.tip.info'),
                    message: $l('是否删除选择的换货单行？')
                }).done(function (event) {
                    if (event.button == 'OK') {
                        var selections = changeOrderEntryGird.selectedDataItems();
                        for (var i in allChangeSwapOrderEntries) {
                            for (var j in selections) {
                                if (allChangeSwapOrderEntries[i].productId == selections[j].productId) {
                                    allChangeSwapOrderEntries.splice(jQuery.inArray(allChangeSwapOrderEntries[i], allChangeSwapOrderEntries), 1);
                                }
                            }
                        }
                        $.ajax({
                            url: "${base.contextPath}/hmall/as/serviceorder/deleteServiceOrderEntry",
                            type: 'post',
                            dataType: 'json',
                            contentType: "application/json",
                            async: false,
                            data: JSON.stringify(selections),
                            success: function (result) {
                                if ("success" == result) {
                                    kendo.ui.showInfoDialog({
                                        message: "删除成功"
                                    });
                                }
                            }
                        });
                        refreshChangeSwapOrderEntryGrid();
                    }
                });
            }

            //根据receiptOrderId判断是新建还是编辑
            if (receiptOrderId != 0) {
                //获取取回单信息
                $.ajax({
                    type: 'POST',
                    url: '${base.contextPath}/hmall/as/retrieveOrder/selectRetrieveOrderById?receiptOrderId=' + receiptOrderId,
                    dataType: "json",
                    contentType: "application/json",
                    success: function (data) {
                        if (data.success) {
                            var a0 = data.rows[0] || {};
                            for (var k in a0) {
                                viewModel.model.set(k, a0[k]);
                            }
                        }
                    }
                });
                getAllReturnSwapOrderList();
                getAllChangeSwapOrderList();
            } else {
                //获取用户信息
                $.ajax({
                    type: 'POST',
                    url: '${base.contextPath}/hmall/as/retrieveOrder/selectUserInfoByOrderId?salesCode=' + orderCode,
                    dataType: "json",
                    contentType: "application/json",
                    success: function (data) {
                        if (data.success) {
                            var a0 = data.rows[0] || {};
                            for (var k in a0) {
                                viewModel.model.set(k, a0[k]);
                            }
                            viewModel.model.set("linksCode", linksCode);
                            viewModel.model.set("orderCode", orderCode);
                            viewModel.model.set("receiptType", receiptType);
                        }
                    }
                });

            }
            //保存
            function saveServiceOrder() {
                var data = viewModel.model.toJSON();
                //退货行
                var returnOrderEntries = returnOrderEntryGird.dataSource._data;
                data.returnOrderEntries = returnOrderEntries;
                //换货行
                var changeOrderEntries = changeOrderEntryGird.dataSource._data;
                data.changeOrderEntries = changeOrderEntries;

                var validator = $("#forms").kendoValidator().data("kendoValidator");
                if (validator.validate()) {
                    $.ajax({
                        url: "${base.contextPath}/hmall/as/swapOrder/saveSwapOrder",
                        type: "POST",
                        dataType: "json",
                        contentType: "application/json",
                        data: kendo.stringify([data]),
                        error: function (request) {
                            alert("Connection error");
                        },
                        success: function (data) {
                            if (data != null) {
                                $('#code').val(data.code);
                                viewModel.model.set("code", data.code);
                                viewModel.model.set("receiptOrderId", data.receiptOrderId);
                                receiptOrderId = data.receiptOrderId;
                                kendo.ui.showInfoDialog({
                                    message: "<@spring.message 'hmall.save.success'/>"
                                });
                            }
                        }
                    });
                }
            }

            //计算价格
            function countPrice() {
                var restoreFee = viewModel.model.get("restoreFee");
                var transFee = viewModel.model.get("transFee");
                var afterChangeFee = viewModel.model.get("afterChangeFee");
                var reorderFee = viewModel.model.get("reorderFee");
                var changeSum = Number(restoreFee) + Number(transFee) + Number(afterChangeFee) - Number(reorderFee);
                $('#changeSum').val(changeSum);
                viewModel.model.set("changeSum", changeSum);
            }

            //循环遍历选中的行，将String number 类型保留
            function copyObject(source) {
                var result = {};
                for (var key in source) {
                    if (typeof source[key] == "string" || typeof source[key] == "number")
                        result[key] = source[key];
                }
                return result;
            }
        </script>
        <!-- 选择商品 -->
        <div id="selectProduct"></div>
        </body>
        </html>