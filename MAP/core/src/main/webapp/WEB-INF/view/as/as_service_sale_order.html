<#--
        * description: 服务销售单详情页面
        * author:zhangzilong
        * 2017/7/17
        * version: 0.1
        --></#-->
<#include "../include/header.html" />
<script src="${base.contextPath}/common/code?serviceOrderStatus=HMALL.AS.SVSALES.STATUS" type="text/javascript"></script>
<script src="${base.contextPath}/common/code?chargeTypeCode=HMALL.AS.CHARGE_TYPE" type="text/javascript"></script>
<script type="text/javascript">
    //服务单ID
    var serviceOrderId = "${RequestParameters.serviceOrderId!0}";
    //服务单单号
    var serviceOrderCode = "${RequestParameters.serviceOrderCode!0}";
    //订单单号
    var orderCode = "${RequestParameters.orderCode!0}";
    //订单ID
    var orderId = "${RequestParameters.orderId!0}";
    //服务销售单ID
    var asSvsalesId = "${RequestParameters.receiptOrderId!0}";
    /**
     * 页面上半部分form绑定对象
     */
    var viewModel = kendo.observable({
        model: {},
        resetForm: function (event) {
        }
    });

    //初始化页面数据
    $(function () {
        if (asSvsalesId != 0) {
            $.ajax({
                type: 'GET',
                url: '${base.contextPath}/hmall/as/servicesaleorder/queryBySvsalesId?asSvsalesId=' + asSvsalesId,
                dataType: "json",
                contentType: "application/json",
                async: false,
                success: function (data) {
                    if (data.success) {
                        var a0 = data.resp[0] || {};
                        for (var k in a0) {
                            viewModel.model.set(k, a0[k]);
                        }
                        if (viewModel.model.status == "NEW") {
                            $("#newEntry").css("display", "inline-block");
                            $("#deleteEntry").css("display", "inline-block");
                            $("#buttonAmountConfirm").css("display", "inline-block");
                            $("#buttonCancelOrder").css("display", "inline-block");
                        }
                        if (viewModel.model.status == "CANC") {
                            changeReadonly();
                            $("#buttonCancelOrder").css("display", "NONE");
                            $("#buttonSyncRetail").css("display", "NONE");
                        }
                        if (viewModel.model.status == "PROC") {
                            changeReadonly();
                            $("#buttonCancelOrder").css("display", "inline-block");
                        }
                        if (viewModel.model.status == "FINI") {
                            changeReadonly();
                            $("#buttonCancelOrder").css("display", "NONE");
                            if (viewModel.model.syncflag == 'N'){
                                $("#buttonSyncRetail").css("display", "inline-block");
                            }
                        }
                    }
                }
            });
        } else {
            $.ajax({
                type: 'GET',
                url: '${base.contextPath}/hmall/as/servicesaleorder/newSvsale?serviceOrderId=' + serviceOrderId,
                dataType: "json",
                contentType: "application/json",
                async: false,
                success: function (data) {
                    if (data.success) {
                        var a0 = data.resp[0] || {};
                        for (var k in a0) {
                            viewModel.model.set(k, a0[k]);
                        }
                    }
                }
            });
        }
    });

    var orderEntryViewModel = kendo.observable({
        model: {}
    });

    function validateGrid() {
        selectedOrderEntries = $("#orderEntryGrid").data("kendoGrid").dataSource._data;
        for (var i = 0; i < selectedOrderEntries.length; i++) {
            if (!selectedOrderEntries[i].chargeType) {
                var a = parseInt(i) + 1;
                kendo.ui.showInfoDialog({
                    message: "第" + a + "行收费项目为空。"
                });
                return false;
            }
            if (!selectedOrderEntries[i].unitFee) {
                var a = parseInt(i) + 1;
                kendo.ui.showInfoDialog({
                    message: "第" + a + "行实际单价为空。"
                });
                return false;
            }
        }
        return true;
    }
    //服务单保存
    function saveServiceOrder() {
        var validator = $("#myForm").kendoValidator().data("kendoValidator");
        var gridValidator = $('#orderEntryGrid').kendoValidator().data("kendoValidator");
        var grid = $("#orderEntryGrid").data("kendoGrid");
        var gridData = grid._data;
        debugger;
        for (var i = 0; i < $("#orderEntryGrid").data("kendoGrid").dataSource._data.length; i++) {
            $("#orderEntryGrid").data("kendoGrid").dataSource._data[i].__status = "";
        }
        viewModel.model.svsalesEntries = $.extend(gridData, deletedEntries);
        var data = viewModel.model.toJSON();
        if (validator.validate() && gridValidator.validate() && validateGrid()) {
            $.ajax({
                url: BaseUrl + "/hmall/as/svsales/saveSvsales",
                type: "POST",
                dataType: "json",
                contentType: "application/json",
                data: kendo.stringify([data]),
                error: function (request) {
                    alert("Connection error");
                },
                success: function (data) {
                    if (data.success) {
                        var a0 = data.resp[0] || {};
                        for (var k in a0) {
                            viewModel.model.set(k, a0[k]);
                        }
                        selectedOrderEntries = [];
                        for (var i in gridData) {
                            selectedOrderEntries.push(gridData[i]);
                        }
                        kendo.ui.showInfoDialog({
                            message: "<@spring.message 'hap.tip.success'/>"
                        })
//                        serviceSaleOrder(data.resp[0]["asSvsalesId"]);
                    } else {
                        kendo.ui.showInfoDialog({
                            message: "操作失败。"
                        })
                    }
                    asSvsalesId = viewModel.model.asSvsalesId;
                    initGrid();
                    deletedEntries = [];
                    if (viewModel.model.status == "PROC") {
                        changeReadonly();
                        $("#buttonCancelOrder").css("display", "inline-block");
                    }
                    if (viewModel.model.status == "FINI") {
                        changeReadonly();
                        $("#buttonCancelOrder").css("display", "NONE");
                        if (viewModel.model.syncflag == "N") {
                            $("#buttonSyncRetail").css("display", "inline-block");
                        }
                    }
                    if (viewModel.model.status == "NEW") {
                        $("#newEntry").css("display", "inline-block");
                        $("#deleteEntry").css("display", "inline-block");
                        $("#buttonAmountConfirm").css("display", "inline-block");
                        $("#buttonCancelOrder").css("display", "inline-block");
                    }
                }
            });
        }
    }
    function serviceSaleOrder(asSvsalesId) {
        var url = BaseUrl + "/as/as_service_sale_order.html?receiptOrderId=" + asSvsalesId;
        window.location.href = url;
    }
    function syncToRetail() {
        kendo.ui.showConfirmDialog({
            title: $l('hap.tip.info'),
            message: "同步至Retail之前请先保存，确定开始同步吗？"
        }).done(function (event) {
            if (event.button == 'OK') {
                if (asSvsalesId != null) {
                    $.ajax({
                        type: 'POST',
                        url: "${base.contextPath}/hmall/as/serviceSaleOrder/syncRetail?asSvsalesId=" + asSvsalesId,
                        dataType: "json",
                        contentType: "application/json",
                        success: function (data) {
                            if (data.success) {
                                viewModel.model.set("syncflag", "Y");
                                $("#buttonSyncRetail").css("display", "NONE");
                                viewModel.model.set("sapCode",data.msgCode);
                                kendo.ui.showInfoDialog({
                                    message: data.msg
                                });
                            } else {
                                kendo.ui.showInfoDialog({
                                    message: data.msg
                                });
                            }
                        },
                        error: function (data) {
                        }
                    });
                } else {
                    kendo.ui.showInfoDialog({
                        message: "请先保存当前服务销售单。"
                    });
                }
            }
        })
    }

    function amountConfirm() {
        kendo.ui.showConfirmDialog({
            title: $l('hap.tip.info'),
            message: "请先确定此单据是否已保存，如未保存请点击取消先执行保存。"
        }).done(function (event) {
            if (event.button == 'OK') {
                var validator = $("#myForm").kendoValidator().data("kendoValidator");
                var gridValidator = $('#orderEntryGrid').kendoValidator().data("kendoValidator");
                var grid = $("#orderEntryGrid").data("kendoGrid");
                var gridData = grid._data;
                viewModel.model.svsalesEntries = $.extend(gridData, deletedEntries);
                var data = viewModel.model.toJSON();
                if (validator.validate() && gridValidator.validate()) {
                    $.ajax({
                        url: BaseUrl + "/hmall/as/svsales/amountConfirm",
                        type: "POST",
                        dataType: "json",
                        contentType: "application/json",
                        data: kendo.stringify([data]),
                        error: function (request) {
                            alert("Connection error");
                        },
                        success: function (data) {
                            if (data.success) {
                                viewModel.model.set("status", "PROC");
                                changeReadonly();
                                refreshOrderEntryGrid();
                                kendo.ui.showInfoDialog({
                                    message: "<@spring.message 'hap.tip.success'/>"
                                })
                            } else {
                                kendo.ui.showInfoDialog({
                                    message: "操作失败。"
                                })
                            }
                        }
                    });
                }
            }
        })
    }
    function cancelOrder() {
        kendo.ui.showConfirmDialog({
            title: $l('hap.tip.info'),
            message: "确定取消此服务销售单吗？"
        }).done(function (event) {
            if (event.button == 'OK') {
                var validator = $("#myForm").kendoValidator().data("kendoValidator");
                var gridValidator = $('#orderEntryGrid').kendoValidator().data("kendoValidator");
                var grid = $("#orderEntryGrid").data("kendoGrid");
                var gridData = grid._data;
                viewModel.model.svsalesEntries = $.extend(gridData, deletedEntries);
                var data = viewModel.model.toJSON();
                if (validator.validate() && gridValidator.validate()) {
                    $.ajax({
                        url: BaseUrl + "/hmall/as/svsales/cancelOrder",
                        type: "POST",
                        dataType: "json",
                        contentType: "application/json",
                        data: kendo.stringify([data]),
                        error: function (request) {
                            alert("Connection error");
                        },
                        success: function (data) {
                            if (data.success) {
                                viewModel.model.set("status", "CANC");
                                changeReadonly();
                                $("#buttonCancelOrder").css("display", "NONE");
                                $("#buttonSyncRetail").css("display", "NONE");
                                kendo.ui.showInfoDialog({
                                    message: "<@spring.message 'hap.tip.success'/>"
                                })
                            } else {
                                kendo.ui.showInfoDialog({
                                    message: "操作失败。"
                                })
                            }
                        }

                    });
                }
            }
        })
    }
    function changeReadonly() {
        $("#newEntry").css("display", "NONE");
        $("#deleteEntry").css("display", "NONE");
        $("#buttonAmountConfirm").css("display", "NONE");
        $("#orderEntryGrid").data("kendoGrid").setOptions({editable: false, dataSource: selectedOrderEntries});
    }
</script>
<body>
<div id="content-container" style="width:1300px;">
    <!-- 头部按钮 -->
    <span onclick="saveServiceOrder()" class="btn btn-success" style="margin-left:25px; margin-top: 10px;"><@spring.message "hap.save"/></span>
    <span onclick="syncToRetail()" class="btn btn-success" id="buttonSyncRetail" style="margin-left:25px; margin-top: 10px;display: NONE">同步至Retail</span>
    <span onclick="amountConfirm()" class="btn btn-success" id="buttonAmountConfirm" style="margin-left:25px; margin-top: 10px;display: NONE">金额确认</span>
    <span onclick="cancelOrder()" class="btn btn-success" id="buttonCancelOrder" style="margin-left:25px; margin-top: 10px;display: NONE">取消订单</span>
    <div id="page-content" style="height: 170px;">
        <div class="panel" style="padding: 0px;border:none;box-shadow: none;">
            <form class="form-horizontal" id="myForm">
                <input type="hidden" name="asSvsalesId" id="asSvsalesId" data-bind="value:model.asSvsalesId">
                <input type="hidden" name="orderId" id="orderId" data-bind="value:model.orderId">
                <input type="hidden" name="serviceOrderId" id="serviceOrderId" data-bind="value:model.serviceOrderId">
                <div class="panel-body" style="margin-top: 10px;border:1px solid #2F617F;">
                    <div class="row">
                        <h5 style="margin-left: 10px;">基本信息</h5>
                    </div>
                    <div class="row">
                        <!-- 销售服务单单号 -->
                        <div class="col-sm-4">
                            <div class="form-group">
                                <label class="col-sm-3 control-label" style="text-align:left"><@spring.message "hmall.serviceorder.saleserviceordercode"/></label>
                                <div class="col-sm-8">
                                    <input id='code' type="text" style="width: 100%"
                                           data-bind="value:model.code" class="k-textbox form-control" readonly>
                                </div>
                            </div>
                        </div>
                        <!-- 支付状态 -->
                        <div class="col-sm-4">
                            <div class="form-group">
                                <label class="col-sm-3 control-label" style="text-align:left"><@spring.message "hmall.serviceorder.paystatus"/></label>
                                <div class="col-sm-8">
                                    <input id="payStatus" type="text" style="width: 100%" data-bind="value:model.payStatus" class="form-control" readonly>
                                    <script type="text/javascript">
                                        $("#payStatus").kendoDropDownList({
                                            dataTextField: "meaning",
                                            dataValueField: "value",
                                            valuePrimitive: true,
                                            dataSource: {
                                                data: [{meaning: "未支付", value: "N"},
                                                    {meaning: "已支付", value: "Y"}]
                                            }
                                        }).data("kendoDropDownList");
                                    </script>
                                </div>
                            </div>
                        </div>
                        <!-- 单据类型
                        <div class="col-sm-4">
                            <div class="form-group">
                                <label class="col-sm-3 control-label" style="text-align:left"><@spring.message "hmall.serviceorder.receiptType"/></label>
                                <div class="col-sm-8">
                                    <input id="orderType" type="text" style="width: 100%;height: 2.5em; margin-right: 5px;" name="receiptType"
                                           data-bind="value:model.receiptType" readonly required>
                                    <script type="text/javascript">
                                        $("#orderType").kendoDropDownList({
                                            dataTextField: "meaning",
                                            dataValueField: "value",
                                            valuePrimitive: true,
                                            dataSource: receiptType
                                        }).data("kendoDropDownList");
                                    </script>
                                </div>
                            </div>
                        </div>-->
                        <!-- 状态 -->
                        <div class="col-sm-4">
                            <div class="form-group">
                                <label class="col-sm-3 control-label" style="text-align:left"><@spring.message "hmall.user_status"/></label>
                                <div class="col-sm-8">
                                    <input type="text" style="width: 100%;height: 2.5em; margin-right: 5px;" id="status" class="form-control"
                                           data-bind="value:model.status" readonly>
                                    <script type="text/javascript">
                                        $("#status").kendoDropDownList({
                                            dataTextField: "meaning",
                                            dataValueField: "value",
                                            valuePrimitive: true,
                                            dataSource: serviceOrderStatus
                                        }).data("kendoDropDownList");
                                    </script>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <!-- 客户ID -->
                        <div class="col-sm-4">
                            <div class="form-group">
                                <label class="col-sm-3 control-label" style="text-align:left"><@spring.message "hmall.serviceorder.customerid"/></label>
                                <div class="col-sm-8">
                                    <input id="customerId" type="text" style="width: 100%"
                                           data-bind="value:model.customerId" class="k-textbox" readonly/>
                                </div>
                            </div>
                        </div>
                        <!-- 客户名称 -->
                        <div class="col-sm-4">
                            <div class="form-group">
                                <label class="col-sm-3 control-label" style="text-align:left"><@spring.message "hmall.serviceorder.username"/></label>
                                <div class="col-sm-8">
                                    <input id="name" type="text" style="width: 100%"
                                           data-bind="value:model.name" class="k-textbox" required/>
                                </div>
                            </div>
                        </div>
                        <!-- 用户组 -->
                        <div class="col-sm-4">
                            <div class="form-group">
                                <label class="col-sm-3 control-label" style="text-align:left"><@spring.message "hmall.serviceorder.usergroup"/></label>
                                <div class="col-sm-8">
                                    <input id="userGroup" type="text" style="width: 100%"
                                           data-bind="value:model.userGroup" class="k-textbox" readonly/>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <!-- 手机号 -->
                        <div class="col-sm-4">
                            <div class="form-group">
                                <label class="col-sm-3 control-label" style="text-align:left"><@spring.message "hmall.serviceorder.mobile"/></label>
                                <div class="col-sm-8">
                                    <input id="mobile" type="text" style="width: 100%" data-bind="value:model.mobile" class="k-textbox" required>
                                </div>
                            </div>
                        </div>
                        <!-- 客户地址 -->
                        <div class="col-sm-4">
                            <div class="form-group">
                                <label class="col-sm-3 control-label" style="text-align:left"><@spring.message "hmall.serviceorder.address"/></label>
                                <div class="col-sm-8">
                                    <input id="address" type="text" style="width: 100%" data-bind="value:model.address" class="k-textbox" required>
                                </div>
                            </div>
                        </div>
                        <!-- 备注 -->
                        <div class="col-sm-4">
                            <div class="form-group">
                                <label class="col-sm-3 control-label" style="text-align:left"><@spring.message "hmall.serviceorder.note"/></label>
                                <div class="col-sm-8">
                                    <input id="note" type="text" style="width: 100%" data-bind="value:model.note" class="k-textbox">
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <!-- 服务单单号 -->
                        <div class="col-sm-4">
                            <div class="form-group">
                                <label class="col-sm-3 control-label" style="text-align:left"><@spring.message "hmall.serviceorder.linkcode"/></label>
                                <div class="col-sm-8">
                                    <input id="linkCode" type="text" style="width: 100%" data-bind="value:model.linkCode" class="k-textbox form-control" readonly>
                                </div>
                            </div>
                        </div>
                        <!-- 原销售订单单号 -->
                        <div class="col-sm-4">
                            <div class="form-group">
                                <label class="col-sm-3 control-label" style="text-align:left"><@spring.message "hmall.serviceorder.escOrderCode"/></label>
                                <div class="col-sm-8">
                                    <input id="escOrderCode" type="text" style="width: 100%" data-bind="value:model.escOrderCode" class="k-textbox form-control" readonly>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <!-- 是否同步Retail -->
                        <div class="col-sm-4">
                            <div class="form-group">
                                <label class="col-sm-3 control-label" style="text-align:left"><@spring.message "hmall.serviceorder.issycretail"/></label>
                                <div class="col-sm-8" style="padding-top:8px;" id="syncflag" data-bind="value:model.syncflag" required></div>
                                <script type="text/javascript">
                                    $("#syncflag").kendoRadio({
                                        layout: '',
                                        readonly: false,
                                        disabled: true,
                                        items: [{
                                            label: "是",
                                            value: "Y"
                                        }, {
                                            label: "否",
                                            value: "N"
                                        }]
                                    }).data("kendoRadio");
                                </script>
                            </div>
                        </div>
                        <div class="col-sm-4">
                            <div class="form-group">
                                <label class="col-sm-3 control-label" style="text-align:left"><@spring.message "RETAIL系统单号"/></label>
                                <div class="col-sm-8">
                                    <input id="sapCode" type="text" style="width: 100%" data-bind="value:model.sapCode" class="k-textbox form-control" readonly>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="panel-body" style="margin-top: 10px;border:1px solid #2F617F;">
                    <h5 style="margin-left: 10px;">支付信息</h5>
                    <div class="row">
                        <!-- 应付金额合计 -->
                        <div class="col-sm-4">
                            <div class="form-group">
                                <label class="col-sm-3 control-label" style="text-align:left"><@spring.message "hmall.serviceorder.shouldpay"/></label>
                                <div class="col-sm-8">
                                    <input id="shouldPay" type="text" style="width: 100%" data-bind="value:model.shouldPay" class="form-control full_width" readonly/>
                                </div>
                            </div>
                        </div>
                        <!-- 实付金额合计 -->
                        <div class="col-sm-4">
                            <div class="form-group">
                                <label class="col-sm-3 control-label" style="text-align:left"><@spring.message "hmall.serviceorder.realpay"/></label>
                                <div class="col-sm-8">
                                    <input id="realPay" type="text" style="width: 100%" data-bind="value:model.realPay" class="form-control full_width" readonly/>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="panel-body" style="margin-top: 10px;border:1px solid #2F617F;">
                    <h5 style="margin-left: 10px;">其他信息</h5>
                    <div class="row">
                        <div class="col-sm-4">
                            <div class="form-group">
                                <label class="col-sm-3 control-label" style="text-align:left"><@spring.message "hmall.serviceorder.responsible_person"/></label>
                                <div class="col-sm-8">
                                    <input id="cs" type="text" style="width: 100%" data-bind="value:model.cs" class="k-textbox" readonly>
                                </div>
                            </div>
                        </div>
                        <div class="col-sm-4">
                            <div class="form-group">
                                <label class="col-sm-3 control-label" style="text-align:left"><@spring.message "hmall.serviceorder.creationdate"/></label>
                                <div class="col-sm-8">
                                    <input id="creationDate" type="text" data-role="datetimepicker" style="width: 100%" data-bind="value:model.creationDate" readonly>
                                </div>
                            </div>
                        </div>
                        <div class="col-sm-4">
                            <div class="form-group">
                                <label class="col-sm-3 control-label" style="text-align:left"><@spring.message "hmall.serviceorder.orderfinishtime"/></label>
                                <div class="col-sm-8">
                                    <input id="finishTime" type="text" data-role="datetimepicker" style="width: 100%" data-bind="value:model.finishTime" readonly>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>
    <script>kendo.bind($('#page-content'), viewModel);</script>
    <div class="col-sm-12" style="margin-top:420px;">
        <!-- 商品信息 -->
        <div class="panel-default" style="border-radius:0;border:1px solid #ccc;border-bottom:1px solid rgba(0, 0, 0, 0.17);margin-bottom:0px; height: 495px;top: 700px; ">
            <div class="panel-heading">
                <span class="panel-title" style="float:left;margin-left:10px;margin-right:5px;padding: 0px;"> 商品信息：</span>
            </div>
            <div class="panel-body" style="margin-left:10px;margin-right:5px;padding: 0px;height:325px">
                <div id="orderEntry-page-content" style="height: 350px;">
                    <!-- 保存按钮 -->
                    <div class="pull-left" id="orderEntry-toolbar-btn" style="padding-bottom:10px;padding-top:10px;">
                        <span class="btn btn-primary" id="newEntry" onclick="addOrderEntry()" style="float:left;margin-right:5px;"><@spring.message "hap.new"/></span>
                        <span class="btn btn-danger" id="deleteEntry" style="float:left;margin-right:5px;" onclick="deleteData()"><@spring.message "hap.delete"/></span>
                    </div>

                    <script>kendo.bind($('#orderEntry-toolbar-btn'), orderEntryViewModel);</script>
                    <div style="clear:both">
                        <div id="orderEntryGrid"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
</div>
<div id="orderEntryAdd" style="display:none;"></div>
</body>
<script>
    var BaseUrl = _basePath;
    var asSvsalesId;
    if (($('#asSvsalesId')[0].value === undefined || $('#asSvsalesId')[0].value === "") && asSvsalesId === 0) {
        asSvsalesId = 0;
    }
    var selectedOrderEntries = [];
    var deletedEntries = [];
    function initGrid() {
        if (asSvsalesId !== "0") {
            $.ajax({
                url: BaseUrl + "/hmall/as/order/svsalesEntry/querySvsalesEntriesInfo?svsalesId=" + asSvsalesId,
                type: 'post',
                dataType: 'json',
                async: false,
                success: function (result) {
                    selectedOrderEntries = [];
                    for (var i in result.rows) {
                        selectedOrderEntries.push(result.rows[i]);
                    }
                    refreshOrderEntryGrid();
                }
            });
        }
    }


    function deleteData() {

        if ($("#orderEntryGrid").data("kendoGrid").selectedDataItems().length) {
            kendo.ui.showConfirmDialog({
                title: $l('hap.tip.info'),
                message: $l('hap.tip.delete_confirm')
            }).done(function (event) {
                if (event.button == 'OK') {
                    var selections = $("#orderEntryGrid").data("kendoGrid").selectedDataItems();
                    selectedOrderEntries = $("#orderEntryGrid").data("kendoGrid").dataSource._data;
                    for (var i in selections) {
                        for (var j in selectedOrderEntries) {
                            if (selectedOrderEntries[j].uid == selections[i].uid) {
                                selectedOrderEntries[j].__status = "delete";
                                deletedEntries.push(selectedOrderEntries[j]);
                                selectedOrderEntries.splice(j, 1);
                            }
                        }
                    }
                    refreshOrderEntryGrid();
                    countShouldPay();
                }
            })
        }

    }

    function refreshOrderEntryGrid() {
        $('#orderEntryGrid').data('kendoGrid').dataSource.data(selectedOrderEntries);
    }
    dataSource = new kendo.data.DataSource({
        transport: {
            read: {
                url: BaseUrl + "/hmall/as/order/svsalesEntry/querySvsalesEntriesInfo?svsalesId=" + asSvsalesId,
                type: "POST",
                dataType: "json"
            },
            parameterMap: function (options, type) {
                if (type !== "read" && options.models) {
                    var datas = Hap.prepareSubmitParameter(options, type)
                    return kendo.stringify(datas);
                } else if (type === "read") {
                    return Hap.prepareQueryParameter(orderEntryViewModel.model.toJSON(), options)
                }
            }
        },
        batch: true,
        serverPaging: true,
        pageSize: 10,
        schema: {
            data: 'rows',
            total: 'total',
            model: {
                id: "asSvsalesEntryId",
                fields: {}
            }
        }
    });
    $("#myform").kendoValidator({
        rules: {
            rule1: function (input) {
                var emptyFlag = true;
                if (input.is("[name=name]")) {
                    emptyFlag = $.trim(input.val()) !== "";
                }
                return emptyFlag;
            }
        }
    });
    var _grid_ = $("#orderEntryGrid").kendoGrid({
        height: "400px",
        dataSource: dataSource,
        AutoBind: false,
        resizable: true,
        navigatable: true,
        scrollable: true,
        selectable: 'multiple, rowbox',
        rownumber: true,
        sortable: true,
        pageable: {
            pageSizes: [5, 10, 20, 50],
            refresh: true,
            buttonCount: 5
        },
        columns: [
//            {
//                field: "productCode",
//                title: '<@spring.message "hmall.orderentity.productid"/>',
//                width: 120,
//                editor: function (container, options) {
//                    container.html(options.model.productCode);
//                    container.removeClass('k-edit-cell');
//                }
//            },
            {
                field: "chargeType",
                title: '<@spring.message "hmall.as.charge_type"/>',
                width: 120,
                template: function (dataItem) {
                    var v = dataItem.chargeType;
                    $.each(chargeTypeCode, function (i, n) {
                        if ((n.value || '').toLowerCase() == (v || '').toLowerCase()) {
                            v = n.meaning;
                            return v;
                        }
                    })
                    if (v == undefined) {
                        return '';
                    }
                    return v;
                },
                editor: function (container, options) {
                    $('<input name="' + options.field + '"" required />')
                        .appendTo(container)
                        .kendoDropDownList({
                            dataTextField: "meaning",
                            dataValueField: "value",
                            valuePrimitive: true,
                            dataSource: chargeTypeCode
                        });
                }
            },
//            {
//                field: "basePrice",
//                title: '<@spring.message "hmall.OrderEntry.baseprice"/>',
//                format: "{0:n2}",
//                width: 80,
//                editor: function (container, options) {
//                    $('<input type="number" id="' + options.field + '" name="' + options.field + '" required="required"/>').appendTo(container).kendoNumericTextBox({});
//                }
//            },
            {
                field: "unitFee",
                title: '<@spring.message "hmall.OrderEntry.unitFee"/>',
                format: "{0:n2}",
                width: 80,
                editor: function (container, options) {
                    $('<input id="' + options.field + '" type="number" name="' + options.field + '" onBlur="count(this)" required/>').appendTo(container).kendoNumericTextBox({});
                }
            }, {
                field: "quantity",
                title: '<@spring.message "hmall.OrderEntry.quantity"/>',
                width: 80,
                editor: function (container, options) {
                    $('<input type="number" id="' + options.field + '" name="' + options.field + '" onBlur="count(this)" value="1" readonly required />').appendTo(container)
                        .kendoNumericTextBox({});
                }
            }, {
                field: "totalFee",
                title: '<@spring.message "hmall.OrderEntry.totalFee"/>',
                format: "{0:n2}",
                width: 80,
                editor: function (container, options) {
                    container.html(options.model.totalFee);
                    container.removeClass('k-edit-cell');
                }
            }, {
                field: "note",
                title: '<@spring.message "hmall.OrderEntry.note"/>',
                width: 80,
                editor: function (container, options) {
                    $('<input type="text" id="' + options.field + '" name="' + options.field + '"/>').appendTo(container);
                }
            }
        ],
        editable: true
    }).data("kendoGrid");

    function count(e) {
        // 获取本行信息 e：此行中某个单元格 tr：必须带有data-uid属性的html标签 closest方法找最近的某标签
        var data = $('#orderEntryGrid').data('kendoGrid').dataItem(e.closest("tr"));
        if (data.quantity !== undefined && data.unitFee !== undefined && e.value !== "") {
            if (e.id === "quantity") {
                data.totalFee = e.value * data.unitFee;
            }
            if (e.id === "unitFee") {
                data.totalFee = e.value * data.quantity;
            }
            $('#orderEntryGrid').data('kendoGrid').dataSource.data($('#orderEntryGrid').data('kendoGrid').dataSource._data);
            selectedOrderEntries = $('#orderEntryGrid').data('kendoGrid').dataSource._data;
            countShouldPay();
        }
    }

    function countShouldPay() {
        var shouldPay = parseFloat(0);
        for (var i = 0; i < selectedOrderEntries.length; i++) {
            if (selectedOrderEntries[i].totalFee) {
                shouldPay += selectedOrderEntries[i].totalFee;
            }
        }
        viewModel.model.set("shouldPay", shouldPay);
    }

    function addOrderEntry() {
//        var dialog = $("#orderEntryAdd").kendoWindow({
//            width: 1200,
//            height: 600,
//            title: '新增商品',
//            visible: false,
//            iframe: true,
//            modal: true,
//            content: "${base.contextPath}/as/as_ss_select_product.html",
//            actions: ["Pin", "Close"],
//            close: function () {
//            }
//        }).data("kendoWindow");
//        dialog.center().open();
        var newRow = {quantity: 1};
        selectedOrderEntries.push(newRow);
        refreshOrderEntryGrid();
    }

    function addProducts(selections) {
        for (var i in selections) {
            selectedOrderEntries.push(transObject(selections[i]));
        }
        refreshOrderEntryGrid();
    }

    function transObject(fromObj) {
        var toObj = {};
        toObj.svsalesOrderId = $('#asSvsalesId')[0].value;
        toObj.productId = fromObj.productId;
        toObj.productName = fromObj.name;
        toObj.productCode = fromObj.code;
        toObj.vproduct = fromObj.vproductCode;
        toObj.basePrice = fromObj.basePrice;
        return toObj;
    }

    initGrid();
</script>