<#--
        * description: 发货详情页
        * author:syu
        * 2017/6/8
        * version: 0.1
        -->
    <#include "../include/header.html">
        <script src="${base.contextPath}/common/code?statusData=HMALL.CONSIGNMENT.STATUS" type="text/javascript"></script>
        <script src="${base.contextPath}/common/code?shippingData=HMALL.SHIPPING_TYPE" type="text/javascript"></script>
        <script src="${base.contextPath}/common/code?OrderEntryData=HMALL.ORDER_ENTRY.STATUS " type="text/javascript"></script>
        <script src="${base.contextPath}/common/code?OrderTypeData=HMALL.ORDER.ORDER_TYPE" type="text/javascript"></script>
        <script src="${base.contextPath}/common/code?tmsStatus=HMALL.OM.TMS_STATUS" type="text/javascript"></script>
        <script type="text/javascript">

            var consignmentId = '${RequestParameters.consignmentId!0}';
            var funCode = '${RequestParameters.funCode!0}';
            console.log("funCode ", funCode)
            console.log("consignmentId ", consignmentId)
            //区域下拉框数据源
            var data_country = null;
            var data_state = null;
            var data_city = null;
            var data_area = null;
            //原始数据，保存按钮传递参数
            var originalData = null;
            var parameterData = new Object();
            var changedOrderEntries = [];

            var viewModel = kendo.observable({
                model: {}
            });
            ;

            var consignmentViewModel = kendo.observable({
                model: {}
            });
            ;

            if (funCode == 'ORDER_SNAPSHOT') {
                $(document).ready(function () {
                    $('#buttonGroup').hide();
                })
            }

            function partsFunction(orderEntryId) {
                var editWin = $("#editWin").kendoWindow({
                    actions: ["Close"],
                    width: 300,
                    height: 200,
                    title: '<@spring.message "配件"/>',
                    content: "om_parts_mapping.html?orderEntryId=" + orderEntryId,
                    iframe: true,
                    visible: false,
                    modal: true,
                    close: function () {
                        $("#editWin").empty();
                    }
                }).data("kendoWindow");
                editWin.center().open();
            }

            function saveFun() {
                var requestFlag = false;
                if (originalData.status == 'ABNORMAL' || originalData.status == 'WAIT_FOR_DELIVERY') {
                    if (consignmentId != null && consignmentId > 0) {
                        parameterData.consignmentId = consignmentId;
                    }
                    parameterData.orderEntries = changedOrderEntries;
//                console.log("changedOrderEntries", changedOrderEntries);
//                console.log("parameterData", parameterData);
                    if (changedOrderEntries != null && changedOrderEntries.length > 0) {
                        requestFlag = true;
                    }
                    for (var k in parameterData) {
                        if (k == 'receiverName' || k == 'receiverCountry' || k == 'receiverDistrict' || k == 'receiverCity' || k == 'receiverState'
                                || k == 'receiverMobile' || k == 'receiverPhone' || k == 'receiverZip' || k == 'receiverAddress' || k == 'splitAllowed') {
                            requestFlag = true;
                        }
                    }
                    if (requestFlag) {
                        $.ajax({
                            type: "POST",
                            url: '${base.contextPath}/hmall/om/consignment/save',
                            dataType: "json",
                            contentType: "application/json",
                            data: kendo.stringify(parameterData),
                            success: function (data) {
                                if (data.success) {
                                    kendo.ui.showInfoDialog({
                                        message: '保存成功',
                                    }).done(function (event) {
                                        if (event.button == 'OK') {
                                            $('#Grid').data('kendoGrid').dataSource.read(1);
                                            changedOrderEntries.length = 0;
                                        }
                                    })
                                } else {
                                    kendo.ui.showErrorDialog({
                                        message: '保存失败,' + data.message,
                                    });
                                }
                            }
                        });
                    } else {
                        kendo.ui.showWarningDialog({
                            message: "数据没有修改"
                        })
                    }
                } else {
                    kendo.ui.showInfoDialog({
                        message: "发货单状态不满足修改条件"
                    })
                }
            }

        </script>
        <body>
        <div id="page-content">
            <div id="detail" class="panel">
                <div class="panel-body" id="lab-body">
                    <#if accessService.access("HIDECONSIGNMENTDETAILS")>
                        <div id="buttonGroup" class="row">
                            <div style='padding-top: 7px; padding-bottom: 7px;'>
                                <!-- 审核按钮 -->
                                <span id="query_platformName" class="btn btn-primary" onclick="updateConsignmentStatus()"
                                      style="margin-right:5px;" type="submit">
								<i class="fa fa-wrench" style="margin-right:3px;">审核</i>
							</span>
                                <span id="SplitSingle" class="btn btn-primary" onclick="SplitSingle()"
                                      style="margin-right:5px;" type="submit">
                            <i class="fa fa-user" style="margin-right:3px;">手工拆单</i>
                            </span>
                                <span id="hold" class="btn btn-primary" onclick="pauseReason()"
                                      style="margin-right:5px;" type="submit">
                            <i class="fa fa-user" style="margin-right:3px;">申请暂挂</i>
                            </span>
                                <span id="cancelHold" class="btn btn-primary" onclick="cancelHold()"
                                      style="margin-right:5px;" type="submit">
                            <i class="fa fa-user" style="margin-right:3px;">取消暂挂</i>
                            </span>
                                <span id="saveBtn" class="btn btn-primary" onclick="saveFun()"
                                      style="margin-right:5px;">
                            <i class="fa fa-user" style="margin-right:3px;">保存</i>
                            </span>
                                <span id="tradeFinish" class="btn btn-primary" onclick="tradeFinish()"
                                      style="margin-right:5px;">
                            <i class="fa fa-user" style="margin-right:3px;">确认收货</i>
                            </span>
                            </div>
                        </div>
                    </#if>

                    <div class="row" style="margin-top: 10px;border:1px solid #2F617F;">
                        <h5 style="margin-left: 10px;">基本信息</h5>
                        <div class="form-group col-sm-4">
                            <label class="control-label col-sm-4" style="margin-top: 5px;"><@spring.message
                                "发货单号:"/></label>
                            <div class="col-sm-8">
                                <input type="text" class="form-control full_width k-textbox"
                                       data-role="maskedtextbox" id="code" data-bind="value:model.code" readonly/>
                            </div>
                        </div>
                        <div class="form-group col-sm-4">
                            <label class="control-label col-sm-4" style="margin-top: 5px;"><@spring.message
                                "快递单号:"/></label>
                            <div class="col-sm-8">
                                <input type="text" class="form-control full_width k-textbox"
                                       data-role="maskedtextbox" id="logisticsNumber"
                                       data-bind="value:model.logisticsNumber" readonly/>
                            </div>
                        </div>

                        <div class="form-group col-sm-4">
                            <label class="control-label col-sm-4" style="margin-top: 5px;"><@spring.message
                                "单据状态:"/></label>
                            <div class="col-sm-8">
                                <input type="text" class="form-control full_width  k-textbox" id="status"
                                       data-bind="value:model.consignmentStatus" readonly/>
                            </div>
                        </div>

                        <div class="form-group col-sm-4">
                            <label class="control-label col-sm-4" style="margin-top: 5px;"><@spring.message
                                "快递公司:"/></label>
                            <div class="col-sm-8">
                                <input type="text" class="form-control full_width k-textbox"
                                       data-role="maskedtextbox" id="corporateName"
                                       data-bind="value:model.corporateName" readonly/>
                            </div>
                        </div>

                        <div class="form-group col-sm-4">
                            <label class="control-label col-sm-4" style="margin-top: 5px;"><@spring.message
                                "下单日期:"/></label>
                            <div class="col-sm-8">
                                <input type="text" class="form-control full_width  k-textbox" id="orderCreationtime"
                                       data-bind="value:model.orderCreationtime" readonly/>
                            </div>
                        </div>


                        <div class="form-group col-sm-4">
                            <label class="control-label col-sm-4" style="margin-top: 5px;"><@spring.message
                                "发货时间:"/></label>
                            <div class="col-sm-8">
                                <input type="text" class="form-control full_width  k-textbox" id="shippingDate"
                                       data-bind="value:model.shippingDate" readonly/>
                            </div>
                        </div>

                        <div class="form-group col-sm-4">
                            <label class="control-label col-sm-4" style="margin-top: 5px;"><@spring.message
                                "hmall.order.type"/></label>
                            <div class="col-sm-8">
                                <input type="text" class="form-control full_width" id="orderType"
                                       data-bind="value:model.orderType" readonly/>
                            </div>
                            <script>
                                $('#orderType').kendoDropDownList({
                                    dataTextField: "meaning",
                                    dataValueField: "value",
                                    dataSource: OrderTypeData,
                                    valuePrimitive: true
                                })
                            </script>
                        </div>

                        <div class="form-group col-sm-4">
                            <label class="control-label col-sm-4" style="margin-top: 5px;"><@spring.message
                                "配送方式:"/></label>
                            <div class="col-sm-8">
                                <input type="text" class="form-control full_width  k-textbox"
                                       data-role="maskedtextbox" id="shippingType"
                                       data-bind="value:model.shippingName" readonly/>
                            </div>
                        </div>

                        <div class="form-group col-sm-4">
                            <label class="control-label col-sm-4" style="margin-top: 5px;"><@spring.message
                                "发货仓库:"/></label>
                            <div class="col-sm-8">
                                <input type="text" class="form-control full_width  k-textbox"
                                       data-role="maskedtextbox" id="pointCode"
                                       data-bind="value:model.pointCode" readonly/>
                            </div>
                        </div>

                        <div class="clearfix"></div>
                        <div class="form-group col-sm-4">
                            <label class="control-label col-sm-4" style="margin-top: 5px;"><@spring.message
                                "审核人:"/></label>
                            <div class="col-sm-8">
                                <input type="text" class="form-control full_width  k-textbox"
                                       data-role="maskedtextbox" id="approvedBy"
                                       data-bind="value:model.approvedBy" readonly/>
                            </div>
                        </div>

                        <div class="form-group col-sm-4">
                            <label class="control-label col-sm-4" style="margin-top: 5px;"><@spring.message
                                "审核时间:"/></label>
                            <div class="col-sm-8">
                                <input type="text" class="form-control full_width  k-textbox"
                                       data-role="maskedtextbox" id="approvedDate"
                                       data-bind="value:model.approvedDate" readonly/>
                            </div>
                        </div>

                        <div class="form-group col-sm-4">
                            <label class="control-label col-sm-4" style="margin-top: 5px;" for="csApproved"><@spring.message
                                "客服审核:"/></label>
                            <div class="col-sm-8">
                                <div class="full_width"
                                     id="csApproved" data-bind="value:model.csApproved"></div>
                            </div>
                            <script type="text/javascript">
                                $("#csApproved").kendoRadio({
                                    items: [{
                                        label: "是",
                                        value: "Y"
                                    }, {
                                        label: "否",
                                        value: "N"
                                    }],
                                    change: function (e) {
                                        parameterData.csApproved = this.value();
                                    }
                                }).data("kendoRadio");
                            </script>

                        </div>

                        <div class="clearfix"></div>
                        <div class="form-group col-sm-4">
                            <label class="control-label col-sm-4" style="margin-top: 5px;"><@spring.message
                                "hmall.sap.code"/></label>
                            <div class="col-sm-8">
                                <input type="text" class="form-control full_width  k-textbox"
                                       data-role="maskedtextbox" id="sapCode"
                                       data-bind="value:model.sapCode" readonly/>
                            </div>
                        </div>

                        <div class="form-group col-sm-4">
                            <label class="control-label col-sm-4" style="margin-top: 5px;"><@spring.message
                                "拆单原因:"/></label>
                            <div class="col-sm-8">
                                <input type="text" class="form-control full_width  k-textbox"
                                       data-role="maskedtextbox" id="splitReason"
                                       data-bind="value:model.splitReason" readonly/>
                            </div>
                        </div>

                        <div class="form-group col-sm-4">
                            <label class="control-label col-sm-4" style="margin-top: 5px;"><@spring.message
                                "异常原因:"/></label>
                            <div class="col-sm-8">
                                <input type="text" class="form-control full_width  k-textbox"
                                       data-role="maskedtextbox" id="abnormalReason"
                                       data-bind="value:model.abnormalReason" readonly/>
                            </div>
                        </div>
                        <div class="clearfix"></div>
                        <div class="form-group col-sm-4">
                            <label class="control-label col-sm-4" style="margin-top: 5px;"><@spring.message
                                "是否暂挂:"/></label>
                            <div class="col-sm-8" style="margin-top: 5px;">
                                <div class="full_width"
                                     id="pause" data-bind="value:model.pause"></div>
                            </div>
                            <script type="text/javascript">
                                $("#pause").kendoRadio({
                                    items: [{
                                        label: "是",
                                        value: "Y"
                                    }, {
                                        label: "否",
                                        value: "N"
                                    }],
                                    change: function (e) {

                                    }
                                }).data("kendoRadio");
                            </script>

                        </div>
                        <div class="form-group col-sm-4">
                            <label class="control-label col-sm-4" style="margin-top: 6px;"><@spring.message
                                "暂挂原因:"/></label>
                            <div class="col-sm-8">
                                <input type="text" class="form-control full_width  k-textbox"
                                       data-role="maskedtextbox" id="pauseReason"
                                       data-bind="value:model.pauseReason" readonly/>
                            </div>
                        </div>

                        <div class="form-group col-sm-4">
                            <label class="control-label col-sm-4" style="margin-top: 6px;"><@spring.message
                                "确认收货时间:"/></label>
                            <div class="col-sm-8">
                                <input type="text" class="form-control full_width  k-textbox"
                                       data-role="maskedtextbox" id="tradeFinishedTime"
                                       data-bind="value:model.tradeFinishedTime" readonly/>
                            </div>
                        </div>

                    </div>

                    <div class="row" style="margin-top: 10px;border:1px solid #2F617F;">

                        <h5 style="margin-left: 10px;">配送信息</h5>

                        <div class="form-group col-sm-4">
                            <label class="control-label col-sm-4" style="margin-top: 5px;"><@spring.message
                                "用户账户:"/></label>
                            <div class="col-sm-8">
                                <input type="text" class="form-control full_width k-textbox"
                                       id="customerid" data-bind="value:model.customerid" readonly/>
                            </div>
                        </div>

                        <div class="form-group col-sm-4">
                            <label class="control-label col-sm-4" style="margin-top: 5px;"><@spring.message
                                "收货人:"/></label>
                            <div class="col-sm-8">
                                <input type="text" class="form-control full_width k-textbox"
                                       data-role="maskedtextbox" id="receiverName" data-bind="value:model.receiverName"/>
                            </div>
                            <script>
                                $('#receiverName').change(function () {
                                    parameterData.receiverName = $('#receiverName').val();
                                })
                            </script>
                        </div>

                        <div class="form-group col-sm-4">
                            <label class="control-label col-sm-4" style="margin-top: 5px;"><@spring.message
                                "用户组:"/></label>
                            <div class="col-sm-8">
                                <input type="text" class="form-control full_width k-textbox"
                                       data-role="maskedtextbox" id="groupName" data-bind="value:model.groupName" readonly/>
                            </div>
                        </div>

                        <div class="form-group col-sm-4">
                            <label class="control-label col-sm-4" style="margin-top: 5px;"><@spring.message
                                "国家:"/></label>
                            <div class="col-sm-8">
                                <input type="text" style="width: 160px;"
                                       id="receiverCountry" data-bind="value:model.receiverCountry"/>
                            </div>
                            <script>
                                $('#receiverCountry').kendoDropDownList({
                                    dataTextField: 'regionName',
                                    dataValueField: 'regionCode',
                                    dataSource: data_country,
                                    change: function (e) {
                                        $.ajax({
                                            url: BaseUrl + "/fnd/regions/getState?countryCode=" + $('#receiverCountry').val(),
                                            type: 'POST',
                                            dataType: "json",
                                            contentType: 'application/json',
                                            success: function (data) {
                                                data_state = data.rows;
                                                $('#receiverCity').data("kendoDropDownList").select(-1);
                                                $('#receiverDistrict').data("kendoDropDownList").select(-1);
                                                $('#receiverState').data("kendoDropDownList").setDataSource(data_state);
                                            }
                                        });
                                        parameterData.receiverCountry = $('#receiverCountry').val();
                                        parameterData.receiverState = $('#receiverState').val();
                                        parameterData.receiverCity = $('#receiverCity').val();
                                        parameterData.receiverDistrict = $('#receiverDistrict').val();
                                    }
                                })
                            </script>
                        </div>

                        <div class="form-group col-sm-4">
                            <label class="control-label col-sm-4" style="margin-top: 5px;"><@spring.message
                                "省份:"/></label>
                            <div class="col-sm-8">
                                <input type="text" style="width: 160px;"
                                       id="receiverState" data-bind="value:model.receiverState"/>
                            </div>
                            <script>
                                $('#receiverState').kendoDropDownList({
                                    dataTextField: 'regionName',
                                    dataValueField: 'regionCode',
                                    dataSource: data_state,
                                    change: function (e) {
                                        parameterData.receiverState = $('#receiverState').val();
                                        parameterData.receiverCity = $('#receiverCity').val();
                                        parameterData.receiverDistrict = $('#receiverDistrict').val();
                                        $.ajax({
                                            url: BaseUrl + "/fnd/regions/getCity?stateCode=" + $('#receiverState').val(),
                                            type: 'POST',
                                            dataType: "json",
                                            contentType: 'application/json',
                                            success: function (data) {
                                                data_city = data.rows;
                                                $('#receiverDistrict').data("kendoDropDownList").select(-1);
                                                $('#receiverCity').data("kendoDropDownList").setDataSource(data_city);
                                            }
                                        });
                                    }
                                })
                            </script>
                        </div>

                        <div class="form-group col-sm-4">
                            <label class="control-label col-sm-4" style="margin-top: 5px;"><@spring.message
                                "城市:"/></label>
                            <div class="col-sm-8">
                                <input type="text" style="width: 160px;" data-value-primitive="true"
                                       id="receiverCity" data-bind="value:model.receiverCity"/>
                            </div>
                            <script>
                                $('#receiverCity').kendoDropDownList({
                                    dataTextField: 'regionName',
                                    dataValueField: 'regionCode',
                                    dataSource: data_city,
                                    change: function (e) {
                                        parameterData.receiverCity = $('#receiverCity').val();
                                        parameterData.receiverDistrict = $('#receiverDistrict').val();
                                        $.ajax({
                                            url: BaseUrl + "/fnd/regions/getArea?cityCode=" + $('#receiverCity').val(),
                                            type: 'POST',
                                            dataType: "json",
                                            contentType: 'application/json',
                                            success: function (data) {
                                                data_area = data.rows;
                                                $('#receiverDistrict').data("kendoDropDownList").setDataSource(data_area);
                                            }
                                        });

                                    }
                                })
                            </script>
                        </div>

                        <div class="form-group col-sm-4">
                            <label class="control-label col-sm-4" style="margin-top: 5px;"><@spring.message
                                "区/县:"/></label>
                            <div class="col-sm-8">
                                <input type="text" style="width: 160px;" data-value-primitive="true"
                                       id="receiverDistrict" data-bind="value:model.receiverDistrict"/>
                            </div>
                            <script>
                                $('#receiverDistrict').kendoDropDownList({
                                    dataTextField: 'regionName',
                                    dataValueField: 'regionCode',
                                    dataSource: data_area,
                                    change: function (e) {
                                        parameterData.receiverDistrict = $('#receiverDistrict').val();
                                    }
                                })
                            </script>
                        </div>

                        <div class="form-group col-sm-4">
                            <label class="control-label col-sm-4" style="margin-top: 5px;"><@spring.message
                                "收货手机号:"/></label>
                            <div class="col-sm-8">
                                <input type="text" class="form-control full_width k-textbox"
                                       id="receiverMobile" data-bind="value:model.receiverMobile"/>
                            </div>
                            <script>
                                $('#receiverMobile').change(function () {
                                    parameterData.receiverMobile = $('#receiverMobile').val();
                                })
                            </script>
                        </div>

                        <div class="form-group col-sm-4">
                            <label class="control-label col-sm-4" style="margin-top: 5px;"><@spring.message
                                "电话:"/></label>
                            <div class="col-sm-8">
                                <input type="text" class="form-control full_width k-textbox"
                                       id="receiverPhone" data-bind="value:model.receiverPhone"/>
                            </div>
                            <script>
                                $('#receiverPhone').change(function () {
                                    parameterData.receiverPhone = $('#receiverPhone').val();
                                })
                            </script>
                        </div>
                        <div class="clearfix"></div>
                        <div class="form-group col-sm-4">
                            <label class="control-label col-sm-4" style="margin-top: 5px;"><@spring.message
                                "邮编:"/></label>
                            <div class="col-sm-8">
                                <input type="text" class="form-control full_width k-textbox"
                                       id="receiverZip" data-bind="value:model.receiverZip"/>
                            </div>
                            <script>
                                $('#receiverZip').change(function () {
                                    parameterData.receiverZip = $('#receiverZip').val();
                                })
                            </script>
                        </div>

                        <div class="form-group col-sm-4">
                            <label class="control-label col-sm-4" style="margin-top: 5px;"><@spring.message
                                "预计交货时间:"/></label>
                            <div class="col-sm-8">
                                <input type="text" class="form-control full_width k-textbox"
                                       id="estimateDeliveryTime" data-bind="value:model.estimateDeliveryTime" readonly/>
                            </div>
                        </div>

                        <div class="col-sm-4">
                            <div class="form-group">
                                <label class="col-sm-4 control-label"><@spring.message "是否分批发货:"/></label>
                                <div class="col-sm-8">
                                    <div class="full_width" id="splitAllowed" style="margin-top: 3px;" type="text" data-bind="enabled:true,value:model.splitAllowed"></div>
                                    <script type="text/javascript">
                                        var oriSplitAllowed = viewModel.model.splitAllowed;
                                        $("#splitAllowed").kendoRadio({
                                            layout: '',//vertical
                                            readonly: false,
                                            items: [{
                                                label: "是",
                                                value: "Y"
                                            }, {
                                                label: "否",
                                                value: "N"
                                            }],
                                            change: function (e) {
                                                if (oriSplitAllowed != viewModel.model.splitAllowed) {
                                                    parameterData.splitAllowed = this.value();
                                                }
                                            }
                                        }).data("kendoRadio");
                                    </script>

                                </div>
                            </div>
                        </div>

                        <div class="form-group col-sm-8">
                            <label class="control-label col-sm-2" style="margin-top: 5px;"><@spring.message
                                "收货地址:"/></label>
                            <div class="col-sm-10">
                                <input type="text" class="form-control full_width k-textbox" maxlength="50px" style="width: 100%;margin-left:-5px;"
                                       data-role="maskedtextbox" id="receiverAddress"
                                       data-bind="value:model.receiverAddress"/>
                            </div>
                            <script>
                                $('#receiverAddress').change(function () {
                                    parameterData.receiverAddress = $('#receiverAddress').val();
                                })
                            </script>
                        </div>
                    </div>
                </div>
            </div>
            <script>
                kendo.bind($("#detail"), viewModel);
            </script>
            <div id="editWin"></div>


            <div id="tabStrip">
                <ul>
                    <li id="orderLines"><@spring.message "hmall.OrderEntry.orderLine"/></li>
                    <li><@spring.message "hmall.markor.logistics.info"/></li>
                </ul>
                <div class="tab-pane fade in active" style="margin-top: 10px;"
                     id="lines">
                    <div id="page-content1">
                        <div id='grid-container' style="clear: both;">
                            <div id="Grid"></div>
                        </div>
                    </div>
                </div>
                <div class="tab-pane fade" style="margin-top: 10px;" id="lots2">
                    <div id="page-content2">
                        <div style="clear: both;">
                            <div class="row">
                                <div class="col-sm-3">
                                    <label class="control-label col-sm-2" style="margin-top: 5px;"><@spring.message
                                        "交货单编号:"/></label>
                                    <div class="col-sm-4">
                                        <input id="deliveryOrders" style="width: 100%"/>
                                    </div>
                                </div>
                                <div class="col-sm-3">
                                    <label class="control-label col-sm-2" style="margin-top: 5px;"><@spring.message
                                        "物流单号:"/></label>
                                    <div id="logisticsNumberText" class="control-label col-sm-4" style="padding-top: 7px">

                                    </div>
                                </div>
                            </div>
                            <script>
                                var deliveryOrderId = 0;
                                $(document).ready(function () {
                                    $("#deliveryOrders").kendoDropDownList({
                                        dataTextField: "deliveryNote",
                                        dataValueField: "deliveryOrderId",
                                        dataSource: viewModel.model.deliveryOrders,
                                        select: onDeliveryOrderSelected
                                    });
                                });
                                function onDeliveryOrderSelected(e) {
                                    debugger;
                                    deliveryOrderId = e.dataItem.deliveryOrderId;
                                    $("#logisticsNumberText").html(e.dataItem.logisticsNumber);
                                    refreshLogisticsInfoGrid();
                                }
                            </script>
                            <div></div>
                            <div id="loisticsInfoGrid"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <script>
            var tabstrip = $("#tabStrip").kendoTabStrip({
                animation: {
                    close: {
                        duration: 200,
                        effects: "fadeOut"
                    },
                    open: {
                        duration: 200,
                        effects: "fadeIn"
                    }
                }
            }).data("kendoTabStrip");

            tabstrip.activateTab($("#orderLines"));

        </script>


        <script type="text/javascript">

            /** 根据服务单发货单号查询服务单详细信息 **/
            var requestUrl = '';
            if (funCode == 'ORDER_SNAPSHOT') {
                console.log("chaxun");
                requestUrl = '${base.contextPath}/hmall/om/consignment/bk/queryById?consignmentId=' + consignmentId;
            } else {
                requestUrl = '${base.contextPath}/hmall/om/consignment/queryInfo?consignmentId=' + consignmentId;
            }
            $.ajax({
                type: 'POST',
                url: requestUrl,
                dataType: "json",
                contentType: "application/json",
                async: false,
                success: function (data) {
                    console.log('>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>> data <<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<');
                    console.log(data);
                    // data.rows[0].consignmentStatus = '被修改。。。。。。！！！！！！！！';


                    if (data.success) {
                        var a0 = data.rows[0] || {};
                        originalData = a0;
                        for (var k in a0) {
                            viewModel.model.set(k, a0[k]);
                            //当sapCode为空时，则不能申请暂挂
                            /* if(k=='sapCode' && (a0[k]==null||a0[k]=='')){
                             $('#hold')[0].style.display='none';
                             }*/
                            //当发货单状态不是"WAIT_FOR_DELIVERY",则不能申请暂挂
                            /*if(k == "status" && a0[k] != "WAIT_FOR_DELIVERY"){
                             $('#hold')[0].style.display='none';
                             }*/
                            if (k == "pause" && (a0[k] == null || a0[k] == '')) {
                                viewModel.model.set(k, "N");
                            }
                            if (k == 'abnormalReason' && a0[k] != null) {
                                $("#abnormalReason").css("background", "#FF7972")
                            }
                        }
                        if (viewModel.model.deliveryOrders != undefined && viewModel.model.deliveryOrders.length > 0) {
                            deliveryOrderId = viewModel.model.deliveryOrders[0].deliveryOrderId;
                            $("#logisticsNumberText").html(viewModel.model.deliveryOrders[0].logisticsNumber);
                            refreshLogisticsInfoGrid();
                        } else {
                            deliveryOrderId = 0;
                        }
                        if (viewModel.model.sapCode != null && viewModel.model.sapCode != "" && viewModel.model.status == "WAIT_FOR_DELIVERY") {
                            if (viewModel.model.pause == "N") {
                                if ($('#hold')[0] != undefined) {
                                    $('#hold')[0].style.display = 'inline-block';
                                    $('#cancelHold')[0].style.display = 'none';
                                }
                            } else {
                                if ($('#hold')[0] != undefined) {
                                    $('#hold')[0].style.display = 'none';
                                    $('#cancelHold')[0].style.display = 'inline-block';
                                }
                            }

                        } else {
                            if ($('#hold')[0] != undefined) {
                                $('#hold')[0].style.display = 'none';
                                $('#cancelHold')[0].style.display = 'none';
                            }
                        }
                        kendo.bind($("#detail"), viewModel);

                    }
                    var status = viewModel.model.status;
                    if (status == "ABNORMAL" || status == "PROCESS_ERROR") {
                        $("#query_platformName").attr("disabled", false);
                    } else {
                        $("#query_platformName").attr("disabled", true);
                    }
                    if (status == "ABNORMAL") {
                        $("#SplitSingle").attr("disabled", false);
                    } else {
                        $("#SplitSingle").attr("disabled", true);
                    }
                }
            });

            var BaseUrl = _basePath;

            var oeUrl = '';
            if (funCode == 'ORDER_SNAPSHOT') {
                oeUrl = "/hmall/om/order/entry/bk/queryInfo?consignmentId=" + consignmentId
            } else {
                oeUrl = "/hmall/om/order/entry/queryInfo?consignmentId=" + consignmentId
            }
            dataSource = new kendo.data.DataSource({
                transport: {
                    read: {
                        url: BaseUrl + oeUrl,
                        type: "POST",
                        dataType: "json"
                    },
                    parameterMap: function (options, type) {
                        if (type !== "read" && options.models) {
                            var datas = Hap.prepareSubmitParameter(options, type)
                            return kendo.stringify(datas);
                        } else if (type === "read") {
                            return Hap.prepareQueryParameter(consignmentViewModel.model.toJSON(), options)
                        }
                    }
                },
                batch: true,
                serverPaging: true,
                pageSize: 10,
                schema: {
                    data: 'rows',
                    total: 'total',
                    model: {
                        id: "orderEntryId",
                        fields: {
                            code: {editable: false},
                            vproductCode: {editable: false},
                            sutiCode: {editable: false},
                            productCode: {editable: false},
                            name: {editable: false},
                            quantity: {editable: false},
                            parentVproductCode: {editable: false},
                            odtype: {editable: false},
                            logisticsNumber: {editable: false},
                            productSize: {editable: false},
                            productPackedSize: {editable: false},
                            basePrice: {editable: false},
                            discountFee: {editable: false},
                            unitFee: {editable: false},
                            totalFee: {editable: false},
                            isGift: {editable: false},
                            pin: {editable: false},
                            orderEntryStatus: {editable: false},
                            oriRequirementTime: {editable: false},
                            atpCalculateTime: {editable: false},
                            estimateConTime: {editable: false},
                            lastEventDes: {editable: false}
                        }
                    }
                }
            });

            $("#Grid").kendoGrid({
                dataSource: dataSource,
                height: "400px",
                resizable: true,
                navigatable: true,
                scrollable: true,
                selectable: true,
                rownumber: true,
                sortable: true,
                selectable: 'multiple, rowbox',
                pageable: {
                    pageSizes: [5, 10, 20, 50],
                    refresh: true,
                    buttonCount: 5
                },
                columns: [
                    {
                        field: "code",
                        title: '<@spring.message "hmall.order.entry.code"/>',
                        width: 150
                    }, {
                        field: "productCode",
                        title: '<@spring.message "hmall.OrderEntry.productCode"/>',
                        width: 120
                    }, {
                        field: "name",
                        title: '<@spring.message "hmall.OrderEntry.productName"/>',
                        width: 120
                    }, {
                        field: "pin",
                        title: '<@spring.message "imselectresultinface.zpin"/>',
                        width: 180
                    }, {
                        field: "lastEventDes",
                        title: 'PIN码最新状态',
                        width: 150
                    }, {
                        field: "quantity",
                        title: '<@spring.message "hmall.OrderEntry.quantity"/>',
                        width: 80
                    }, {
                        field: "orderEntryStatus",
                        title: '订单行状态',
                        width: 80,
                        template: function (dataItem) {
                            var v = dataItem.orderEntryStatus;
                            $(OrderEntryData).each(function (i, n) {
                                if (n.value == v) {
                                    v = n.meaning;
                                }
                                return v;
                            });
                            return v;
                        }
                    }, {
                        field: "logisticsNumber",
                        title: '<@spring.message "物流单号"/>',
                        width: 100
                    }, {
                        field: "productSize",
                        title: '<@spring.message "净尺寸"/>',
                        width: 80
                    }, {
                        field: "productPackedSize",
                        title: '<@spring.message "包装尺寸"/>',
                        width: 80
                    }, {
                        field: "basePrice",
                        title: '<@spring.message "hmall.OrderEntry.basePrice"/>',
                        format: "{0:n2}",
                        width: 80
                    }, {
                        field: "discountFee",
                        title: '<@spring.message "hmall.OrderEntry.discountFee"/>',
                        format: "{0:n2}",
                        width: 80
                    }, {
                        field: "unitFee",
                        title: '<@spring.message "hmall.OrderEntry.unitFee"/>',
                        format: "{0:n2}",
                        width: 80
                    }, {
                        field: "totalFee",
                        title: '<@spring.message "hmall.OrderEntry.totalFee"/>',
                        format: "{0:n2}",
                        width: 80
                    }, {
                        field: "isGift",
                        title: '<@spring.message "hmall.OrderEntry.isGift"/>',
                        width: 80,
                        values: [
                            {text: "是", value: "Y"},
                            {text: "否", value: "N"}
                        ]
                    }, {
                        field: "bomRejectReason",
                        title: '<@spring.message "hmall.OrderEntry.bomRejectReason"/>',
                        width: 120
                    }, {
                        field: "oriRequirementTime",
                        title: '<@spring.message "客户原始需求日期"/>',
                        width: 150
                    }, {
                        field: "atpCalculateTime",
                        title: '<@spring.message "ATP答复最早交期"/>',
                        width: 150
                    }, {
                        field: "estimateConTime",
                        title: '<@spring.message "hmall.OrderEntry.estimateConTime"/>',
                        width: 180
                    }, {
                        field: "estimateDeliveryTime",
                        title: '<@spring.message "hmall.OrderEntry.estimateDeliveryTime"/>',
                        width: 180,
                        format: "{0:yyyy-MM-dd HH:mm:ss}",
                        editor: function (container, options) {
                            var oriDate = options.model.estimateDeliveryTime;
                            $('<input  name="' + options.field + '" />')
                                    .appendTo(container)
                                    .kendoDateTimePicker({
                                        change: function () {
                                            if (oriDate != options.model.estimateDeliveryTime) {
                                                changedOrderEntries.unshift({orderEntryId: options.model.orderEntryId, estimateDeliveryTime: options.model.estimateDeliveryTime})
                                            }
                                        }
                                    }).data("kendoDateTimePicker");
                        }
                    }, {
                        field: "vproductCode",
                        title: '<@spring.message "hmall.OrderEntry.vproduct"/>',
                        width: 150
                    }, {
                        field: "supplier",
                        title: '工厂归属',
                        width: 150
                    }, {
                        field: "sutiCode",
                        title: '<@spring.message "hmall.OrderEntry.sutiCode"/>',
                        width: 120
                    }, {
                        field: "parentVproductCode",
                        title: '<@spring.message "hmall.link.orderentry"/>',
                        width: 150
                    }, {
                        field: "odtype",
                        title: '<@spring.message "频道"/>',
                        width: 100
                    }, {
                        title: '<@spring.message "配件"/>',
                        width: 50,
                        template: function (rowdata) {
                            if (!!rowdata.orderEntryId) {
                                return '<a href="javascript:void(0);" onclick="partsFunction(' + rowdata.orderEntryId + ')"><@spring.message "配件"/></a>'
                            }
                            return ' ';
                        },
                        attributes: {style: "text-align:center"},
                        headerAttributes: {style: "text-align:center"}
                    }
                ],
                editable: true
            }).data("kendoGrid");

            function refreshLogisticsInfoGrid() {
                dataSource2 = new kendo.data.DataSource({
                    transport: {
                        read: {
                            url: BaseUrl + "/hmall/om/trade/trace/getTradeTraceInfoByDelivery?deliveryOrderId=" + deliveryOrderId,
                            type: "POST",
                            dataType: "json"
                        },
                        parameterMap: function (options, type) {
                            if (type === "read") {
                                return Hap.prepareQueryParameter(consignmentViewModel.model.toJSON(), options)
                            }
                        }
                    },
                    batch: true,
                    serverPaging: true,
                    pageSize: 10,
                    schema: {
                        data: 'rows',
                        total: 'total',
                        model: {
                            id: "tradeTraceId",
                            fields: {}
                        }
                    }
                });
                $("#loisticsInfoGrid").kendoGrid({
                    dataSource: dataSource2,
                    height: "400px",
                    resizable: true,
                    navigatable: true,
                    scrollable: true,
//                selectable: true,  设置表格行可选择
                    rownumber: true,
                    sortable: true,
//                selectable: 'multiple, rowbox',  设置表格行可多选
                    pageable: {
                        pageSizes: [5, 10, 20, 50],
                        refresh: true,
                        buttonCount: 5
                    },
                    columns: [
                        {
                            field: "operator",
                            title: '<@spring.message "hmall.operator"/>',
                            width: 120
                        }, {
                            field: "operatorphone",
                            title: '<@spring.message "hmall.operatorphone"/>',
                            width: 100
                        }, {
                            field: "operatetime",
                            title: '<@spring.message "hmall.operatetime"/>',
                            format: "{0:yyyy-MM-dd HH:mm:ss}",
                            width: 150
                        }, {
                            field: "content",
                            title: '<@spring.message "hmall.content"/>',
                            width: 200
                        }, {
                            field: "status",
                            title: '<@spring.message "hmall.status"/>',
                            width: 120,
                            template: function (dataItem) {
                                var v = dataItem.status;
                                $(tmsStatus).each(function (i, n) {
                                    if (n.value == v) {
                                        v = n.meaning;
                                    }
                                    return v;
                                });
                                return v;
                            }
                        }, {
                            field: "appointDate",
                            title: '<@spring.message "hmall.appointdate"/>',
                            format: "{0:yyyy-MM-dd HH:mm:ss}",
                            width: 150
                        }, {
                            field: "deliveryDate",
                            title: '<@spring.message "hmall.deliverydate"/>',
                            format: "{0:yyyy-MM-dd HH:mm:ss}",
                            width: 150
                        }, {
                            field: "signDate",
                            title: '<@spring.message "hmall.signdate"/>',
                            format: "{0:yyyy-MM-dd HH:mm:ss}",
                            width: 150
                        }, {
                            field: "changeAppointDate",
                            title: '<@spring.message "hmall.changeappointdate"/>',
                            format: "{0:yyyy-MM-dd HH:mm:ss}",
                            width: 150
                        }
                    ],
                    editable: false
                }).data("kendoGrid");
            }

            refreshLogisticsInfoGrid();


            <!--将rownumber中的#改成序号 -->
            $(function () {
                var rownumList = $('[data-index="0"]');
                for (var i = 0; i < rownumList.length; i++) {
                    var rownumText = $(rownumList[i]).html();
                    if ("#" == rownumText) {
                        $(rownumList[i]).html("序号");
                        $(rownumList[i]).eq(0).parent().parent().prev().children().eq(0).css("width", "50px");
                        $(rownumList[i]).eq(0).parent().parent().parent().parent().parent().next().children("table").children("colgroup").children().eq(0).css("width", "50px");
                    }
                }
            })

            function SplitSingle() {
                var requestFlag = true;
                if (viewModel.model.status == 'ABNORMAL') {
                    var checked = $('#Grid').data('kendoGrid').selectedDataItems();
                    if (checked == null || checked.length == 0) {
                        kendo.ui.showConfirmDialog({
                            title: $l('hap.tip.info'),
                            message: $l('请选择要拆分的订单行！')
                        });
                        return;
                    } else {
                        $(checked).each(function (i, n) {
                            if (n.parentLine != null) {
                                kendo.ui.showWarningDialog({
                                    message: "不可以勾选组件行"
                                })
                                requestFlag = false;
                                return requestFlag;
                            }
                        });
                    }
                    //是否发送请求
                    if (requestFlag) {
                        kendo.ui.showConfirmDialog({
                            title: $l('hap.tip.info'),
                            message: $l("<@spring.message 'hap.ok'/>?")
                        }).done(function (event) {
                            if (event.button == 'OK') {

                                console.log(checked);
                                $.ajax({
                                    type: 'POST',
                                    url: '${base.contextPath}/hmall/om/consignment/split',
                                    dataType: "json",
                                    contentType: "application/json",
                                    data: kendo.stringify(checked),
                                    success: function (data) {
                                        if (data.success == false) {
                                            kendo.ui.showErrorDialog({
                                                message: data.message
                                            });
                                        } else {
                                            var id = '';
                                            for (var i = 0; i < data.rows.length; i++) {
                                                id = id + "  " + data.rows[i].code;
                                            }
                                            kendo.ui.showConfirmDialog({
                                                title: $l('hap.tip.info'),
                                                message: $l('发货单' + viewModel.model.code + "拆单关闭，新的发货单为：" + id)
                                            }).done(function (event) {
                                                if (event.button == 'OK') {
                                                    location.reload();
                                                }
                                            })
                                        }
                                    }
                                });
                            }
                        })
                    }
                }

            }
            $(document).ready(function () {
                window.reasonWindow = function () {
                    var reasonWindow = $("#reasonWindow").kendoWindow({
                        title: '暂挂原因',
                        width: "450px",
                        height: "260px",
                        content: "${base.contextPath}/om/pause_reason.html",
                        actions: [
                            "Close"
                        ],
                        modal: true,
                        visible: false,
                        iframe: true,
                        close: function () {
                            //window 关闭  刷新 本页面的  Grid
                            //$('#Grid').data('kendoGrid').dataSource.page(1);
                        }
                    }).data("kendoWindow");
                    reasonWindow.center().open();

                }


            });
            function pauseReason() {
                reasonWindow();
            }
            //申请暂挂按钮
            function hold(pauseReason) {
                var data = {};
                data["consignmentId"] = consignmentId;
                data["pauseReason"] = pauseReason;
                $.ajax({
                    type: 'POST',
                    url: '${base.contextPath}/hmall/om/consignment/hold',
                    dataType: "json",
                    contentType: "application/json",
                    data: kendo.stringify(data),
                    success: function (data) {
                        if (data.success == false) {
                            kendo.ui.showErrorDialog({
                                message: data.message
                            });
                        } else {
                            kendo.ui.showInfoDialog({
                                title: $l('hap.tip.info'),
                                message: '申请暂挂成功！',
                            }).done(function () {
                                window.location.reload();
                            });
                        }
                    }
                });


            }
            //取消暂挂按钮
            function cancelHold() {

                kendo.ui.showConfirmDialog({
                    title: $l('hap.tip.info'),
                    message: $l("<@spring.message '确定要取消暂挂'/>?")
                }).done(function (event) {
                    if (event.button == 'OK') {
                        var data = {};
                        data["consignmentId"] = consignmentId;
                        $.ajax({
                            type: 'POST',
                            url: '${base.contextPath}/hmall/om/consignment/cancelHold',
                            dataType: "json",
                            contentType: "application/json",
                            data: kendo.stringify(data),
                            success: function (data) {
                                if (data.success == false) {
                                    kendo.ui.showErrorDialog({
                                        message: data.message
                                    });
                                } else {
                                    kendo.ui.showInfoDialog({
                                        title: $l('hap.tip.info'),
                                        message: data.message
                                    }).done(function () {
                                        window.location.reload();
                                    });
                                }
                            }
                        });
                    }
                });

            }
            function updateConsignmentStatus() {
                if (viewModel.model.csApproved == 'N' && (viewModel.model.status == 'ABNORMAL' || viewModel.model.status == 'PROCESS_ERROR')) {

                    kendo.ui.showConfirmDialog({
                        title: $l('hap.tip.info'),
                        message: $l("<@spring.message 'hap.ok'/>?")
                    }).done(function (event) {
                        if (event.button == 'OK') {
                            var gridData = [];
                            gridData.push({
                                consignmentId: consignmentId,
                            });
                            $.ajax({
                                type: 'POST',
                                url: '${base.contextPath}/hmall/om/consignment/check',
                                dataType: "json",
                                contentType: "application/json",
                                data: kendo.stringify(gridData),
                                success: function (data) {
                                    if (data.success == false) {
                                        kendo.ui.showErrorDialog({
                                            message: data.message
                                        });
                                    } else {
                                        kendo.ui.showConfirmDialog({
                                            title: $l('hap.tip.info'),
                                            message: $l('审核成功！')
                                        });
                                        location.reload();
                                    }
                                }
                            });
                        }
                    })
                } else {
                    kendo.ui.showInfoDialog({
                        message: "发货单不满足审核条件,查看发货单状态或是否已审核"
                    })
                }
            }

            $.ajax({
                url: BaseUrl + "/fnd/regions/getCountry",
                type: 'POST',
                contentType: 'application/json',
                success: function (data) {
                    data_country = data.rows;
                    $('#receiverCountry').data("kendoDropDownList").setDataSource(data_country);
                    $.each(data_country, function (i, n) {
                        if (n.regionCode == originalData.receiverCountry) {
                            $('#receiverCountry').data("kendoDropDownList").select(i);
                        }
                    })
                }
            });

            $.ajax({
                url: BaseUrl + "/fnd/regions/getState?countryCode=" + originalData.receiverCountry,
                type: 'POST',
                dataType: "json",
                contentType: 'application/json',
                success: function (data) {
                    data_state = data.rows;
                    $('#receiverState').data("kendoDropDownList").setDataSource(data_state);
                    $.each(data_state, function (i, n) {
                        if (n.regionCode == originalData.receiverState) {
                            $('#receiverState').data("kendoDropDownList").select(i);
                        }
                    })
                }
            });

            $.ajax({
                url: BaseUrl + "/fnd/regions/getCity?stateCode=" + originalData.receiverState,
                type: 'POST',
                dataType: "json",
                contentType: 'application/json',
                success: function (data) {
                    data_city = data.rows;
                    $('#receiverCity').data("kendoDropDownList").setDataSource(data_city);
                    $.each(data_city, function (i, n) {
                        if (n.regionCode == originalData.receiverCity) {
                            $('#receiverCity').data("kendoDropDownList").select(i);
                        }
                    })
                }
            });

            $.ajax({
                url: BaseUrl + "/fnd/regions/getArea?cityCode=" + originalData.receiverCity,
                type: 'POST',
                dataType: "json",
                contentType: 'application/json',
                success: function (data) {
                    data_area = data.rows;
                    $('#receiverDistrict').data("kendoDropDownList").setDataSource(data_area);
                    $.each(data_area, function (i, n) {
                        if (n.regionCode == originalData.receiverDistrict) {
                            $('#receiverDistrict').data("kendoDropDownList").select(i);
                        }
                    })
                }
            });

            function tradeFinish() {
                kendo.ui.showConfirmDialog({
                    title: $l('hap.tip.info'),
                    message: $l("<@spring.message '是否确认收货'/>?")
                }).done(function (event) {
                    if (event.button == 'OK') {
                        var data = {};
                        data["consignmentId"] = consignmentId;
                        $.ajax({
                            type: 'POST',
                            url: '${base.contextPath}/hmall/om/consignment/tradeFinish',
                            dataType: "json",
                            contentType: "application/json",
                            data: kendo.stringify(data),
                            success: function (data) {
                                console.log(data.success);
                                if (data.success == false) {
                                    kendo.ui.showErrorDialog({
                                        message: data.message
                                    });
                                } else {
                                    kendo.ui.showInfoDialog({
                                        title: $l('hap.tip.info'),
                                        message: "确认成功！"
                                    }).done(function () {
                                        window.location.reload();
                                    });
                                }
                            }
                        });
                    }
                });
            }
        </script>
        <div id="reasonWindow"></div>
        </body>
        </html>