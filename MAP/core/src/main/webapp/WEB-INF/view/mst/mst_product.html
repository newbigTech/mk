<!--
        * description: 商品列表查询页面
        * author:zhangmeng
        * 2017/5/26
        * version: 0.1
        *
        -->
<#include "../include/header.html"/>
<script src="${base.contextPath}/common/code?approvalStatusList=HMALL.PRODUCT.APPROVAL_STATUS" type="text/javascript"></script>
<script src="${base.contextPath}/common/code?hascustomData=HMALL.PRODUCT.HASCUSTOMSe" type="text/javascript"></script>
<script src="${base.contextPath}/common/code?isSinSaleList=SYS.YES_NO" type="text/javascript"></script>
<script src="${base.contextPath}/common/code?customSupportTypeData=HMALL.PRODUCT.CUSTOM_SUPPORT" type="text/javascript"></script>
<script src="${base.contextPath}/common/code?versionData=HMALL.CATALOGVERSION" type="text/javascript"></script>
<script src="http://cdnjs.cloudflare.com/ajax/libs/jszip/2.4.0/jszip.js"></script>
<script src="${base.contextPath}/resources/js/mask.js"></script>
<script type="text/javascript">
    var viewModel = kendo.observable({
        model: {},
        createFunction: function () {
            $('#Grid').data('kendoGrid').addRow();
        },
        saveFunction: function () {
            $('#Grid').data('kendoGrid').saveChanges();
        },
        queryFunction: function (e) {
            $('#Grid').data('kendoGrid').dataSource.page(1);
        },
        resetFunction: function (e) {
            var formData = viewModel.model.toJSON();
            for (var k in formData) {
                viewModel.model.set(k, null);
            }
        }
    });

    //版本目录数据
    var catalogData = new Array();
    $.ajax({
        url: '${base.contextPath}/hmall/mst/catalogversion/selectCatalog',
        type: 'POST',
        contentType: "application/json;charset=utf-8",
        cache: false,
        dataType: 'json',
        async: false,
        success: function (data) {
            catalogData = data.rows;
        }
    });

    var syncData = new Array();
    $.ajax({
        url: '${base.contextPath}/hmall/mst/syncconfig/lov',
        type: 'POST',
        contentType: "application/json;charset=utf-8",
        cache: false,
        dataType: 'json',
        async: false,
        success: function (data) {
            syncData = data.rows;
        }
    });

</script>
<body>

<div id="page_content" style="margin-top: 5px">
    <form class="form-horizontal" id="productForm" method="post" enctype="application/json;charset=UTF-8">
        <!--第一行按钮-->
        <div id="buttomGroup" class="row" style="margin-top:5px;margin-left:15px;">
            <#if accessService.access("HIDEPRODUCT")>
                <span onclick="sale(this)" id="onSale" class="btn btn-info" style="float:left;margin-right:5px;"><@spring.message "hmall.product.onSale"/></span>
                <span onclick="sale(this)" id="offSale" class="btn btn-info" style="float:left;margin-right:5px;"><@spring.message "hmall.product.offSale"/></span>
                <span onclick="autoSale(this)" id="autoOnSale" class="btn btn-info" style="float:left;margin-right:5px;"><@spring.message "hmall.product.autoOnSale"/></span>
                <span onclick="autoSale(this)" id="autoOffSale" class="btn btn-info" style="float:left;margin-right:5px;"><@spring.message "hmall.product.autoOffSale"/></span>
                <span onclick="importData()" class="btn btn-info" style="float:left;margin-right:5px;"><@spring.message "hmall.import"/></span>
                <span onclick="exportData()" class="btn btn-info" style="float:left;margin-right:5px;"><@spring.message "hmall.export"/></span>

                <span onclick="synchronous()" class="btn btn-info" style="float:left;margin-right:5px;"><@spring.message "hmall.synchronous"/></span>
                <span onclick="batchSync()" class="btn btn-info" style="float:left;margin-right:5px;"><@spring.message "全量同步"/></span>
                <span onclick="forceSync()" class="btn btn-info" style="float:left;margin-right:5px;"><@spring.message "强制同步"/></span>
            </#if>
        </div>
        <div id="buttomGroup2" class="row" style="margin-top:5px;margin-left:15px;">
            <#if accessService.access("HIDEPRODUCT")>
                <span onclick="importMedia()" class="btn btn-info" style="float:left;margin-right:5px;"><@spring.message "导入图片"/></span>
                <span onclick="fetchMedia()" class="btn btn-info" style="float:left;margin-right:5px;"><@spring.message "获取图片"/></span>
                <span onclick="importFabric()" class="btn btn-info" style="float:left;margin-right:5px;"><@spring.message "导入面料等级"/></span>
                <span onclick="exportInvInfo()" class="btn btn-info" style="float:left;margin-right:5px;"><@spring.message "库存导出"/></span>
            </#if>
        </div>
        <!--第3行-->
        <div class="row" style="margin-top:5px;">
            <div class="form-group col-sm-4">
                <label class="control-label col-sm-4" for="code"><@spring.message '同步路径' /></label>
                <div class="col-sm-8">
                    <input id="version" type="text" data-role="maskedtextbox" style="width: 100%;"  data-bind="value:model.version">
                </div>
                <script type="text/javascript">
                    $("#version").kendoDropDownList({
                        optionLabel: "<@spring.message '同步路径' />",
                        dataTextField: "versionName",
                        dataValueField: "syncconfigId",
                        valuePrimitive: true,
                        dataSource: syncData,
                    }).data("kendoDropDownList");
                </script>
            </div>
            <div class="form-group col-sm-4">
                <label class="control-label col-sm-4" for="approvalStatus"><@spring.message '上架状态' /></label>
                <div class="col-sm-8">
                    <input id="approvalStatus" name="approvalStatus"  style="width: 100%;" type="text" class="form-control full_width" data-bind="value:model.approvalStatus"/>
                </div>
                <script type="text/javascript">
                    $("#approvalStatus").kendoDropDownList({
                        optionLabel: "<@spring.message '上架状态' />",
                        dataTextField: "meaning",
                        dataValueField: "value",
                        valuePrimitive: true,
                        dataSource: approvalStatusList,
                    }).data("kendoDropDownList");
                </script>
            </div>
            <div class="form-group col-sm-4">
                <label class="control-label col-sm-4" for="hascustom"><@spring.message '是否可定制' /></label>
                <div class="col-sm-8">
                    <input id="hascustom" name="hascustom"  style="width: 100%;" type="text" class="form-control full_width" data-bind="value:model.hascustom"/>
                </div>
                <script type="text/javascript">
                    $("#hascustom").kendoDropDownList({
                        optionLabel: "",
                        dataTextField: "meaning",
                        dataValueField: "value",
                        valuePrimitive: true,
                        dataSource: hascustomData,
                    }).data("kendoDropDownList");
                </script>
            </div>
        </div>

        <div class="row" style="margin-top:0px;">
            <div class="form-group col-sm-4">
                <label class="control-label col-sm-4" for="code"><@spring.message 'hmall.product.code' /></label>
                <div class="col-sm-8">
                    <input id="code" name="code" type="text" class="form-control full_width" data-bind="value:model.code"/>
                </div>
            </div>


            <div class="form-group col-sm-4">
                <label class="control-label col-sm-4" for="name"><@spring.message'hmall.product.name'/></label>
                <div class="col-sm-8">
                    <input id="name" name="name" type="text" class="form-control full_width" data-bind="value:model.name"/>
                </div>
            </div>

            <div class="form-group col-sm-4">
                <label class="control-label col-sm-4" for="catalogversionId"><@spring.message 'hmall.product.catalogversion'/></label>
                <div class="col-sm-8">
                    <input id="catalogversionId" name="catalogversionId" required type="text" class="form-control full_width" data-bind="value:model.catalogversionId"/>
                </div>
                <script type="text/javascript">
                    $("#catalogversionId").kendoDropDownList({
                        optionLabel: "<@spring.message 'hmall.product.catalogversion' />",
                        dataTextField: "catalogName",
                        dataValueField: "catalogversionId",
                        valuePrimitive: true,
                        dataSource: catalogData,
                    }).data("kendoDropDownList");
                </script>
            </div>
        </div>

        <div class="row" style="margin-top:0px;">
            <div class="form-group col-sm-4">
                <label class="control-label col-sm-4" for="creationDateFrom"><@spring.message 'hmall.product.creationDateFrom' /></label>
                <div class="col-sm-8">
                    <input id="creationDateFrom" name="creationDateFrom" style="width: 100%;" type="text" data-role="datetimepicker" class="form-control full_width"
                           data-bind="value:model.creationDateFrom"/>
                </div>
            </div>


            <div class="form-group col-sm-4">
                <label class="control-label col-sm-4" for="creationDateTo"><@spring.message'hmall.product.creationDateTo'/></label>
                <div class="col-sm-8">
                    <input id="creationDateTo" name="creationDateTo" type="text" style="width: 100%;" data-role="datetimepicker" class="form-control" data-bind="value:model.creationDateTo"/>
                </div>
            </div>

            <div class="form-group col-sm-4">
                <label class="control-label col-sm-4" for="customSupportType"><@spring.message '定制支持类型'/></label>
                <div class="col-sm-8">
                    <input id="customSupportType" name="customSupportType" type="text" class="form-control full_width" data-bind="value:model.customSupportType"/>
                </div>
            </div>
            <script>
                $("#customSupportType").kendoDropDownList({
                    optionLabel: "<@spring.message '全部' />",
                    dataTextField: "meaning",
                    dataValueField: "value",
                    valuePrimitive: true,
                    dataSource: customSupportTypeData,
                }).data("kendoDropDownList");
            </script>
        </div>
        <div class="row" style="margin-top:0px;">
            <div class="col-sm-1" style="margin-left:15px;">
                <span class="btn btn-success" id="query" data-bind="click:queryFunction" type="submit"><i class="fa fa-search"></i> <@spring.message "hap.query"/></span>
            </div>
            <div class="col-sm-1">
                <span class="btn btn-primary" id="resetForm" data-bind="click:resetFunction" type="button"><i class="fa fa-refresh"></i> <@spring.message "hap.reset"/></span>
            </div>
        </div>
    </form>

</div>
<script>kendo.bind($('#page_content'), viewModel);</script>
<script type="text/javascript">

    //将rownumber中的#改成序号
    $(function () {
        var rownumList = $('[data-index="0"]');
        for (var i = 0; i < rownumList.length; i++) {
            var rownumText = $(rownumList[i]).html();
            if ("#" == rownumText) {
                $(rownumList[i]).html("序号");
                $(rownumList[i]).eq(0).parent().parent().prev().children().eq(0).css("width", "50px");
                $(rownumList[i]).eq(0).parent().parent().parent().parent().parent().next().children("table").children("colgroup").children().eq(0).css("width", "50px");
            }
        }
    });
</script>
<div id="open_window_Upload">
    <div class="panel" style="padding:0px;">
        <form class="form-horizontal">
            <div class="panel-body">
                <div class="row">
                    <input type="file" name="file" id="importExcelFile" accept="xls*">
                </div>
            </div>
            <div class="panel-body">
                <div class="row">
                    <span id="errorMessage"></span>
                </div>
            </div>
            <div class="panel-footer text-right">
                <a class="btn btn-success" id="download" onclick="downloadExcelModel()" type="submit">下载模板</a>
            </div>
        </form>
    </div>
</div>
<div id="open_window_Upload_image">
    <div class="panel" style="padding:0px;">
        <form class="form-horizontal">
            <div class="panel-body">
                <div class="row">
                    <input type="file" name="file" id="importMeidaExcelFile" accept="xls*">
                </div>
            </div>
            <div class="panel-body">
                <div class="row">
                    <span id="errorMeidaMessage"></span>
                </div>
            </div>
            <div class="panel-footer text-right">
                <a class="btn btn-success" id="downloadMedia" onclick="downloadMediaExcelModel()" type="submit">下载模板</a>
            </div>
        </form>
    </div>
</div>
<div id="open_window_Upload_fabric">
    <div class="panel" style="padding:0px;">
        <form class="form-horizontal">
            <div class="panel-body">
                <div class="row">
                    <input type="file" name="file" id="importFabricExcelFile" accept="xls*">
                </div>
            </div>
            <div class="panel-body">
                <div class="row">
                    <span id="errorFabricMessage"></span>
                </div>
            </div>
            <div class="panel-footer text-right">
                <a class="btn btn-success" id="downloadFabric" onclick="downloadFabricExcelModel()" type="submit">下载模板</a>
            </div>
        </form>
    </div>
</div>
<div style="clear:both;margin-top: 5px;height: 400px;">
    <div id="Grid"></div>
</div>
<div id="editWin"></div>
<form id="form_ExportExcle" action="${base.contextPath}/hmall/mst/product/exportData" method="GET">
    <input type="hidden" id="exportCode" name="code" value="">
    <input type="hidden" id="exportName" name="name" value="">
    <input type="hidden" id="exportCatalogversion" name="catalogversion" value="">
    <input type="hidden" id="startTime" name="startTime" value="">
    <input type="hidden" id="endTime" name="endTime" value="">
</form>
</div>

<script type="text/javascript">
    var BaseUrl = _basePath;

    function viewProductType(btnType) {
        var editWin = $("#editWin").kendoWindow({
            actions: ["Close"],
            title: "商品定制类型",
            content: '${base.contextPath}/mst/mst_product_odtype.html?btnType=' + btnType,
            iframe: true,
            visible: false,
            modal: true,
            height: '120px',
            width: '430px',
            close: function () {
                $("#editWin").empty();
            }
        }).data("kendoWindow");
        editWin.center().open();
    }

    //上下架数据选择校验
    function sale(btn) {
        var btnType = btn.id;
        console.log(btnType);
        var items = $('#Grid').data('kendoGrid').selectedDataItems();
        if (items.length <= 0) {
            kendo.ui.showInfoDialog({
                message: "<@spring.message 'hap.tip.selectrows'/>"
            })
        } else {
            viewProductType(btnType);
        }
    }

    //上架
    function onSale(odtype) {
        var items = $('#Grid').data('kendoGrid').selectedDataItems();
        $.ajax({
            type: 'POST',
            url: '${base.contextPath}/hmall/mst/product/upShelf?odtype=' + odtype,
            dataType: "json",
            contentType: "application/json",
            data: kendo.stringify(items),
            success: function (data) {
                if (data.success) {
                    kendo.ui.showInfoDialog({
                        message: data.message
                    }).done(function (event) {
                        if (event.button == 'OK') {
                            reflushGridData();
                        }
                    })
                } else {
                    kendo.ui.showErrorDialog({
                        message: data.message
                    });
                }
            }
        });
    }

    //下架
    function offSale(odtype) {
        var items = $('#Grid').data('kendoGrid').selectedDataItems();
        $.ajax({
            type: 'POST',
            url: '${base.contextPath}/hmall/mst/product/downShelf?odtype=' + odtype,
            dataType: "json",
            contentType: "application/json",
            data: kendo.stringify(items),
            success: function (data) {
                if (data.success == false) {
                    kendo.ui.showErrorDialog({
                        message: data.message
                    });
                } else {
                    kendo.ui.showInfoDialog({
                        message: data.message
                    })
                    reflushGridData();
                }
            }
        });
    }

    //自动上下架逻辑校验
    function autoSale(btn) {
        var btnType = btn.id;
        viewProductType(btnType);
    }
    //自动上架
    function autoOnSale(odtype) {
        $.ajax({
            type: 'POST',
            url: '${base.contextPath}/hmall/mst/product/autoUpShelf?odtype=' + odtype,
            dataType: "json",
            contentType: "application/json",
            data: kendo.stringify([viewModel.model.toJSON()]),
            success: function (data) {
                console.log("data", data);
                if (data.success == false) {
                    kendo.ui.showErrorDialog({
                        message: data.message
                    });
                } else {
                    kendo.ui.showInfoDialog({
                        message: data.message
                    }).done(function (event) {
                        if (event.button == 'OK') {
                            reflushGridData();
                        }
                    })
                }
            }
        });
    }
    //自动下架
    function autoOffSale(odtype) {
        $.ajax({
            type: 'POST',
            url: '${base.contextPath}/hmall/mst/product/autoDownShelf?odtype=' + odtype,
            dataType: "json",
            contentType: "application/json",
            data: kendo.stringify([viewModel.model.toJSON()]),
            success: function (data) {
                console.log("data", data);
                if (data.success == false) {
                    kendo.ui.showErrorDialog({
                        message: data.message
                    });
                } else {
                    kendo.ui.showInfoDialog({
                        message: data.message
                    }).done(function (event) {
                        if (event.button == 'OK') {
                            reflushGridData();
                        }
                    })
                }
            }
        });
    }

    function reflushGridData() {
        var pageNo = $('#Grid').data('kendoGrid').dataSource._page;
        $('#Grid').data('kendoGrid').dataSource.page(pageNo);
    }

    //同步
    function synchronous() {
        var items = $('#Grid').data('kendoGrid').selectedDataItems();
       console.log("同步数据",items);
        if (items.length <= 0) {
            kendo.ui.showInfoDialog({
                message: "<@spring.message 'hap.tip.selectrows'/>"
            })
        } else if (viewModel.model.version == null) {
            kendo.ui.showInfoDialog({
                message: "<@spring.message '请选择要同步的目录版本！'/>"
            })
        } else {
            var catalogVersionFrom = null;
            var catalogTo = null;
            var versionTo = null;
            for (var i = 0; i < syncData.length; i++) {
                if (syncData[i].syncconfigId == viewModel.model.version) {
                    catalogVersionFrom = syncData[i].versionNameFrom;
                    catalogTo = syncData[i].catalogto;
                    versionTo = syncData[i].versionto;
                }
            }
            for (var i = 0; i < items.length; i++) {
                if (items[i].catalogversion != catalogVersionFrom) {
                    kendo.ui.showInfoDialog({
                        message: "<@spring.message '所选数据中目录版本与同步的目录版本不一致！'/>"
                    })
                    return;
                }
            }
            ;

            var list = [];

            list.push({
                /*同步的数据*/
                list: items,
                catalogTo: catalogTo,
                versionTo: versionTo
            });
            $.ajax({
                type: 'POST',
                url: '${base.contextPath}/hmall/mst/product/sync',
                dataType: "json",
                contentType: "application/json",
                data: kendo.stringify(list),
                success: function (data) {
                    if (data.success == false) {
                        kendo.ui.showErrorDialog({
                            message: data.message
                        });
                        return;
                    } else {
                        kendo.ui.showInfoDialog({
                            message: "<@spring.message '成功!'/>"
                        })
                        $('#Grid').data('kendoGrid').dataSource.page(1);
                    }
                }
            });
        }
    }

    //批量同步
    function batchSync() {
        if (viewModel.model.version == null || viewModel.model.version == '' || viewModel.model.version == undefined) {
            kendo.ui.showInfoDialog({
                message: "<@spring.message '请选择要同步的目录版本！'/>"
            })
        } else {
            var catalogVersionFrom = null;
            var catalogTo = null;
            var versionTo = null;
            var catalogFrom = null;
            var versionFrom = null;
            for (var i = 0; i < syncData.length; i++) {
                if (syncData[i].syncconfigId == viewModel.model.version) {
                    catalogVersionFrom = syncData[i].versionNameFrom;
                    catalogTo = syncData[i].catalogto;
                    versionTo = syncData[i].versionto;
                    catalogFrom = syncData[i].catalogfrom;
                    versionFrom = syncData[i].versionfrom;
                }
            }
            var list = [];
            list.push({
                catalogTo: catalogTo,
                versionTo: versionTo,
                catalogFrom: catalogFrom,
                versionFrom: versionFrom
            });
            startMask("全量同步中...", "");
            $.ajax({
                type: 'POST',
                url: '${base.contextPath}/hmall/mst/product/batchSync',
                dataType: "json",
                contentType: "application/json",
                data: kendo.stringify(list),
                success: function (data) {
                    endMask();
                    if (data.success == false) {
                        kendo.ui.showErrorDialog({
                            message: data.message
                        });
                        return;
                    } else {
                        kendo.ui.showInfoDialog({
                            message: "<@spring.message '成功!'/>"
                        })
                        $('#Grid').data('kendoGrid').dataSource.page(1);
                    }
                }
            });
        }
    }

    //强制同步
    function forceSync() {
        var items = $('#Grid').data('kendoGrid').selectedDataItems();

        if (items.length <= 0) {
            kendo.ui.showInfoDialog({
                message: "<@spring.message 'hap.tip.selectrows'/>"
            })
        } else if (viewModel.model.version == null) {
            kendo.ui.showInfoDialog({
                message: "<@spring.message '请选择要同步的目录版本！'/>"
            })
        } else {
            var catalogVersionFrom = null;
            var catalogTo = null;
            var versionTo = null;
            for (var i = 0; i < syncData.length; i++) {
                if (syncData[i].syncconfigId == viewModel.model.version) {
                    catalogVersionFrom = syncData[i].versionNameFrom;
                    catalogTo = syncData[i].catalogto;
                    versionTo = syncData[i].versionto;
                }
            }
            for (var i = 0; i < items.length; i++) {
                if (items[i].catalogversion != catalogVersionFrom) {
                    kendo.ui.showInfoDialog({
                        message: "<@spring.message '所选数据中目录版本与同步的目录版本不一致！'/>"
                    })
                    return;
                }
            }
            ;

            var list = [];
            list.push({
                list: items,
                catalogTo: catalogTo,
                versionTo: versionTo
            });
            $.ajax({
                type: 'POST',
                url: '${base.contextPath}/hmall/mst/product/forceSync',
                dataType: "json",
                contentType: "application/json",
                data: kendo.stringify(list),
                success: function (data) {
                    if (data.success == false) {
                        kendo.ui.showErrorDialog({
                            message: data.message
                        });
                        return;
                    } else {
                        kendo.ui.showInfoDialog({
                            message: "<@spring.message '成功!'/>"
                        })
                        $('#Grid').data('kendoGrid').dataSource.page(1);
                    }
                }
            });
        }
    }


    //图片获取按钮
    function fetchMedia() {
        kendo.ui.showConfirmDialog({
            title: $l('hap.tip.info'),
            message: '确定要获取满足条件的全部商品图片吗？'
        }).done(function (event) {
            if (event.button == 'OK') {
                var productData = null;
                //获取满足获取图片条件的商品数据
                $.ajax({
                    type: "POST",
                    url: BaseUrl + "/hmall/mst/product/selectProductForFetchMedia",
                    contentType: "application/json",
                    dataType: "json",
                    async: false,
                    success: function (data) {
                        if (data.success == true) {
                            productData = data.rows;
                        } else {
                            kendo.ui.showErrorDialog({
                                message: data.message
                            });
                        }
                    }
                });
                if (productData == null || productData.length == 0) {
                    kendo.ui.showErrorDialog({
                        message: '没有需要获取图片的商品！'
                    });
                    return;
                }
                //获取图片
                $.ajax({
                    type: "POST",
                    url: BaseUrl + "/hmall/mst/media/createMediaForProduct",
                    contentType: "application/json",
                    data: kendo.stringify(productData),
                    dataType: "json",
                    success: function (data) {
                        if (data.success == true) {
                            kendo.ui.showInfoDialog({
                                message: "<@spring.message '获取图片成功!'/>"
                            })
                        } else {
                            kendo.ui.showErrorDialog({
                                message: data.message
                            });
                        }
                    }
                });
            }
        });
    }

    //导出列表excel
    function exportData() {
        var grid = $("#Grid").data("kendoGrid");
        var items = grid.selectedDataItems();
        if (items.length == 0) {/*
         //商品编码
         if($('#code').val()!=""){
         $('#exportCode').val($('#code').val());
         }
         //商品名称
         if($('#name').val()!=""){
         $('#exportName').val($('#name').val());
         }
         //目录版本
         if($('#catalogversion').val()!=""){
         $('#exportCatalogversion').val($('#catalogversion').val());
         }
         //开始时间
         var exportStartTime = $("#creationDateFrom").data("kendoDateTimePicker");
         $('#startTime').val(exportStartTime.value());
         //结束时间
         //结束时间
         var exportEndTime = $("#creationDateTo").data("kendoDateTimePicker");
         $('#exportEndTime').val(exportEndTime.value());
         $("#form_ExportExcle").submit();*/
            kendo.ui.showInfoDialog({
                message: "请选择列表数据导出。"
            })
        } else {//导出已选中数据
            var rows = [{
                cells: [
                    // First cell
                    {value: "商品编码"},
                    // Second cell
                    {value: "商品名称"},
                    // Third cell
                    {value: "目录版本"},
                    // Fourth cell
                    {value: "上架状态"},
                    // Five cell
                    {value: "销售状态"},

                    {value: "是否单独可售"},

                    {value: "创建日期"}

                ]
            }];
            var approvalStatus = [];
            var saleStatus = [];
            var isSinSale = [];
            for (var i = 0; i < items.length; i++) {
                //上下架状态
                $.each(approvalStatusList, function (j, n) {
                    if (n.value == items[i].approvalStatus) {
                        approvalStatus[i] = n.meaning;
                    } else {
                        approvalStatus[i] = "";
                    }
                })
                //是否单独可售
                $.each(isSinSaleList, function (j, n) {
                    if (n.value == items[i].isSinSale) {
                        isSinSale[i] = n.meaning;
                    } else {
                        isSinSale[i] = "";
                    }
                });
                //销售状态
                if (items[i].saleStatus == 'A1') {
                    saleStatus[i] = "商品可过量销售";
                } else if (items[i].saleStatus == 'A2') {
                    saleStatus[i] = "不可过量销售";
                } else if (items[i].saleStatus == 'A3') {
                    saleStatus[i] = "不可销售";
                } else {
                    saleStatus[i] = " ";
                }
            }
            for (var i = 0; i < items.length; i++) {
                //push single row for every record
                rows.push({
                    cells: [
                        {value: items[i].code},
                        {value: items[i].name},
                        {value: items[i].catalogversion},
                        {value: approvalStatus[i]},
                        {value: saleStatus[i]},
                        {value: isSinSale[i]},
                        {value: items[i].creationDate}
                    ]
                })
            }
            var workbook = new kendo.ooxml.Workbook({
                sheets: [
                    {
                        columns: [
                            // Column settings (width)
                            {width: 100},
                            {width: 100},
                            {width: 100},
                            {width: 100},
                            {width: 100},
                            {width: 100},
                            {width: 150}
                        ],
                        // Title of the sheet
                        title: "商品列表",
                        // Rows of the sheet
                        rows: rows
                    }
                ]
            });
            //save the file as Excel file with extension xlsx
            kendo.saveAs({dataURI: workbook.toDataURL(), fileName: "商品列表.xlsx"});
        }
    }
    //导入
    //导入的弹框
    var open_window_Upload = $("#open_window_Upload");
    open_window_Upload.kendoWindow({
        position: {
            top: "20%",
            left: "30%"
        },
        width: "400px",
        title: "导入",

        actions: [
            "Minimize",
            "Maximize",
            "Close"
        ],
        visible: false          //设置窗口不可见
    });

    //点击导入按钮弹出导入div
    function importData() {
        open_window_Upload.data("kendoWindow").open();
    }

    //下载商品列表excel模板
    function downloadExcelModel() {
        var form = $("<form>");   //定义一个form表单
        form.attr('style', 'display:none');   //在form表单中添加查询参数
        form.attr('target', '');
        form.attr('method', 'GET');
        form.attr('action', BaseUrl + "/hmall/mst/product/downloadExcelModel");
        $('body').append(form);  //将表单放置在web中
        form.submit();
    }

    //上传商品列表excel
    $('#importExcelFile').kendoUpload({
        async: {
            saveUrl: BaseUrl + "/hmall/mst/product/importExcel?${_csrf.parameterName}=${_csrf.token}",
            autoUpload: false
        },
        multiple: false,
        localization: {
            select: "请选择文件",
            remove: "取消"

        },
        error: function (e) {
            kendo.ui.showInfoDialog({
                title: '提示信息',
                message: 'excel导入失败!'
            });
        },
        success: function (e) {
            if (e.response.success) {
                kendo.ui.showInfoDialog({
                    title: '提示信息',
                    message: 'excel导入成功'
                }).done(function (event) {
                    if (event.button == 'OK') {
                        var upload = $("#importExcelFile").data("kendoUpload");
                        upload.destroy();
                        $("#open_window_Upload").data("kendoWindow").close();
                        $('#Grid').data('kendoGrid').dataSource.page(1);

                    }
                })
            } else {
                kendo.ui.showErrorDialog({
                    title: '提示信息',
                    message: '导入失败!<br/>'
                }).done(function (event) {
                    $("#errorMessage").html('<h5>失败信息:</h5><br/>' + e.response.message)
                });
            }
        }
    });

    //导入图片的弹框
    var open_window_Upload_image = $("#open_window_Upload_image");
    open_window_Upload_image.kendoWindow({
        position: {
            top: "20%",
            left: "30%"
        },
        width: "400px",
        title: "导入",

        actions: [
            "Minimize",
            "Maximize",
            "Close"
        ],
        visible: false          //设置窗口不可见
    });

    //点击导入图片按钮弹出导入div
    function importMedia() {
        open_window_Upload_image.data("kendoWindow").open();
    }

    //下载图片列表excel模板
    function downloadMediaExcelModel() {
        var form = $("<form>");   //定义一个form表单
        form.attr('style', 'display:none');   //在form表单中添加查询参数
        form.attr('target', '');
        form.attr('method', 'GET');
        form.attr('action', BaseUrl + "/hmall/mst/media/downloadExcelModel");
        $('body').append(form);  //将表单放置在web中
        form.submit();
    }

    //上传图片列表excel
    $('#importMeidaExcelFile').kendoUpload({
        async: {
            saveUrl: BaseUrl + "/hmall/mst/media/importExcel?${_csrf.parameterName}=${_csrf.token}",
            autoUpload: false
        },
        multiple: false,
        localization: {
            select: "请选择文件",
            remove: "取消"

        },
        error: function (e) {
            kendo.ui.showInfoDialog({
                title: '提示信息',
                message: 'excel导入失败!'
            });
        },
        success: function (e) {
            if (e.response.success) {
                kendo.ui.showInfoDialog({
                    title: '提示信息',
                    message: 'excel导入成功'
                }).done(function (event) {
                    if (event.button == 'OK') {
                        var upload = $("#importMeidaExcelFile").data("kendoUpload");
                        upload.destroy();
                        $("#open_window_Upload_image").data("kendoWindow").close();
                        $('#Grid').data('kendoGrid').dataSource.page(1);
                    }
                })
            } else {
                kendo.ui.showErrorDialog({
                    title: '提示信息',
                    message: '导入失败!<br/>'
                }).done(function (event) {
                    $("#errorMeidaMessage").html('<h5>失败信息:</h5><br/>' + e.response.message)
                });
            }
        }
    });

    //导入图片的弹框
    var open_window_Upload_image = $("#open_window_Upload_image");
    open_window_Upload_image.kendoWindow({
        position: {
            top: "20%",
            left: "30%"
        },
        width: "400px",
        title: "导入",

        actions: [
            "Minimize",
            "Maximize",
            "Close"
        ],
        visible: false          //设置窗口不可见
    });

    //点击导入图片按钮弹出导入div
    function importMedia() {
        open_window_Upload_image.data("kendoWindow").open();
    }

    //下载图片列表excel模板
    function downloadMediaExcelModel() {
        var form = $("<form>");   //定义一个form表单
        form.attr('style', 'display:none');   //在form表单中添加查询参数
        form.attr('target', '');
        form.attr('method', 'GET');
        form.attr('action', BaseUrl + "/hmall/mst/media/downloadExcelModel");
        $('body').append(form);  //将表单放置在web中
        form.submit();
    }

    //上传图片列表excel
    $('#importMeidaExcelFile').kendoUpload({
        async: {
            saveUrl: BaseUrl + "/hmall/mst/media/importExcel?${_csrf.parameterName}=${_csrf.token}",
            autoUpload: false
        },
        multiple: false,
        localization: {
            select: "请选择文件",
            remove: "取消"

        },
        error: function (e) {
            kendo.ui.showInfoDialog({
                title: '提示信息',
                message: 'excel导入失败!'
            });
        },
        success: function (e) {
            if (e.response.success) {
                kendo.ui.showInfoDialog({
                    title: '提示信息',
                    message: 'excel导入成功'
                }).done(function (event) {
                    if (event.button == 'OK') {
                        var upload = $("#importMeidaExcelFile").data("kendoUpload");
                        upload.destroy();
                        $("#open_window_Upload_image").data("kendoWindow").close();
                        $('#Grid').data('kendoGrid').dataSource.page(1);
                    }
                })
            } else {
                kendo.ui.showErrorDialog({
                    title: '提示信息',
                    message: '导入失败!<br/>'
                }).done(function (event) {
                    $("#errorMeidaMessage").html('<h5>失败信息:</h5><br/>' + e.response.message)
                });
            }
        }
    });


    //导入面料等级的弹框
    var open_window_Upload_fabric = $("#open_window_Upload_fabric");
    open_window_Upload_fabric.kendoWindow({
        position: {
            top: "20%",
            left: "30%"
        },
        width: "400px",
        title: "导入",

        actions: [
            "Minimize",
            "Maximize",
            "Close"
        ],
        visible: false          //设置窗口不可见
    });

    //点击导入面料等级按钮弹出导入div
    function importFabric() {
        open_window_Upload_fabric.data("kendoWindow").open();
    }

    //下载面料等级列表excel模板
    function downloadFabricExcelModel() {
        var form = $("<form>");   //定义一个form表单
        form.attr('style', 'display:none');   //在form表单中添加查询参数
        form.attr('target', '');
        form.attr('method', 'GET');
        form.attr('action', BaseUrl + "/hmall/mst/fabric/downloadExcelModel");
        $('body').append(form);  //将表单放置在web中
        form.submit();
    }

    //上传面料等级列表excel
    $('#importFabricExcelFile').kendoUpload({
        async: {
            saveUrl: BaseUrl + "/hmall/mst/fabric/importExcel?${_csrf.parameterName}=${_csrf.token}",
            autoUpload: false
        },
        multiple: false,
        localization: {
            select: "请选择文件",
            remove: "取消"

        },
        error: function (e) {
            kendo.ui.showInfoDialog({
                title: '提示信息',
                message: 'excel导入失败!'
            });
        },
        success: function (e) {
            if (e.response.success) {
                kendo.ui.showInfoDialog({
                    title: '提示信息',
                    message: 'excel导入成功'
                }).done(function (event) {
                    if (event.button == 'OK') {
                        var upload = $("#importFabricExcelFile").data("kendoUpload");
                        upload.destroy();
                        $("#open_window_Upload_fabric").data("kendoWindow").close();
                        $('#Grid').data('kendoGrid').dataSource.page(1);
                    }
                })
            } else {
                kendo.ui.showErrorDialog({
                    title: '提示信息',
                    message: '导入失败!<br/>'
                }).done(function (event) {
                    $("#errorFabricMessage").html('<h5>失败信息:</h5><br/>' + e.response.message)
                });
            }
        }
    });

    dataSource = new kendo.data.DataSource({
        transport: {
            read: {
                url: BaseUrl + "/hmall/mst/product/selectProductList",
                type: "POST",
                dataType: "json"
            },
            update: {
                url: BaseUrl + "/hmall/mst/product/submit",
                type: "POST",
                contentType: "application/json"
            },
            destroy: {
                url: BaseUrl + "/hmall/mst/product/remove",
                type: "POST",
                contentType: "application/json"
            },
            create: {
                url: BaseUrl + "/hmall/mst/product/submit",
                type: "POST",
                contentType: "application/json"
            },
            parameterMap: function (options, type) {
                if (type !== "read" && options.models) {
                    var datas = Hap.prepareSubmitParameter(options, type)
                    return kendo.stringify(datas);
                } else if (type === "read") {
                    return Hap.prepareQueryParameter(viewModel.model.toJSON(), options)
                }
            }
        },
        batch: true,
        serverPaging: true,
        pageSize: 10,
        schema: {
            data: 'rows',
            total: 'total',
            model: {
                id: "productId",
                fields: {}
            }
        }
    });

    var grid = $("#Grid").kendoGrid({
        dataSource: dataSource,
        height: '400px',
        resizable: true,
        scrollable: true,
        navigatable: false,
        rownumber: true,
        selectable: 'multiple, rowbox',
        pageable: {
            pageSizes: [5, 10, 20, 50],
            refresh: true,
            buttonCount: 5
        },
        columns: [
         /*   {
                field: "hascustom",
                title: '同步',
                width: 120,
            },*/
            {
                field: "imageUrl",
                title: '<@spring.message "hmall.product.imageUrlId"/>',
                width: 120,
                template: function (dataItem) {
                    var url = dataItem['imageUrl'];
                    if (url != null && url != "") {
                        var imageData = null;
                        $.ajax({
                            url: '${base.contextPath}/hmall/mst/media/getImageIoStream?path=' + url,
                            type: 'POST',
                            contentType: "application/json;charset=utf-8",
                            cache: false,
                            dataType: 'json',
                            async: false,
                            success: function (data) {
                                if (data.success == true) {
                                    imageData = data.rows[0];
                                }
                            }
                        });
                        if (imageData != null) {
                            return "<img src='" + imageData + "' width='60' height='60'/>";
                        } else {
                            return "";
                        }
                    } else {
                        return "";
                    }
                },
                attributes: {style: "text-align:center"},
                headerAttributes: {
                    "class": "table-header-cell",
                    style: "text-align: center"
                }
            },
            {
                field: "code",
                title: '<@spring.message "hmall.product.code"/>',
                width: 120,
                template: function (dataItem) {
                    if (dataItem.code != null && dataItem.code != '') {
                        return '<a style="margin-right:10px;" href="javascript:void(0);" onclick="viewProductFunction(\'' + dataItem.productId + '\',\'' + dataItem.code + '\')">' + dataItem.code + '</a>'
                    }
                }, attributes: {style: "text-align:center"},
                headerAttributes: {
                    "class": "table-header-cell",
                    style: "text-align: center"
                }
            },
            {
                field: "name",
                title: '<@spring.message "hmall.product.name"/>',
                width: 120,
                attributes: {style: "text-align:center"},
                headerAttributes: {
                    "class": "table-header-cell",
                    style: "text-align: center"
                }
            }, {
                field: "catalogversion",
                title: '<@spring.message "hmall.product.catalogversion"/>',
                width: 120,
                attributes: {style: "text-align:center"},
                headerAttributes: {
                    "class": "table-header-cell",
                    style: "text-align: center"
                }
            }, {
                field: "approvalStatus",
                title: '<@spring.message "hmall.product.approvalStatus"/>',
                width: 120,
                attributes: {style: "text-align:center"},
                headerAttributes: {
                    "class": "table-header-cell",
                    style: "text-align: center"
                },
                template: function (dataItem) {
                    var v1 = dataItem.approvalStatus;
                    var v2 = dataItem.normalApproveStatus;
                    var v3 = dataItem.superApproveStatus;
                    var result = '';

                    if (v1 != null) {
                        $.each(approvalStatusList, function (i, n) {
                            if (n.value == v1) {
                                v1 = n.meaning;
                            }
                        });
                        result = result + "主商品:" + v1 + "<br/>";
                    }
                    if (v2 != null) {
                        $.each(approvalStatusList, function (i, n) {
                            if (n.value == v2) {
                                v2 = n.meaning;
                            }
                        });
                        result = result + "普通定制:" + v2 + "<br/>";
                    }
                    if (v3 != null) {
                        $.each(approvalStatusList, function (i, n) {
                            if (n.value == v3) {
                                v3 = n.meaning;
                            }
                        });
                        result = result + "超级定制:" + v3 + "<br/>";
                    }
                    if (result == '') {
                        return '';
                    } else {
                        return result;
                    }
                }
            }, {
                field: "customSupportType",
                title: '<@spring.message "定制支持类型"/>',
                width: 100,
                attributes: {style: "text-align:center"},
                headerAttributes: {
                    "class": "table-header-cell",
                    style: "text-align: center"
                },
                template: function (dataItem) {
                    var v = dataItem.customSupportType;
                    if (v == null) {
                        return '';
                    }
                    $.each(customSupportTypeData, function (i, n) {
                        if (n.value == v) {
                            v = n.meaning;
                            return v;
                        } else {
                            return '';
                        }
                    });
                    return v;
                }
            }, {
                field: "isSinSale",
                title: '<@spring.message "hmall.product.isAlone"/>',
                width: 90,
                template: function (dataItem) {
                    var v = dataItem.isSinSale;
                    if (v == null) {
                        return '';
                    }
                    $.each(isSinSaleList, function (i, n) {
                        if (n.value == v) {
                            v = n.meaning;
                            return v;
                        } else {
                            return '';
                        }
                    })
                    return v;
                },
                attributes: {style: "text-align:center"},
                headerAttributes: {
                    "class": "table-header-cell",
                    style: "text-align: center"
                }
            }, {
                field: "creationDate",
                title: '<@spring.message "hmall.product.creationDate"/>',
                width: 120,
                attributes: {style: "text-align:center"},
                headerAttributes: {
                    "class": "table-header-cell",
                    style: "text-align: center"
                }
            },
        ],
        editable: false
    });

    grid.on('dblclick', '.k-grid-content tr', function (event) {
        var data = $('#Grid').data("kendoGrid").dataItem($(event.target).closest("tr"));
        var productId = data.productId;
        var code = data.code;
        viewProductFunction(productId, code);
    });

    function viewProductFunction(productId, code) {
        window.top.openTab("product_" + productId, code, "${base.contextPath}/mst/mst_product_view.html?productId=" + productId + "&code=" + code);
    }

    Hap.autoResizeGrid("#Grid");

    //库存导出
    function exportInvInfo() {
        var form = $("<form>");   //定义一个form表单
        form.attr('style', 'display:none');   //在form表单中添加查询参数
        form.attr('target', '');
        form.attr('method', 'GET');
        form.attr('action', BaseUrl + "/hmall/mst/product/exportInvInfo");
        $('body').append(form);  //将表单放置在web中
        form.submit();
    }

</script>
</body>
</html>